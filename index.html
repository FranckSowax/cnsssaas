<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGFI WhatsApp Marketing SaaS</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bgfi: { primary: '#1e3a5f', secondary: '#2d5a87', accent: '#00a86b', light: '#f8fafc', dark: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator span { animation: typing 1.4s infinite; display: inline-block; width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // =============================================
        // API Layer
        // =============================================
        const API_BASE = '/api';

        const authStore = {
            getToken: () => localStorage.getItem('bgfi_token'),
            setToken: (t) => localStorage.setItem('bgfi_token', t),
            getUser: () => { try { return JSON.parse(localStorage.getItem('bgfi_user')); } catch(e) { return null; } },
            setUser: (u) => localStorage.setItem('bgfi_user', JSON.stringify(u)),
            clear: () => { localStorage.removeItem('bgfi_token'); localStorage.removeItem('bgfi_user'); },
        };

        const api = async (endpoint, options = {}) => {
            const token = authStore.getToken();
            const headers = { ...options.headers };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
            const res = await fetch(API_BASE + endpoint, { ...options, headers });
            if (res.status === 401) { authStore.clear(); window.location.reload(); return; }
            const contentType = res.headers.get('content-type');
            if (contentType && contentType.includes('text/csv')) return res.blob();
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || data.message || 'Erreur ' + res.status);
            return data;
        };

        const useApi = (endpoint, autoFetch = true) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(autoFetch);
            const [error, setError] = useState(null);
            const fetchData = useCallback(async () => {
                setLoading(true); setError(null);
                try { const result = await api(endpoint); setData(result); }
                catch (err) { setError(err.message); }
                finally { setLoading(false); }
            }, [endpoint]);
            useEffect(() => { if (autoFetch) fetchData(); }, [fetchData, autoFetch]);
            return { data, loading, error, refetch: fetchData };
        };

        const formatNum = (n) => {
            if (!n && n !== 0) return '0';
            if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n/1000).toFixed(1) + 'K';
            return n.toLocaleString('fr-FR');
        };

        const statusMap = { DRAFT: 'Brouillon', SCHEDULED: 'Planifiee', RUNNING: 'En cours', COMPLETED: 'Terminee', CANCELLED: 'Annulee', SENT: 'Envoye' };
        const statusVariant = { DRAFT: 'default', SCHEDULED: 'warning', RUNNING: 'info', COMPLETED: 'success', CANCELLED: 'danger' };
        const categoryMap = { ALL: 'Tous', ACTIVE: 'Actif', INACTIVE: 'Inactif', VIP: 'VIP', NEW: 'Nouveau', PREMIUM: 'Premium' };
        const categoryVariant = { ALL: 'default', ACTIVE: 'success', INACTIVE: 'warning', VIP: 'primary', NEW: 'info', PREMIUM: 'primary' };
        const accountTypeMap = { EPARGNE: 'Epargne', COURANT: 'Courant', PROFESSIONNEL: 'Professionnel', JEUNE: 'Jeune' };
        const catMap = { MARKETING: 'Marketing', UTILITY: 'Utilitaire', AUTHENTICATION: 'Authentification', REACTIVATION: 'Reactivation', NOTIFICATION: 'Notification' };
        const tplStatusMap = { PENDING: 'En attente', APPROVED: 'Approuve', REJECTED: 'Rejete' };
        const tplStatusVariant = { PENDING: 'warning', APPROVED: 'success', REJECTED: 'danger' };

        // =============================================
        // Icons
        // =============================================
        const Icons = {
            LayoutDashboard: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>,
            MessageSquare: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Users: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            FileText: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>,
            BarChart3: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Search: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
            Filter: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"/></svg>,
            MoreVertical: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Bot: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>,
            Trash2: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Edit: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5,3 19,12 5,21 5,3"/></svg>,
            CheckCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>,
            Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>,
            TrendingUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>,
            Eye: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            MousePointer: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Database: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>,
            Sparkles: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Menu: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Phone: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Mail: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
            Calendar: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            RefreshCw: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Copy: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            LogOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>,
            Layers: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12,2 2,7 12,12 22,7"/><polyline points="2,17 12,22 22,17"/><polyline points="2,12 12,17 22,12"/></svg>,
            MapPin: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            ChevronRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9,18 15,12 9,6"/></svg>,
            ChevronLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15,18 9,12 15,6"/></svg>,
            Target: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        };

        // =============================================
        // UI Components
        // =============================================
        const Button = ({ children, onClick, variant = 'primary', size = 'md', className = '', disabled = false, icon: Icon, type = 'button' }) => {
            const baseClasses = 'inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed';
            const variants = { primary: 'bg-bgfi-primary text-white hover:bg-bgfi-secondary shadow-md hover:shadow-lg', secondary: 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm', accent: 'bg-bgfi-accent text-white hover:bg-emerald-600 shadow-md hover:shadow-lg', danger: 'bg-red-500 text-white hover:bg-red-600 shadow-md', ghost: 'text-gray-600 hover:bg-gray-100 hover:text-gray-900' };
            const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2 text-sm', lg: 'px-6 py-3 text-base' };
            return <button type={type} onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`}>{Icon && <Icon />}{children}</button>;
        };

        const Card = ({ children, className = '', title, action }) => (
            <div className={`bg-white rounded-xl card-shadow hover-lift ${className}`}>
                {(title || action) && <div className="flex items-center justify-between px-6 py-4 border-b border-gray-100">{title && <h3 className="text-lg font-semibold text-gray-900">{title}</h3>}{action && <div>{action}</div>}</div>}
                <div className="p-6">{children}</div>
            </div>
        );

        const Badge = ({ children, variant = 'default' }) => {
            const variants = { default: 'bg-gray-100 text-gray-700', success: 'bg-emerald-100 text-emerald-700', warning: 'bg-amber-100 text-amber-700', danger: 'bg-red-100 text-red-700', info: 'bg-blue-100 text-blue-700', primary: 'bg-bgfi-primary text-white' };
            return <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${variants[variant]}`}>{children}</span>;
        };

        const Input = ({ label, type = 'text', placeholder, value, onChange, className = '', icon: Icon }) => (
            <div className={`space-y-1 ${className}`}>
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <div className="relative">{Icon && <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon /></div>}<input type={type} value={value} onChange={(e) => onChange && onChange(e.target.value)} placeholder={placeholder} className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm ${Icon ? 'pl-10' : 'px-4'} py-2.5 border`} /></div>
            </div>
        );

        const Select = ({ label, value, onChange, options, className = '' }) => (
            <div className={`space-y-1 ${className}`}>
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <select value={value} onChange={(e) => onChange && onChange(e.target.value)} className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-2.5 border">{options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select>
            </div>
        );

        const ProgressBar = ({ value, max = 100, color = 'bg-bgfi-primary', size = 'md' }) => {
            const percentage = Math.min((value / max) * 100, 100);
            const sizes = { sm: 'h-1.5', md: 'h-2', lg: 'h-3' };
            return <div className={`w-full bg-gray-200 rounded-full ${sizes[size]}`}><div className={`${color} rounded-full transition-all duration-500 ${sizes[size]}`} style={{ width: `${percentage}%` }} /></div>;
        };

        const StatCard = ({ title, value, change, changeType = 'positive', icon: Icon, color = 'blue' }) => {
            const colors = { blue: 'bg-blue-50 text-blue-600', green: 'bg-emerald-50 text-emerald-600', amber: 'bg-amber-50 text-amber-600', purple: 'bg-purple-50 text-purple-600', red: 'bg-red-50 text-red-600' };
            return <Card className="h-full"><div className="flex items-start justify-between"><div><p className="text-sm font-medium text-gray-600">{title}</p><p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>{change !== undefined && <div className="flex items-center mt-2"><span className={`text-sm font-medium ${changeType === 'positive' ? 'text-emerald-600' : 'text-red-600'}`}>{changeType === 'positive' ? '+' : ''}{change}%</span><span className="text-sm text-gray-500 ml-1">vs mois dernier</span></div>}</div>{Icon && <div className={`p-3 rounded-xl ${colors[color]}`}><Icon /></div>}</div></Card>;
        };

        const Spinner = () => <div className="flex items-center justify-center p-12"><div className="w-10 h-10 border-4 border-bgfi-primary border-t-transparent rounded-full animate-spin" /></div>;

        const ErrorBox = ({ message, onRetry }) => (
            <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <p className="text-red-700 mb-3">{message}</p>
                {onRetry && <Button variant="danger" size="sm" onClick={onRetry}>Reessayer</Button>}
            </div>
        );

        // =============================================
        // Login Page
        // =============================================
        const LoginPage = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
                    authStore.setToken(data.token); authStore.setUser(data.user);
                    onLogin(data.user);
                } catch (err) { setError(err.message || 'Identifiants invalides'); }
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4"><span className="text-white font-bold text-2xl">B</span></div>
                            <h1 className="text-2xl font-bold text-gray-900">BGFI Marketing</h1>
                            <p className="text-gray-500 mt-1">WhatsApp SaaS Platform</p>
                        </div>
                        <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-lg p-8 space-y-6">
                            {error && <div className="bg-red-50 text-red-700 px-4 py-3 rounded-xl text-sm">{error}</div>}
                            <Input label="Email" type="email" placeholder="admin@bgfi.ga" value={email} onChange={setEmail} icon={Icons.Mail} />
                            <Input label="Mot de passe" type="password" placeholder="********" value={password} onChange={setPassword} />
                            <Button type="submit" className="w-full" size="lg" disabled={loading}>{loading ? 'Connexion...' : 'Se connecter'}</Button>
                        </form>
                        <p className="text-center text-xs text-gray-400 mt-6">BGFI WhatsApp Marketing SaaS v1.0</p>
                    </div>
                </div>
            );
        };

        // =============================================
        // Main App
        // =============================================
        const BGFIWhatsAppSaaS = () => {
            const [user, setUser] = useState(authStore.getUser());
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);

            if (!user) return <LoginPage onLogin={setUser} />;

            const handleLogout = () => { authStore.clear(); setUser(null); };

            const menuItems = [
                { id: 'dashboard', label: 'Tableau de bord', icon: Icons.LayoutDashboard },
                { id: 'campaigns', label: 'Campagnes', icon: Icons.Send },
                { id: 'segments', label: 'Segments', icon: Icons.Layers },
                { id: 'chatbot', label: 'Chatbot RAG', icon: Icons.Bot },
                { id: 'contacts', label: 'Contacts', icon: Icons.Users },
                { id: 'templates', label: 'Templates', icon: Icons.FileText },
                { id: 'analytics', label: 'Analytics', icon: Icons.BarChart3 },
                { id: 'settings', label: 'Parametres', icon: Icons.Settings },
            ];

            const renderContent = () => {
                switch (activeTab) {
                    case 'dashboard': return <DashboardView onNavigate={setActiveTab} />;
                    case 'campaigns': return <CampaignsView />;
                    case 'segments': return <SegmentsView />;
                    case 'chatbot': return <ChatbotView />;
                    case 'contacts': return <ContactsView />;
                    case 'templates': return <TemplatesView />;
                    case 'analytics': return <AnalyticsView />;
                    case 'settings': return <SettingsView />;
                    default: return <DashboardView onNavigate={setActiveTab} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex">
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 lg:translate-x-0 lg:static lg:inset-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="flex items-center justify-between h-16 px-6 border-b border-gray-200">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center"><span className="text-white font-bold text-lg">B</span></div>
                                <div><h1 className="font-bold text-gray-900 text-sm">BGFI Marketing</h1><p className="text-xs text-gray-500">WhatsApp SaaS</p></div>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="lg:hidden text-gray-500 hover:text-gray-700"><Icons.X /></button>
                        </div>
                        <nav className="p-4 space-y-1">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${activeTab === item.id ? 'bg-bgfi-primary text-white shadow-md' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}>
                                    <item.icon />{item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
                            <div className="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl">
                                <div className="w-10 h-10 bg-bgfi-accent rounded-full flex items-center justify-center text-white font-semibold">{(user.name || 'U').substring(0, 2).toUpperCase()}</div>
                                <div className="flex-1 min-w-0"><p className="text-sm font-medium text-gray-900 truncate">{user.name}</p><p className="text-xs text-gray-500 truncate">{user.email}</p></div>
                                <button onClick={handleLogout} className="p-1.5 text-gray-400 hover:text-red-500 rounded-lg hover:bg-red-50" title="Deconnexion"><Icons.LogOut /></button>
                            </div>
                        </div>
                    </aside>

                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"><Icons.Menu /></button>
                                <h2 className="text-xl font-semibold text-gray-900">{menuItems.find(item => item.id === activeTab)?.label}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <button className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg relative"><Icons.MessageSquare /><span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" /></button>
                                <button onClick={() => setActiveTab('settings')} className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"><Icons.Settings /></button>
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto p-4 lg:p-8"><div className="max-w-7xl mx-auto animate-fade-in">{renderContent()}</div></main>
                    </div>
                </div>
            );
        };

        // =============================================
        // Dashboard View
        // =============================================
        const DashboardView = ({ onNavigate }) => {
            const { data: dash, loading, error, refetch } = useApi('/analytics/dashboard');
            const chartsRef = useRef({});

            useEffect(() => {
                if (!dash) return;
                // Destroy old charts
                Object.values(chartsRef.current).forEach(c => c.destroy && c.destroy());
                chartsRef.current = {};
                const ctx1 = document.getElementById('campaignsChart');
                const ctx2 = document.getElementById('engagementChart');
                if (ctx1) {
                    const stats = dash.messageStats || {};
                    const months = ['Jan', 'Fev', 'Mar', 'Avr', 'Mai', 'Juin'];
                    chartsRef.current.c1 = new Chart(ctx1, { type: 'line', data: { labels: months, datasets: [{ label: 'Messages', data: [stats.SENT || 0, stats.DELIVERED || 0, stats.READ || 0, 0, 0, 0], borderColor: '#1e3a5f', backgroundColor: 'rgba(30, 58, 95, 0.1)', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
                }
                if (ctx2) {
                    const o = dash.overview || {};
                    const readPct = o.openRate || 0;
                    const failPct = 100 - (o.deliveryRate || 100);
                    const unreadPct = Math.max(0, 100 - readPct - failPct);
                    chartsRef.current.c2 = new Chart(ctx2, { type: 'doughnut', data: { labels: ['Lus', 'Non lus', 'Echoues'], datasets: [{ data: [readPct, unreadPct, failPct], backgroundColor: ['#00a86b', '#f59e0b', '#ef4444'] }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%' } });
                }
            }, [dash]);

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;
            if (!dash) return null;

            const o = dash.overview || {};
            const c = dash.campaigns || {};
            const recent = dash.recentCampaigns || [];

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Campagnes Actives" value={c.active || 0} icon={Icons.Send} color="blue" />
                        <StatCard title="Messages Envoyes" value={formatNum(o.totalMessages || 0)} icon={Icons.MessageSquare} color="green" />
                        <StatCard title="Taux d'Ouverture" value={(o.openRate || 0).toFixed(1) + '%'} icon={Icons.Eye} color="purple" />
                        <StatCard title="Taux de Clic" value={(o.clickRate || 0).toFixed(1) + '%'} icon={Icons.MousePointer} color="amber" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card title="Evolution des Campagnes" className="lg:col-span-2" action={<Button variant="ghost" size="sm" icon={Icons.Download}>Exporter</Button>}><div className="h-64"><canvas id="campaignsChart" /></div></Card>
                        <Card title="Engagement">
                            <div className="h-48"><canvas id="engagementChart" /></div>
                            <div className="mt-4 space-y-2">
                                <div className="flex justify-between text-sm"><span className="text-gray-600">Taux lecture</span><span className="font-medium text-emerald-600">{(o.openRate || 0).toFixed(0)}%</span></div>
                                <div className="flex justify-between text-sm"><span className="text-gray-600">Taux delivrance</span><span className="font-medium text-blue-600">{(o.deliveryRate || 0).toFixed(0)}%</span></div>
                                <div className="flex justify-between text-sm"><span className="text-gray-600">Taux clic</span><span className="font-medium text-amber-600">{(o.clickRate || 0).toFixed(0)}%</span></div>
                            </div>
                        </Card>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card title="Campagnes Recentes" action={<Button variant="ghost" size="sm" onClick={() => onNavigate('campaigns')}>Voir tout</Button>}>
                            <div className="space-y-4">
                                {recent.length === 0 && <p className="text-sm text-gray-500 text-center py-4">Aucune campagne recente</p>}
                                {recent.slice(0, 3).map(campaign => (
                                    <div key={campaign.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${campaign.status === 'COMPLETED' ? 'bg-emerald-100 text-emerald-600' : campaign.status === 'RUNNING' ? 'bg-blue-100 text-blue-600' : campaign.status === 'SCHEDULED' ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'}`}>
                                                {campaign.status === 'COMPLETED' ? <Icons.CheckCircle /> : campaign.status === 'RUNNING' ? <Icons.Play /> : campaign.status === 'SCHEDULED' ? <Icons.Clock /> : <Icons.FileText />}
                                            </div>
                                            <div><p className="font-medium text-gray-900">{campaign.name}</p><p className="text-sm text-gray-500">{new Date(campaign.createdAt).toLocaleDateString('fr-FR')}</p></div>
                                        </div>
                                        <Badge variant={statusVariant[campaign.status] || 'default'}>{statusMap[campaign.status] || campaign.status}</Badge>
                                    </div>
                                ))}
                            </div>
                        </Card>
                        <Card title="Actions Rapides">
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => onNavigate('campaigns')} className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-bgfi-primary rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Plus /></div>
                                    <p className="font-semibold text-gray-900">Nouvelle Campagne</p><p className="text-sm text-gray-600 mt-1">Creer une campagne WhatsApp</p>
                                </button>
                                <button onClick={() => onNavigate('contacts')} className="p-6 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-bgfi-accent rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Upload /></div>
                                    <p className="font-semibold text-gray-900">Importer Contacts</p><p className="text-sm text-gray-600 mt-1">CSV ou Excel</p>
                                </button>
                                <button onClick={() => onNavigate('chatbot')} className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Bot /></div>
                                    <p className="font-semibold text-gray-900">Configurer Chatbot</p><p className="text-sm text-gray-600 mt-1">RAG & Base de connaissances</p>
                                </button>
                                <button onClick={() => onNavigate('templates')} className="p-6 bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-amber-600 rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.FileText /></div>
                                    <p className="font-semibold text-gray-900">Nouveau Template</p><p className="text-sm text-gray-600 mt-1">Message WhatsApp</p>
                                </button>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // =============================================
        // Campaigns View
        // =============================================
        const msgStatusMap = { PENDING: 'En attente', QUEUED: 'En file', SENT: 'Envoye', DELIVERED: 'Delivre', READ: 'Lu', FAILED: 'Echoue' };
        const msgStatusVariant = { PENDING: 'default', QUEUED: 'default', SENT: 'info', DELIVERED: 'success', READ: 'primary', FAILED: 'danger' };

        const CampaignDetailView = ({ campaign, onBack, onSend, templates }) => {
            const { data: msgData, loading: msgLoading } = useApi('/campaigns/' + campaign.id + '/messages?limit=500');
            const messages = msgData?.data || [];

            const c = campaign;
            const totalSent = c.sent || 0;
            const deliveryRate = totalSent > 0 ? ((c.delivered / totalSent) * 100).toFixed(1) : 0;
            const openRate = c.delivered > 0 ? ((c.read / c.delivered) * 100).toFixed(1) : 0;
            const clickRate = c.read > 0 ? ((c.clicked / c.read) * 100).toFixed(1) : 0;

            const [statusFilter, setStatusFilter] = useState('');
            const filtered = statusFilter ? messages.filter(m => m.status === statusFilter) : messages;

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-4">
                        <Button variant="ghost" icon={Icons.ArrowLeft} onClick={onBack}>Retour aux campagnes</Button>
                    </div>

                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-bgfi-primary/10 rounded-xl flex items-center justify-center text-bgfi-primary"><Icons.Send /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">{c.name}</h2>
                                <p className="text-sm text-gray-500">{catMap[c.type] || c.type} - {c.segmentRef?.name || categoryMap[c.legacySegment] || 'Tous'} - Template: {c.template?.displayName || c.template?.name || '-'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <Badge variant={statusVariant[c.status] || 'default'}>{statusMap[c.status] || c.status}</Badge>
                            {c.status === 'DRAFT' && <Button variant="accent" size="sm" icon={Icons.Play} onClick={() => onSend(c.id)}>Lancer</Button>}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <Card className="text-center"><p className="text-2xl font-bold text-blue-700">{formatNum(totalSent)}</p><p className="text-xs text-blue-600 mt-1">Envoyes</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-green-700">{formatNum(c.delivered || 0)}</p><p className="text-xs text-green-600 mt-1">Delivres ({deliveryRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-purple-700">{formatNum(c.read || 0)}</p><p className="text-xs text-purple-600 mt-1">Lus ({openRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-amber-700">{formatNum(c.clicked || 0)}</p><p className="text-xs text-amber-600 mt-1">Cliques ({clickRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-red-700">{formatNum(c.failed || 0)}</p><p className="text-xs text-red-600 mt-1">Echoues</p></Card>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div className="text-sm"><span className="text-gray-500">Creee le</span><p className="font-medium text-gray-900">{c.createdAt ? new Date(c.createdAt).toLocaleString('fr-FR') : '-'}</p></div>
                        <div className="text-sm"><span className="text-gray-500">Lancee le</span><p className="font-medium text-gray-900">{c.startedAt ? new Date(c.startedAt).toLocaleString('fr-FR') : '-'}</p></div>
                        <div className="text-sm"><span className="text-gray-500">Terminee le</span><p className="font-medium text-gray-900">{c.completedAt ? new Date(c.completedAt).toLocaleString('fr-FR') : '-'}</p></div>
                        {c.scheduledAt && <div className="text-sm"><span className="text-gray-500">Planifiee le</span><p className="font-medium text-gray-900">{new Date(c.scheduledAt).toLocaleString('fr-FR')}</p></div>}
                    </div>

                    <Card>
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-900">Detail des envois ({filtered.length})</h3>
                            <div className="flex gap-2">
                                <select className="text-sm border border-gray-300 rounded-lg px-3 py-2" value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                                    <option value="">Tous les statuts</option>
                                    <option value="SENT">Envoyes</option>
                                    <option value="DELIVERED">Delivres</option>
                                    <option value="READ">Lus</option>
                                    <option value="FAILED">Echoues</option>
                                    <option value="PENDING">En attente</option>
                                </select>
                            </div>
                        </div>
                        {msgLoading ? <Spinner /> : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200">
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Contact</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Telephone</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Statut</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date d'envoi</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Erreur</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filtered.length === 0 && <tr><td colSpan="5" className="py-8 text-center text-gray-500">Aucun message</td></tr>}
                                    {filtered.map(m => (
                                        <tr key={m.id} className="hover:bg-gray-50">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 text-xs font-medium">{(m.contact?.name || '?')[0].toUpperCase()}</div>
                                                    <span className="text-sm font-medium text-gray-900">{m.contact?.name || '-'}</span>
                                                </div>
                                            </td>
                                            <td className="py-3 px-4 text-sm text-gray-600 font-mono">{m.contact?.phone || '-'}</td>
                                            <td className="py-3 px-4"><Badge variant={msgStatusVariant[m.status] || 'default'}>{msgStatusMap[m.status] || m.status}</Badge></td>
                                            <td className="py-3 px-4 text-sm text-gray-500">{m.sentAt ? new Date(m.sentAt).toLocaleString('fr-FR') : m.createdAt ? new Date(m.createdAt).toLocaleString('fr-FR') : '-'}</td>
                                            <td className="py-3 px-4 text-sm text-red-600">{m.error || ''}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        )}
                    </Card>
                </div>
            );
        };

        // =============================================
        // Segment Builder Component
        // =============================================
        const SEGMENT_FIELDS = [
            { name: 'category', label: 'Categorie', type: 'select', group: 'PROFIL', options: ['ALL', 'ACTIVE', 'INACTIVE', 'NEW', 'PREMIUM', 'VIP'] },
            { name: 'city', label: 'Ville', type: 'text', group: 'PROFIL' },
            { name: 'country', label: 'Pays', type: 'text', group: 'PROFIL' },
            { name: 'ageRange', label: "Tranche d'age", type: 'select', group: 'PROFIL', options: ['18-25', '26-35', '36-45', '46-55', '56+'] },
            { name: 'gender', label: 'Genre', type: 'select', group: 'PROFIL', options: ['M', 'F', 'AUTRE'] },
            { name: 'language', label: 'Langue', type: 'select', group: 'PROFIL', options: ['fr', 'en', 'es'] },
            { name: 'accountType', label: 'Type de compte', type: 'select', group: 'BANQUE', options: ['EPARGNE', 'COURANT', 'PROFESSIONNEL', 'JEUNE'] },
            { name: 'engagementScore', label: "Score engagement", type: 'number', group: 'COMPORTEMENT' },
            { name: 'status', label: 'Statut contact', type: 'select', group: 'PROFIL', options: ['ACTIVE', 'UNSUBSCRIBED', 'BLOCKED'] },
        ];
        const OPS_BY_TYPE = {
            select: [{ v: 'eq', l: '=' }, { v: 'neq', l: '!=' }, { v: 'in', l: 'dans' }],
            text: [{ v: 'eq', l: '=' }, { v: 'contains', l: 'contient' }],
            number: [{ v: 'eq', l: '=' }, { v: 'gt', l: '>' }, { v: 'gte', l: '>=' }, { v: 'lt', l: '<' }, { v: 'lte', l: '<=' }],
            date: [{ v: 'gt', l: 'apres' }, { v: 'lt', l: 'avant' }],
            boolean: [{ v: 'eq', l: '=' }]
        };

        const RuleRow = ({ rule, onChange, onRemove }) => {
            const fieldDef = SEGMENT_FIELDS.find(f => f.name === rule.field) || SEGMENT_FIELDS[0];
            const ops = OPS_BY_TYPE[fieldDef.type] || OPS_BY_TYPE.text;
            return (
                <div className="flex items-center gap-2 flex-wrap">
                    <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.field} onChange={e => { const fd = SEGMENT_FIELDS.find(f => f.name === e.target.value); onChange({ ...rule, field: e.target.value, op: (OPS_BY_TYPE[fd?.type] || OPS_BY_TYPE.text)[0].v, value: '' }); }}>
                        {SEGMENT_FIELDS.map(f => <option key={f.name} value={f.name}>{f.label}</option>)}
                    </select>
                    <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.op} onChange={e => onChange({ ...rule, op: e.target.value })}>
                        {ops.map(o => <option key={o.v} value={o.v}>{o.l}</option>)}
                    </select>
                    {fieldDef.options ? (
                        <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.value} onChange={e => onChange({ ...rule, value: e.target.value })}>
                            <option value="">Choisir...</option>
                            {fieldDef.options.map(o => <option key={o} value={o}>{o}</option>)}
                        </select>
                    ) : (
                        <input type={fieldDef.type === 'number' ? 'number' : 'text'} className="border border-gray-300 rounded-lg px-3 py-2 text-sm w-40" placeholder="Valeur" value={rule.value} onChange={e => onChange({ ...rule, value: fieldDef.type === 'number' ? Number(e.target.value) : e.target.value })} />
                    )}
                    <button className="text-red-500 hover:text-red-700 p-1" onClick={onRemove}><Icons.Trash2 /></button>
                </div>
            );
        };

        const SegmentBuilder = ({ criteria, onChange, previewCount }) => {
            const addRule = () => {
                const newRules = [...(criteria.rules || []), { field: 'city', op: 'eq', value: '' }];
                onChange({ ...criteria, rules: newRules });
            };
            const updateRule = (idx, rule) => {
                const newRules = [...criteria.rules]; newRules[idx] = rule;
                onChange({ ...criteria, rules: newRules });
            };
            const removeRule = (idx) => {
                const newRules = criteria.rules.filter((_, i) => i !== idx);
                onChange({ ...criteria, rules: newRules });
            };
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-2 mb-2">
                        <span className="text-sm font-medium text-gray-700">Operateur logique :</span>
                        <button className={'px-3 py-1 rounded-lg text-sm font-medium ' + (criteria.operator === 'AND' ? 'bg-bgfi-primary text-white' : 'bg-gray-100 text-gray-600')} onClick={() => onChange({ ...criteria, operator: 'AND' })}>ET (AND)</button>
                        <button className={'px-3 py-1 rounded-lg text-sm font-medium ' + (criteria.operator === 'OR' ? 'bg-bgfi-primary text-white' : 'bg-gray-100 text-gray-600')} onClick={() => onChange({ ...criteria, operator: 'OR' })}>OU (OR)</button>
                    </div>
                    <div className="space-y-2 pl-4 border-l-2 border-bgfi-primary/30">
                        {(criteria.rules || []).map((rule, idx) => (
                            <RuleRow key={idx} rule={rule} onChange={r => updateRule(idx, r)} onRemove={() => removeRule(idx)} />
                        ))}
                    </div>
                    <Button variant="secondary" size="sm" icon={Icons.Plus} onClick={addRule}>Ajouter un critere</Button>
                    {previewCount !== null && previewCount !== undefined && (
                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2">
                            <Icons.Users />
                            <span className="text-sm font-medium text-blue-900">{previewCount} contact(s) correspondent</span>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Stepper Component
        // =============================================
        const Stepper = ({ steps, current }) => (
            <div className="flex items-center justify-between mb-8">
                {steps.map((step, i) => (
                    <React.Fragment key={i}>
                        <div className="flex items-center gap-2">
                            <div className={'w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ' + (i < current ? 'bg-green-500 text-white' : i === current ? 'bg-bgfi-primary text-white' : 'bg-gray-200 text-gray-500')}>
                                {i < current ? '\u2713' : i + 1}
                            </div>
                            <span className={'text-sm font-medium hidden sm:inline ' + (i <= current ? 'text-gray-900' : 'text-gray-400')}>{step}</span>
                        </div>
                        {i < steps.length - 1 && <div className={'flex-1 h-0.5 mx-2 ' + (i < current ? 'bg-green-500' : 'bg-gray-200')} />}
                    </React.Fragment>
                ))}
            </div>
        );

        // =============================================
        // Campaign Wizard (5 steps)
        // =============================================
        const CampaignWizard = ({ onClose, onCreated, templates }) => {
            const [step, setStep] = useState(0);
            const [creating, setCreating] = useState(false);
            const [previewCount, setPreviewCount] = useState(null);
            const { data: segData } = useApi('/segments?limit=100');
            const segments = segData?.data || [];

            const [form, setForm] = useState({
                name: '', type: '', description: '',
                targetMode: 'segment', segmentId: '', inlineCriteria: { operator: 'AND', rules: [] }, saveSegment: false, newSegmentName: '',
                templateId: '',
                scheduledAt: ''
            });

            const stepNames = ['Configuration', 'Ciblage', 'Contenu', 'Planification', 'Recapitulatif'];

            // Debounced preview
            const previewTimer = React.useRef(null);
            React.useEffect(() => {
                if (form.targetMode !== 'builder' || form.inlineCriteria.rules.length === 0) { setPreviewCount(null); return; }
                clearTimeout(previewTimer.current);
                previewTimer.current = setTimeout(async () => {
                    try {
                        const res = await api('/segments/preview', { method: 'POST', body: JSON.stringify({ criteria: form.inlineCriteria }) });
                        setPreviewCount(res.contactCount);
                    } catch { setPreviewCount(null); }
                }, 500);
                return () => clearTimeout(previewTimer.current);
            }, [form.inlineCriteria, form.targetMode]);

            const handleCreate = async () => {
                setCreating(true);
                try {
                    const body = { name: form.name, type: form.type, templateId: form.templateId, scheduledAt: form.scheduledAt || undefined };
                    if (form.targetMode === 'segment' && form.segmentId) {
                        body.segmentId = form.segmentId;
                    } else if (form.targetMode === 'builder') {
                        if (form.saveSegment && form.newSegmentName) {
                            const seg = await api('/segments', { method: 'POST', body: JSON.stringify({ name: form.newSegmentName, criteria: form.inlineCriteria }) });
                            body.segmentId = seg.id;
                        } else {
                            body.inlineCriteria = form.inlineCriteria;
                        }
                    } else {
                        body.segment = 'ALL';
                    }
                    await api('/campaigns', { method: 'POST', body: JSON.stringify(body) });
                    onCreated();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const canNext = () => {
                if (step === 0) return form.name && form.type;
                if (step === 1) return form.targetMode === 'all' || (form.targetMode === 'segment' && form.segmentId) || (form.targetMode === 'builder' && form.inlineCriteria.rules.length > 0);
                if (step === 2) return form.templateId;
                return true;
            };

            const selTemplate = templates.find(t => t.id === form.templateId);
            const selSegment = segments.find(s => s.id === form.segmentId);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-auto">
                        <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                            <h2 className="text-xl font-semibold text-gray-900">Nouvelle Campagne WhatsApp</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>
                        <div className="p-6">
                            <Stepper steps={stepNames} current={step} />

                            {step === 0 && (
                                <div className="space-y-4">
                                    <Input label="Nom de la campagne" placeholder="Ex: Relance App Mobile - Fevrier" value={form.name} onChange={v => setForm({...form, name: v})} />
                                    <Select label="Type" value={form.type} onChange={v => setForm({...form, type: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'REACTIVATION', label: 'Reactivation' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'NOTIFICATION', label: 'Notification' }, { value: 'ALERT', label: 'Alerte' }]} />
                                </div>
                            )}

                            {step === 1 && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-3 gap-3">
                                        {[
                                            { id: 'all', label: 'Tous les contacts', desc: 'Cibler tous les contacts actifs', icon: Icons.Users },
                                            { id: 'segment', label: 'Segment sauvegarde', desc: 'Utiliser un segment existant', icon: Icons.Layers },
                                            { id: 'builder', label: 'Criteres avances', desc: 'Construire un ciblage sur mesure', icon: Icons.Target }
                                        ].map(m => (
                                            <div key={m.id} className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (form.targetMode === m.id ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200 hover:border-gray-300')} onClick={() => setForm({...form, targetMode: m.id})}>
                                                <div className="text-bgfi-primary mb-2"><m.icon /></div>
                                                <p className="font-medium text-sm text-gray-900">{m.label}</p>
                                                <p className="text-xs text-gray-500 mt-1">{m.desc}</p>
                                            </div>
                                        ))}
                                    </div>
                                    {form.targetMode === 'segment' && (
                                        <div className="space-y-3">
                                            <Select label="Segment" value={form.segmentId} onChange={v => setForm({...form, segmentId: v})} options={[{ value: '', label: 'Selectionner un segment...' }, ...segments.map(s => ({ value: s.id, label: s.name + ' (' + s.contactCount + ' contacts)' }))]} />
                                            {selSegment?.description && <p className="text-sm text-gray-500">{selSegment.description}</p>}
                                        </div>
                                    )}
                                    {form.targetMode === 'builder' && (
                                        <div className="space-y-4">
                                            <SegmentBuilder criteria={form.inlineCriteria} onChange={c => setForm({...form, inlineCriteria: c})} previewCount={previewCount} />
                                            <div className="flex items-center gap-3 mt-4 p-3 bg-gray-50 rounded-xl">
                                                <input type="checkbox" id="saveSeg" checked={form.saveSegment} onChange={e => setForm({...form, saveSegment: e.target.checked})} className="rounded" />
                                                <label htmlFor="saveSeg" className="text-sm text-gray-700">Sauvegarder comme segment reutilisable</label>
                                                {form.saveSegment && <Input placeholder="Nom du segment" value={form.newSegmentName} onChange={v => setForm({...form, newSegmentName: v})} className="flex-1" />}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 2 && (
                                <div className="space-y-4">
                                    <Select label="Template approuve" value={form.templateId} onChange={v => setForm({...form, templateId: v})} options={[{ value: '', label: 'Selectionner un template...' }, ...templates.map(t => ({ value: t.id, label: (t.displayName || t.name) + ' (' + (t.category || '') + ')' }))]} />
                                    {selTemplate && (
                                        <div className="bg-gray-50 rounded-xl p-4">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Apercu :</p>
                                            <p className="text-sm text-gray-600 whitespace-pre-wrap">{selTemplate.content}</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 3 && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (!form.scheduledAt ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200')} onClick={() => setForm({...form, scheduledAt: ''})}>
                                            <Icons.Send />
                                            <p className="font-medium text-sm mt-2">Envoi immediat</p>
                                            <p className="text-xs text-gray-500">La campagne sera en brouillon, prete a etre lancee</p>
                                        </div>
                                        <div className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (form.scheduledAt ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200')} onClick={() => setForm({...form, scheduledAt: form.scheduledAt || new Date().toISOString().slice(0, 16)})}>
                                            <Icons.Calendar />
                                            <p className="font-medium text-sm mt-2">Planifier</p>
                                            <p className="text-xs text-gray-500">Choisir une date et heure d'envoi</p>
                                        </div>
                                    </div>
                                    {form.scheduledAt && <Input label="Date et heure d'envoi" type="datetime-local" value={form.scheduledAt} onChange={v => setForm({...form, scheduledAt: v})} />}
                                </div>
                            )}

                            {step === 4 && (
                                <div className="space-y-4">
                                    <div className="bg-gray-50 rounded-xl p-6 space-y-3">
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Campagne</span><span className="text-sm font-medium">{form.name}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Type</span><span className="text-sm font-medium">{catMap[form.type] || form.type}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Ciblage</span><span className="text-sm font-medium">{form.targetMode === 'all' ? 'Tous les contacts' : form.targetMode === 'segment' ? (selSegment?.name || '-') : 'Criteres personnalises' + (previewCount !== null ? ' (' + previewCount + ' contacts)' : '')}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Template</span><span className="text-sm font-medium">{selTemplate?.displayName || selTemplate?.name || '-'}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Planification</span><span className="text-sm font-medium">{form.scheduledAt ? new Date(form.scheduledAt).toLocaleString('fr-FR') : 'Brouillon (envoi manuel)'}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-6 border-t border-gray-200 flex justify-between">
                            <div>{step > 0 && <Button variant="secondary" icon={Icons.ChevronLeft} onClick={() => setStep(step - 1)}>Retour</Button>}</div>
                            <div className="flex gap-3">
                                <Button variant="secondary" onClick={onClose}>Annuler</Button>
                                {step < 4 ? (
                                    <Button onClick={() => setStep(step + 1)} disabled={!canNext()} icon={Icons.ChevronRight}>Suivant</Button>
                                ) : (
                                    <Button onClick={handleCreate} disabled={creating} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Creer la campagne'}</Button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =============================================
        // Campaigns View
        // =============================================
        const CampaignsView = () => {
            const [showWizard, setShowWizard] = useState(false);
            const [selectedCampaign, setSelectedCampaign] = useState(null);
            const { data, loading, error, refetch } = useApi('/campaigns?limit=50');
            const { data: tplData } = useApi('/templates?status=APPROVED&limit=100');

            const campaigns = data?.data || [];
            const templates = tplData?.data || [];

            const handleSend = async (id) => {
                if (!confirm('Lancer cette campagne ?')) return;
                try { await api('/campaigns/' + id + '/send', { method: 'POST' }); setSelectedCampaign(null); refetch(); }
                catch (err) { alert(err.message); }
            };

            const [editModal, setEditModal] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', type: '', templateId: '', segment: '', scheduledAt: '' });
            const [saving, setSaving] = useState(false);

            const openEdit = (c) => {
                setEditForm({
                    name: c.name, type: c.type,
                    templateId: c.templateId || c.template?.id || '',
                    segment: c.legacySegment || 'ALL',
                    scheduledAt: c.scheduledAt ? new Date(c.scheduledAt).toISOString().slice(0, 16) : ''
                });
                setEditModal(c);
            };

            const handleEdit = async () => {
                setSaving(true);
                try {
                    await api('/campaigns/' + editModal.id, { method: 'PUT', body: JSON.stringify(editForm) });
                    setEditModal(null); refetch();
                } catch (err) { alert(err.message); }
                finally { setSaving(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer cette campagne ? Cette action est irreversible.')) return;
                try { await api('/campaigns/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            if (selectedCampaign) {
                return <CampaignDetailView campaign={selectedCampaign} onBack={() => { setSelectedCampaign(null); refetch(); }} onSend={handleSend} templates={templates} />;
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-4"><Input placeholder="Rechercher une campagne..." icon={Icons.Search} className="w-64" /></div>
                        <Button onClick={() => setShowWizard(true)} icon={Icons.Plus}>Nouvelle Campagne</Button>
                    </div>
                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Campagne</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Statut</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Type</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Ciblage</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Envoyes</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {campaigns.length === 0 && <tr><td colSpan="7" className="py-8 text-center text-gray-500">Aucune campagne</td></tr>}
                                    {campaigns.map(c => (
                                        <tr key={c.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedCampaign(c)}>
                                            <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-bgfi-primary/10 rounded-xl flex items-center justify-center text-bgfi-primary"><Icons.Send /></div><div><p className="font-medium text-gray-900">{c.name}</p><p className="text-sm text-gray-500">{c.template?.name || '-'}</p></div></div></td>
                                            <td className="py-4 px-4"><Badge variant={statusVariant[c.status] || 'default'}>{statusMap[c.status] || c.status}</Badge></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{catMap[c.type] || c.type}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{c.segmentRef?.name || categoryMap[c.legacySegment] || 'Tous'}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{c.sent || 0}/{c.delivered || 0}/{c.failed || 0}</td>
                                            <td className="py-4 px-4 text-sm text-gray-500">{c.createdAt ? new Date(c.createdAt).toLocaleDateString('fr-FR') : '-'}</td>
                                            <td className="py-4 px-4 text-right" onClick={e => e.stopPropagation()}><div className="flex items-center justify-end gap-2">{c.status === 'DRAFT' && <Button variant="accent" size="sm" icon={Icons.Play} onClick={() => handleSend(c.id)}>Lancer</Button>}{['DRAFT','SCHEDULED','PAUSED'].includes(c.status) && <Button variant="ghost" size="sm" icon={Icons.Edit} onClick={() => openEdit(c)} title="Modifier" />}<Button variant="ghost" size="sm" icon={Icons.BarChart3} onClick={() => setSelectedCampaign(c)} title="Statistiques" />{c.status !== 'RUNNING' && <Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(c.id)} title="Supprimer" />}</div></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {showWizard && <CampaignWizard onClose={() => setShowWizard(false)} onCreated={() => { setShowWizard(false); refetch(); }} templates={templates} />}

                    {editModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Modifier la Campagne</h2>
                                    <button onClick={() => setEditModal(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <Input label="Nom de la campagne" value={editForm.name} onChange={v => setEditForm({...editForm, name: v})} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Type" value={editForm.type} onChange={v => setEditForm({...editForm, type: v})} options={[{ value: 'REACTIVATION', label: 'Reactivation' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'NOTIFICATION', label: 'Notification' }, { value: 'ALERT', label: 'Alerte' }]} />
                                        <Select label="Template" value={editForm.templateId} onChange={v => setEditForm({...editForm, templateId: v})} options={[{ value: '', label: 'Selectionner...' }, ...templates.map(t => ({ value: t.id, label: t.displayName || t.name }))]} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Categorie" value={editForm.segment} onChange={v => setEditForm({...editForm, segment: v})} options={[{ value: 'ALL', label: 'Tous les contacts' }, { value: 'ACTIVE', label: 'Actifs' }, { value: 'INACTIVE', label: 'Inactifs' }, { value: 'NEW', label: 'Nouveaux' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                                        <Input label="Date d'envoi" type="datetime-local" value={editForm.scheduledAt} onChange={v => setEditForm({...editForm, scheduledAt: v})} />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setEditModal(null)}>Annuler</Button>
                                    <Button onClick={handleEdit} disabled={saving || !editForm.name} icon={Icons.CheckCircle}>{saving ? 'Enregistrement...' : 'Enregistrer'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Chatbot RAG View
        // =============================================
        const ChatbotView = () => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('chat');
            const { data: knowledgeData, refetch: refetchKB } = useApi('/chatbot/knowledge');
            const [sessionId, setSessionId] = useState(null);
            const messagesEndRef = useRef(null);

            const uploadedFiles = knowledgeData?.documents || [];

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const handleSendMessage = async () => {
                if (!inputMessage.trim()) return;
                const userMsg = { id: Date.now(), role: 'user', content: inputMessage, timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) };
                setMessages(prev => [...prev, userMsg]);
                const msgText = inputMessage;
                setInputMessage(''); setIsTyping(true);
                try {
                    const res = await api('/chatbot/message', { method: 'POST', body: JSON.stringify({ message: msgText, sessionId }) });
                    if (res.sessionId) setSessionId(res.sessionId);
                    setMessages(prev => [...prev, { id: Date.now()+1, role: 'bot', content: res.response || res.message || 'Pas de reponse', timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) }]);
                } catch (err) {
                    setMessages(prev => [...prev, { id: Date.now()+1, role: 'bot', content: 'Erreur: ' + err.message, timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) }]);
                } finally { setIsTyping(false); }
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const fd = new FormData(); fd.append('file', file);
                    try { await api('/chatbot/knowledge/upload', { method: 'POST', body: fd }); refetchKB(); }
                    catch (err) { alert('Erreur upload: ' + err.message); }
                }
            };

            const handleDeleteDoc = async (id) => {
                if (!confirm('Supprimer ce document ?')) return;
                try { await api('/chatbot/knowledge/' + id, { method: 'DELETE' }); refetchKB(); }
                catch (err) { alert(err.message); }
            };

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-2 border-b border-gray-200">
                        <button onClick={() => setActiveTab('chat')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'chat' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Test du Chatbot</button>
                        <button onClick={() => setActiveTab('knowledge')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'knowledge' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Base de Connaissances</button>
                        <button onClick={() => setActiveTab('config')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'config' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Configuration RAG</button>
                    </div>

                    {activeTab === 'chat' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <Card className="lg:col-span-2" title="Conversation de Test">
                                <div className="h-96 overflow-y-auto space-y-4 mb-4 pr-2">
                                    {messages.length === 0 && <p className="text-center text-gray-400 py-16">Envoyez un message pour tester le chatbot</p>}
                                    {messages.map(msg => (
                                        <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-bgfi-primary text-white rounded-br-md' : 'bg-gray-100 text-gray-900 rounded-bl-md'}`}>
                                                <p className="text-sm whitespace-pre-line">{msg.content}</p>
                                                <p className={`text-xs mt-1 ${msg.role === 'user' ? 'text-blue-200' : 'text-gray-500'}`}>{msg.timestamp}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && <div className="flex justify-start"><div className="bg-gray-100 rounded-2xl rounded-bl-md px-4 py-3"><div className="typing-indicator"><span /><span /><span /></div></div></div>}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="flex gap-2">
                                    <input type="text" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="Ecrivez votre message..." className="flex-1 rounded-xl border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary px-4 py-3 border" />
                                    <Button onClick={handleSendMessage} disabled={isTyping} icon={Icons.Send}>Envoyer</Button>
                                </div>
                            </Card>
                            <div className="space-y-6">
                                <Card title="Suggestions Rapides">
                                    <div className="space-y-2">
                                        {['Comment recuperer mes identifiants ?', 'Quels sont les frais de virement ?', 'Comment activer la biometrie ?', 'Comment faire un retrait ?'].map((suggestion, i) => (
                                            <button key={i} onClick={() => setInputMessage(suggestion)} className="w-full text-left px-4 py-3 text-sm text-gray-700 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">{suggestion}</button>
                                        ))}
                                    </div>
                                </Card>
                            </div>
                        </div>
                    )}

                    {activeTab === 'knowledge' && (
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <Input placeholder="Rechercher un document..." icon={Icons.Search} className="w-80" />
                                <div>
                                    <input type="file" multiple onChange={handleFileUpload} className="hidden" id="file-upload" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" />
                                    <label htmlFor="file-upload"><Button variant="primary" icon={Icons.Upload} onClick={() => document.getElementById('file-upload').click()}>Uploader un document</Button></label>
                                </div>
                            </div>
                            <Card>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Document</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Type</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {uploadedFiles.length === 0 && <tr><td colSpan="4" className="py-8 text-center text-gray-500">Aucun document dans la base</td></tr>}
                                            {uploadedFiles.map(file => (
                                                <tr key={file.id} className="hover:bg-gray-50">
                                                    <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center"><Icons.FileText /></div><span className="font-medium text-gray-900">{file.name}</span></div></td>
                                                    <td className="py-4 px-4 text-sm text-gray-600 uppercase">{file.type || '-'}</td>
                                                    <td className="py-4 px-4 text-sm text-gray-600">{file.uploadedAt ? new Date(file.uploadedAt).toLocaleDateString('fr-FR') : '-'}</td>
                                                    <td className="py-4 px-4 text-right"><Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDeleteDoc(file.id)} /></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    )}

                    {activeTab === 'config' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card title="Parametres RAG">
                                <div className="space-y-6">
                                    <Select label="Modele LLM" value="gpt-4" options={[{ value: 'gpt-4', label: 'GPT-4 (Recommande)' }, { value: 'gpt-3.5', label: 'GPT-3.5 Turbo' }]} />
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre de chunks (contexte)</label><input type="range" min="1" max="10" defaultValue="5" className="w-full" /><div className="flex justify-between text-xs text-gray-500 mt-1"><span>1</span><span>5</span><span>10</span></div></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Seuil de similarite</label><input type="range" min="0" max="100" defaultValue="75" className="w-full" /><div className="flex justify-between text-xs text-gray-500 mt-1"><span>0%</span><span>75%</span><span>100%</span></div></div>
                                    <div className="flex items-center gap-3"><input type="checkbox" id="citations" defaultChecked className="w-4 h-4 text-bgfi-primary rounded" /><label htmlFor="citations" className="text-sm text-gray-700">Inclure les citations des sources</label></div>
                                    <div className="flex items-center gap-3"><input type="checkbox" id="fallback" defaultChecked className="w-4 h-4 text-bgfi-primary rounded" /><label htmlFor="fallback" className="text-sm text-gray-700">Reponse de secours si aucune source trouvee</label></div>
                                </div>
                            </Card>
                            <Card title="Personnalisation du Bot">
                                <div className="space-y-6">
                                    <Input label="Nom du Bot" value="Cassiopee" />
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Message d'accueil</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="3" defaultValue="Bonjour ! Je suis Cassiopee, votre assistant BGFI disponible 24/7. Comment puis-je vous aider aujourd'hui ?" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Instructions systeme (prompt)</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border font-mono text-xs" rows="6" defaultValue={`Tu es Cassiopee, l'assistant virtuel de BGFI Bank.\n\nREGLES:\n- Reponds uniquement en francais\n- Base-toi UNIQUEMENT sur la documentation fournie\n- Si tu ne trouves pas la reponse, oriente vers le service client\n- Sois professionnel, chaleureux et concis\n- Ne partage JAMAIS d'informations sensibles`} /></div>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Contacts View
        // =============================================
        const ContactsView = () => {
            const [showImportModal, setShowImportModal] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [search, setSearch] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('');
            const [cityFilter, setCityFilter] = useState('');
            const [accountTypeFilter, setAccountTypeFilter] = useState('');
            const { data, loading, error, refetch } = useApi('/contacts?limit=50' + (search ? '&search=' + encodeURIComponent(search) : '') + (categoryFilter ? '&category=' + categoryFilter : '') + (cityFilter ? '&city=' + encodeURIComponent(cityFilter) : '') + (accountTypeFilter ? '&accountType=' + accountTypeFilter : ''));
            const [form, setForm] = useState({ name: '', phone: '', email: '', category: 'ACTIVE', city: '', accountType: '', ageRange: '', gender: '' });
            const [creating, setCreating] = useState(false);

            const contacts = data?.data || [];

            const handleCreate = async () => {
                setCreating(true);
                try {
                    const body = { ...form };
                    if (!body.city) delete body.city;
                    if (!body.accountType) delete body.accountType;
                    if (!body.ageRange) delete body.ageRange;
                    if (!body.gender) delete body.gender;
                    await api('/contacts', { method: 'POST', body: JSON.stringify(body) });
                    setShowAddModal(false); setForm({ name: '', phone: '', email: '', category: 'ACTIVE', city: '', accountType: '', ageRange: '', gender: '' }); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce contact ?')) return;
                try { await api('/contacts/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData(); fd.append('file', file);
                try {
                    const res = await api('/contacts/import', { method: 'POST', body: fd });
                    alert('Importes: ' + (res.imported || 0) + ' | Echoues: ' + (res.failed || 0));
                    setShowImportModal(false); refetch();
                } catch (err) { alert('Erreur import: ' + err.message); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-2 flex-wrap">
                            <Input placeholder="Rechercher un contact..." icon={Icons.Search} className="w-56" value={search} onChange={setSearch} />
                            <Select value={categoryFilter} onChange={setCategoryFilter} options={[{ value: '', label: 'Categorie' }, { value: 'ACTIVE', label: 'Actifs' }, { value: 'INACTIVE', label: 'Inactifs' }, { value: 'NEW', label: 'Nouveaux' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                            <Select value={accountTypeFilter} onChange={setAccountTypeFilter} options={[{ value: '', label: 'Type compte' }, { value: 'EPARGNE', label: 'Epargne' }, { value: 'COURANT', label: 'Courant' }, { value: 'PROFESSIONNEL', label: 'Pro' }, { value: 'JEUNE', label: 'Jeune' }]} />
                            <Input placeholder="Ville..." className="w-32" value={cityFilter} onChange={setCityFilter} />
                        </div>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={() => setShowImportModal(true)} icon={Icons.Upload}>Importer</Button>
                            <Button icon={Icons.Plus} onClick={() => setShowAddModal(true)}>Ajouter</Button>
                        </div>
                    </div>

                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Contact</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Telephone</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Ville</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Categorie</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Compte</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Engagement</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Opt-in</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {contacts.length === 0 && <tr><td colSpan="8" className="py-8 text-center text-gray-500">Aucun contact</td></tr>}
                                    {contacts.map(contact => (
                                        <tr key={contact.id} className="hover:bg-gray-50">
                                            <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-bgfi-primary/10 rounded-full flex items-center justify-center text-bgfi-primary font-semibold">{(contact.name || '?').split(' ').map(n => n[0]).join('').substring(0,2)}</div><div><span className="font-medium text-gray-900 block">{contact.name || '-'}</span><span className="text-xs text-gray-500">{contact.email || ''}</span></div></div></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{contact.phone}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{contact.city || '-'}</td>
                                            <td className="py-4 px-4"><Badge variant={categoryVariant[contact.category] || 'default'}>{categoryMap[contact.category] || contact.category}</Badge></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{accountTypeMap[contact.accountType] || contact.accountType || '-'}</td>
                                            <td className="py-4 px-4"><div className="flex items-center gap-2"><div className="w-16 bg-gray-200 rounded-full h-2"><div className="h-2 rounded-full" style={{width: (contact.engagementScore || 0) + '%', backgroundColor: (contact.engagementScore || 0) >= 70 ? '#16a34a' : (contact.engagementScore || 0) >= 40 ? '#f59e0b' : '#ef4444'}} /></div><span className="text-xs text-gray-500">{contact.engagementScore || 0}</span></div></td>
                                            <td className="py-4 px-4"><Badge variant={contact.optedIn ? 'success' : 'danger'}>{contact.optedIn ? 'Oui' : 'Non'}</Badge></td>
                                            <td className="py-4 px-4 text-right"><div className="flex items-center justify-end gap-2"><Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(contact.id)} /></div></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {data?.pagination && <div className="mt-4 text-sm text-gray-500 text-center">{data.pagination.total} contacts au total</div>}
                    </Card>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Ajouter un Contact</h2>
                                    <button onClick={() => setShowAddModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom" placeholder="Jean Dupont" value={form.name} onChange={v => setForm({...form, name: v})} />
                                        <Input label="Telephone" placeholder="+24174000001" value={form.phone} onChange={v => setForm({...form, phone: v})} icon={Icons.Phone} />
                                    </div>
                                    <Input label="Email" placeholder="jean@email.com" value={form.email} onChange={v => setForm({...form, email: v})} icon={Icons.Mail} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Categorie" value={form.category} onChange={v => setForm({...form, category: v})} options={[{ value: 'ACTIVE', label: 'Actif' }, { value: 'INACTIVE', label: 'Inactif' }, { value: 'NEW', label: 'Nouveau' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                                        <Input label="Ville" placeholder="Libreville" value={form.city} onChange={v => setForm({...form, city: v})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Type de compte" value={form.accountType} onChange={v => setForm({...form, accountType: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'EPARGNE', label: 'Epargne' }, { value: 'COURANT', label: 'Courant' }, { value: 'PROFESSIONNEL', label: 'Professionnel' }, { value: 'JEUNE', label: 'Jeune' }]} />
                                        <Select label="Tranche d'age" value={form.ageRange} onChange={v => setForm({...form, ageRange: v})} options={[{ value: '', label: 'Selectionner...' }, { value: '18-25', label: '18-25 ans' }, { value: '26-35', label: '26-35 ans' }, { value: '36-45', label: '36-45 ans' }, { value: '46-55', label: '46-55 ans' }, { value: '56+', label: '56+ ans' }]} />
                                    </div>
                                    <Select label="Genre" value={form.gender} onChange={v => setForm({...form, gender: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'M', label: 'Masculin' }, { value: 'F', label: 'Feminin' }, { value: 'AUTRE', label: 'Autre' }]} />
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowAddModal(false)}>Annuler</Button>
                                    <Button onClick={handleCreate} disabled={creating || !form.phone} icon={Icons.CheckCircle}>{creating ? 'Ajout...' : 'Ajouter'}</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-lg w-full">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Importer des Contacts</h2>
                                    <button onClick={() => setShowImportModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-bgfi-primary hover:bg-blue-50 transition-colors cursor-pointer" onClick={() => document.getElementById('csv-upload').click()}>
                                        <input type="file" id="csv-upload" className="hidden" accept=".csv,.xlsx" onChange={handleImport} />
                                        <div className="w-16 h-16 bg-bgfi-primary/10 rounded-full flex items-center justify-center text-bgfi-primary mx-auto mb-4"><Icons.Upload /></div>
                                        <p className="font-medium text-gray-900">Deposez votre fichier ici</p>
                                        <p className="text-sm text-gray-500 mt-1">CSV ou Excel (max 10MB)</p>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-xl"><p className="text-sm font-medium text-gray-700 mb-2">Format attendu :</p><code className="text-xs text-gray-600 block">phone, name, email, category, city, accountType, ageRange, gender</code></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowImportModal(false)}>Fermer</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Segments View
        // =============================================
        const SegmentsView = () => {
            const { data, loading, error, refetch } = useApi('/segments?limit=50');
            const [showCreate, setShowCreate] = useState(false);
            const [form, setForm] = useState({ name: '', description: '', criteria: { operator: 'AND', rules: [] } });
            const [creating, setCreating] = useState(false);
            const [previewCount, setPreviewCount] = useState(null);

            const segments = data?.data || [];

            // Debounced preview
            const timer = React.useRef(null);
            React.useEffect(() => {
                if (form.criteria.rules.length === 0) { setPreviewCount(null); return; }
                clearTimeout(timer.current);
                timer.current = setTimeout(async () => {
                    try {
                        const res = await api('/segments/preview', { method: 'POST', body: JSON.stringify({ criteria: form.criteria }) });
                        setPreviewCount(res.contactCount);
                    } catch { setPreviewCount(null); }
                }, 500);
                return () => clearTimeout(timer.current);
            }, [form.criteria]);

            const handleCreate = async () => {
                setCreating(true);
                try {
                    await api('/segments', { method: 'POST', body: JSON.stringify(form) });
                    setShowCreate(false); setForm({ name: '', description: '', criteria: { operator: 'AND', rules: [] } }); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce segment ?')) return;
                try { await api('/segments/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const handleEvaluate = async (id) => {
                try { await api('/segments/' + id + '/evaluate', { method: 'POST' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <h2 className="text-xl font-bold text-gray-900">Segments de ciblage</h2>
                        <Button icon={Icons.Plus} onClick={() => setShowCreate(true)}>Nouveau Segment</Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {segments.length === 0 && <p className="text-gray-500 col-span-3 text-center py-8">Aucun segment. Creez-en un pour cibler vos campagnes.</p>}
                        {segments.map(seg => (
                            <Card key={seg.id} className="p-5">
                                <div className="flex items-start justify-between mb-3">
                                    <div className="flex items-center gap-2">
                                        <div className="w-10 h-10 bg-bgfi-primary/10 rounded-xl flex items-center justify-center text-bgfi-primary"><Icons.Layers /></div>
                                        <div>
                                            <p className="font-semibold text-gray-900">{seg.name}</p>
                                            <Badge variant={seg.type === 'DYNAMIC' ? 'info' : seg.type === 'BANK_CRITERIA' ? 'primary' : 'default'}>{seg.type}</Badge>
                                        </div>
                                    </div>
                                    <div className="flex gap-1">
                                        <Button variant="ghost" size="sm" icon={Icons.RefreshCw} onClick={() => handleEvaluate(seg.id)} title="Re-evaluer" />
                                        <Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(seg.id)} title="Supprimer" />
                                    </div>
                                </div>
                                {seg.description && <p className="text-sm text-gray-500 mb-3">{seg.description}</p>}
                                <div className="flex items-center justify-between text-sm">
                                    <span className="text-gray-500">Contacts</span>
                                    <span className="font-bold text-bgfi-primary">{seg.contactCount}</span>
                                </div>
                                {seg.lastEvaluatedAt && <p className="text-xs text-gray-400 mt-1">Evalue: {new Date(seg.lastEvaluatedAt).toLocaleDateString('fr-FR')}</p>}
                            </Card>
                        ))}
                    </div>

                    {showCreate && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Nouveau Segment</h2>
                                    <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <Input label="Nom du segment" placeholder="Ex: Clients actifs Libreville" value={form.name} onChange={v => setForm({...form, name: v})} />
                                    <Input label="Description" placeholder="Description optionnelle" value={form.description} onChange={v => setForm({...form, description: v})} />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Criteres de ciblage</label>
                                        <SegmentBuilder criteria={form.criteria} onChange={c => setForm({...form, criteria: c})} previewCount={previewCount} />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowCreate(false)}>Annuler</Button>
                                    <Button onClick={handleCreate} disabled={creating || !form.name || form.criteria.rules.length === 0} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Creer le segment'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Templates View
        // =============================================
        const TemplatesView = () => {
            const [showCreateModal, setShowCreateModal] = useState(false);
            const { data, loading, error, refetch } = useApi('/templates?limit=50');
            const [form, setForm] = useState({ name: '', displayName: '', category: '', content: '', language: 'fr' });
            const [creating, setCreating] = useState(false);

            const templates = data?.data || [];

            const handleCreate = async () => {
                setCreating(true);
                try {
                    await api('/templates', { method: 'POST', body: JSON.stringify(form) });
                    setShowCreateModal(false); setForm({ name: '', displayName: '', category: '', content: '', language: 'fr' }); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce template ?')) return;
                try { await api('/templates/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const [syncing, setSyncing] = useState(false);
            const handleSyncAll = async () => {
                setSyncing(true);
                try {
                    const result = await api('/templates/sync-all', { method: 'POST' });
                    alert(`Synchronisation terminee : ${result.synced} mis a jour, ${result.created} importes`);
                    refetch();
                } catch (err) { alert(err.message); }
                finally { setSyncing(false); }
            };

            const [dupModal, setDupModal] = useState(null);
            const [dupForm, setDupForm] = useState({ name: '', displayName: '', category: '', content: '' });
            const [duplicating, setDuplicating] = useState(false);

            const openDuplicate = (template) => {
                setDupForm({
                    name: template.name + '_v2',
                    displayName: (template.displayName || template.name) + ' (v2)',
                    category: template.category,
                    content: template.content
                });
                setDupModal(template);
            };

            const handleDuplicate = async () => {
                setDuplicating(true);
                try {
                    await api('/templates/' + dupModal.id + '/duplicate', { method: 'POST', body: JSON.stringify(dupForm) });
                    setDupModal(null); refetch();
                } catch (err) { alert(err.message); }
                finally { setDuplicating(false); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-4"><Input placeholder="Rechercher un template..." icon={Icons.Search} className="w-64" /></div>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={handleSyncAll} disabled={syncing} icon={Icons.RefreshCw}>{syncing ? 'Synchronisation...' : 'Sync Meta'}</Button>
                            <Button onClick={() => setShowCreateModal(true)} icon={Icons.Plus}>Nouveau Template</Button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {templates.length === 0 && <div className="col-span-2 text-center text-gray-500 py-8">Aucun template</div>}
                        {templates.map(template => (
                            <Card key={template.id}>
                                <div className="flex items-start justify-between mb-4">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${template.category === 'MARKETING' ? 'bg-purple-100 text-purple-600' : template.category === 'UTILITY' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}`}><Icons.FileText /></div>
                                        <div><p className="font-medium text-gray-900">{template.displayName || template.name}</p><p className="text-sm text-gray-500">{catMap[template.category] || template.category}</p></div>
                                    </div>
                                    <Badge variant={tplStatusVariant[template.status] || 'default'}>{tplStatusMap[template.status] || template.status}</Badge>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl mb-4"><p className="text-sm text-gray-700 whitespace-pre-line">{template.content}</p></div>
                                {template.variables && template.variables.length > 0 && <div className="mb-4 flex gap-1 flex-wrap">{template.variables.map((v, i) => <span key={i} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">{'{{'}{v}{'}}'}</span>)}</div>}
                                <div className="flex gap-2">
                                    <Button variant="ghost" size="sm" icon={Icons.Copy} onClick={() => openDuplicate(template)} title="Dupliquer" />
                                    <Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(template.id)} title="Supprimer" />
                                </div>
                            </Card>
                        ))}
                    </div>

                    {showCreateModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Nouveau Template WhatsApp</h2>
                                    <button onClick={() => setShowCreateModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom technique" placeholder="relance_connexion" value={form.name} onChange={v => setForm({...form, name: v})} />
                                        <Input label="Nom d'affichage" placeholder="Relance Connexion" value={form.displayName} onChange={v => setForm({...form, displayName: v})} />
                                    </div>
                                    <Select label="Categorie" value={form.category} onChange={v => setForm({...form, category: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'UTILITY', label: 'Utilitaire' }, { value: 'AUTHENTICATION', label: 'Authentification' }]} />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Contenu du message</label>
                                        <textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="6" placeholder="Bonjour {{1}} ! ..." value={form.content} onChange={(e) => setForm({...form, content: e.target.value})} />
                                        <p className="text-xs text-gray-500 mt-2">Utilisez {'{{1}}'}, {'{{2}}'}, etc. pour les variables.</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Note :</strong> Les templates doivent etre approuves par Meta avant utilisation (24-48h).</p></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowCreateModal(false)}>Annuler</Button>
                                    <Button onClick={handleCreate} disabled={creating || !form.name || !form.content} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Soumettre pour approbation'}</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {dupModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Dupliquer & Modifier le Template</h2>
                                    <button onClick={() => setDupModal(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-amber-50 p-4 rounded-xl"><p className="text-sm text-amber-800"><strong>Source :</strong> {dupModal.displayName || dupModal.name} ({tplStatusMap[dupModal.status] || dupModal.status})</p></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom technique" placeholder="relance_v2" value={dupForm.name} onChange={v => setDupForm({...dupForm, name: v})} />
                                        <Input label="Nom d'affichage" placeholder="Relance V2" value={dupForm.displayName} onChange={v => setDupForm({...dupForm, displayName: v})} />
                                    </div>
                                    <Select label="Categorie" value={dupForm.category} onChange={v => setDupForm({...dupForm, category: v})} options={[{ value: 'MARKETING', label: 'Marketing' }, { value: 'UTILITY', label: 'Utilitaire' }, { value: 'AUTHENTICATION', label: 'Authentification' }]} />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Contenu du message</label>
                                        <textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="6" value={dupForm.content} onChange={(e) => setDupForm({...dupForm, content: e.target.value})} />
                                        <p className="text-xs text-gray-500 mt-2">Modifiez le contenu puis soumettez. Utilisez {'{{1}}'}, {'{{2}}'}, etc. pour les variables.</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Note :</strong> Le nouveau template sera soumis a Meta pour approbation (24-48h).</p></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setDupModal(null)}>Annuler</Button>
                                    <Button onClick={handleDuplicate} disabled={duplicating || !dupForm.name || !dupForm.content} icon={Icons.Copy}>{duplicating ? 'Duplication...' : 'Dupliquer & Soumettre'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Analytics View
        // =============================================
        const AnalyticsView = () => {
            const { data: dash, loading, error, refetch } = useApi('/analytics/dashboard');
            const { data: campaignStats } = useApi('/analytics/campaigns?groupBy=month');
            const chartsRef = useRef({});

            useEffect(() => {
                if (!campaignStats?.data) return;
                Object.values(chartsRef.current).forEach(c => c.destroy && c.destroy());
                chartsRef.current = {};
                const ctx1 = document.getElementById('performanceChart');
                const ctx2 = document.getElementById('channelsChart');
                if (ctx1) {
                    const items = campaignStats.data.slice(-6);
                    const labels = items.map(d => d.date || '-');
                    chartsRef.current.c1 = new Chart(ctx1, { type: 'bar', data: { labels, datasets: [{ label: 'Envoyes', data: items.map(d => d.sent || 0), backgroundColor: '#1e3a5f' }, { label: 'Delivres', data: items.map(d => d.delivered || 0), backgroundColor: '#00a86b' }, { label: 'Lus', data: items.map(d => d.read || 0), backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false } });
                }
                if (ctx2 && dash) {
                    const o = dash.overview || {};
                    chartsRef.current.c2 = new Chart(ctx2, { type: 'pie', data: { labels: ['WhatsApp'], datasets: [{ data: [100], backgroundColor: ['#00a86b'] }] }, options: { responsive: true, maintainAspectRatio: false } });
                }
            }, [campaignStats, dash]);

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;
            if (!dash) return null;

            const o = dash.overview || {};

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <Button variant="secondary" size="sm">30 jours</Button>
                            <Button variant="ghost" size="sm">90 jours</Button>
                        </div>
                        <Button variant="secondary" size="sm" icon={Icons.Download} onClick={async () => { try { const blob = await api('/analytics/export?format=csv'); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'analytics.csv'; a.click(); } catch(e) { alert(e.message); } }}>Exporter le rapport</Button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Total Messages" value={formatNum(o.totalMessages || 0)} icon={Icons.MessageSquare} color="blue" />
                        <StatCard title="Taux de Delivrance" value={(o.deliveryRate || 0).toFixed(1) + '%'} icon={Icons.CheckCircle} color="green" />
                        <StatCard title="Taux d'Ouverture" value={(o.openRate || 0).toFixed(1) + '%'} icon={Icons.Eye} color="purple" />
                        <StatCard title="Taux de Conversion" value={(o.clickRate || 0).toFixed(1) + '%'} icon={Icons.TrendingUp} color="amber" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <Card className="lg:col-span-2" title="Performance des Campagnes"><div className="h-72"><canvas id="performanceChart" /></div></Card>
                        <Card title="Canal Principal">
                            <div className="h-48"><canvas id="channelsChart" /></div>
                            <div className="mt-4 space-y-2">
                                <div className="flex justify-between text-sm"><span className="text-gray-600">WhatsApp</span><span className="font-medium text-emerald-600">100%</span></div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // =============================================
        // Settings View
        // =============================================
        const SettingsView = () => {
            const { data: health } = useApi('/health');

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card title="Informations Generales">
                            <div className="space-y-4">
                                <Input label="Nom de l'organisation" value="BGFI Bank" />
                                <Input label="Email de contact" value="marketing@bgfi.ga" />
                                <Input label="Telephone" value="+241 01 74 12 34" />
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">Adresse</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="3" defaultValue="Boulevard Triomphal, Libreville, Gabon" /></div>
                            </div>
                        </Card>
                        <Card title="Etat des Services">
                            <div className="space-y-3">
                                {health?.services && Object.entries(health.services).map(([name, ok]) => (
                                    <div key={name} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                        <span className="text-sm font-medium text-gray-700 capitalize">{name}</span>
                                        <Badge variant={ok ? 'success' : 'danger'}>{ok ? 'Connecte' : 'Non configure'}</Badge>
                                    </div>
                                ))}
                                {health && <div className="mt-3 p-3 bg-blue-50 rounded-xl"><p className="text-xs text-blue-700">Version: {health.version} | Env: {health.environment} | {health.timestamp ? new Date(health.timestamp).toLocaleString('fr-FR') : ''}</p></div>}
                            </div>
                        </Card>
                    </div>
                    <Card title="Configuration WhatsApp">
                        <div className="space-y-4">
                            <div className="flex items-center justify-between p-4 rounded-xl" style={{ background: health?.services?.whatsapp ? '#ecfdf5' : '#fef2f2' }}>
                                <div className="flex items-center gap-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white ${health?.services?.whatsapp ? 'bg-emerald-500' : 'bg-red-400'}`}>{health?.services?.whatsapp ? <Icons.CheckCircle /> : <Icons.X />}</div>
                                    <div><p className="font-medium text-gray-900">{health?.services?.whatsapp ? 'WhatsApp Cloud API connectee' : 'WhatsApp non configure'}</p><p className="text-sm text-gray-500">{health?.services?.whatsapp ? 'API Meta connectee' : 'Configurez WHATSAPP_ACCESS_TOKEN dans Netlify'}</p></div>
                                </div>
                            </div>
                        </div>
                    </Card>
                    <div className="flex justify-end gap-3">
                        <Button icon={Icons.CheckCircle}>Sauvegarder les modifications</Button>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<BGFIWhatsAppSaaS />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGFI WhatsApp Marketing SaaS</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.15.3/umd/Recharts.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        bgfi: { primary: '#1e3a5f', secondary: '#2d5a87', accent: '#00a86b', light: '#f8fafc', dark: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-indicator span { animation: typing 1.4s infinite; display: inline-block; width: 8px; height: 8px; background: #9ca3af; border-radius: 50%; margin: 0 2px; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-10px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend, PieChart, Pie, Sector, Cell, BarChart, Bar, Rectangle } = Recharts;

        // =============================================
        // API Layer
        // =============================================
        const API_BASE = '/api';

        const authStore = {
            getToken: () => localStorage.getItem('bgfi_token'),
            setToken: (t) => localStorage.setItem('bgfi_token', t),
            getUser: () => { try { return JSON.parse(localStorage.getItem('bgfi_user')); } catch(e) { return null; } },
            setUser: (u) => localStorage.setItem('bgfi_user', JSON.stringify(u)),
            clear: () => { localStorage.removeItem('bgfi_token'); localStorage.removeItem('bgfi_user'); },
        };

        const api = async (endpoint, options = {}) => {
            const token = authStore.getToken();
            const headers = { ...options.headers };
            if (token) headers['Authorization'] = 'Bearer ' + token;
            if (!(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
            const res = await fetch(API_BASE + endpoint, { ...options, headers });
            if (res.status === 401) { authStore.clear(); window.location.reload(); return; }
            const contentType = res.headers.get('content-type');
            if (contentType && contentType.includes('text/csv')) return res.blob();
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.error || data.message || 'Erreur ' + res.status);
            return data;
        };

        const useApi = (endpoint, autoFetch = true) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(autoFetch);
            const [error, setError] = useState(null);
            const fetchData = useCallback(async () => {
                setLoading(true); setError(null);
                try { const result = await api(endpoint); setData(result); }
                catch (err) { setError(err.message); }
                finally { setLoading(false); }
            }, [endpoint]);
            useEffect(() => { if (autoFetch) fetchData(); }, [fetchData, autoFetch]);
            return { data, loading, error, refetch: fetchData };
        };

        const formatNum = (n) => {
            if (!n && n !== 0) return '0';
            if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n/1000).toFixed(1) + 'K';
            return n.toLocaleString('fr-FR');
        };

        const statusMap = { DRAFT: 'Brouillon', SCHEDULED: 'Planifiee', RUNNING: 'En cours', COMPLETED: 'Terminee', CANCELLED: 'Annulee', SENT: 'Envoye' };
        const statusVariant = { DRAFT: 'default', SCHEDULED: 'warning', RUNNING: 'info', COMPLETED: 'success', CANCELLED: 'danger' };
        const categoryMap = { ALL: 'Tous', ACTIVE: 'Actif', INACTIVE: 'Inactif', VIP: 'VIP', NEW: 'Nouveau', PREMIUM: 'Premium' };
        const categoryVariant = { ALL: 'default', ACTIVE: 'success', INACTIVE: 'warning', VIP: 'primary', NEW: 'info', PREMIUM: 'primary' };
        const accountTypeMap = { EPARGNE: 'Epargne', COURANT: 'Courant', PROFESSIONNEL: 'Professionnel', JEUNE: 'Jeune' };
        const catMap = { MARKETING: 'Marketing', UTILITY: 'Utilitaire', AUTHENTICATION: 'Authentification', REACTIVATION: 'Reactivation', NOTIFICATION: 'Notification' };
        const tplStatusMap = { PENDING: 'En attente', APPROVED: 'Approuve', REJECTED: 'Rejete' };
        const tplStatusVariant = { PENDING: 'warning', APPROVED: 'success', REJECTED: 'danger' };

        // =============================================
        // Icons
        // =============================================
        const Icons = {
            LayoutDashboard: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Send: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9"/></svg>,
            MessageSquare: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Users: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            FileText: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>,
            BarChart3: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Search: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>,
            Filter: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="22,3 2,3 10,12.46 10,19 14,21 14,12.46 22,3"/></svg>,
            MoreVertical: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>,
            Upload: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Bot: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>,
            Trash2: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Edit: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="5,3 19,12 5,21 5,3"/></svg>,
            CheckCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22,4 12,14.01 9,11.01"/></svg>,
            Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>,
            TrendingUp: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23,6 13.5,15.5 8.5,10.5 1,18"/><polyline points="17,6 23,6 23,12"/></svg>,
            Eye: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            MousePointer: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>,
            Download: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Database: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>,
            Sparkles: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Menu: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            X: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Phone: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>,
            Mail: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
            Calendar: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            RefreshCw: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>,
            Copy: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            LogOut: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            ArrowLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12,19 5,12 12,5"/></svg>,
            Layers: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="12,2 2,7 12,12 22,7"/><polyline points="2,17 12,22 22,17"/><polyline points="2,12 12,17 22,12"/></svg>,
            MapPin: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            ChevronRight: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="9,18 15,12 9,6"/></svg>,
            ChevronLeft: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="15,18 9,12 15,6"/></svg>,
            Target: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
        };

        // =============================================
        // UI Components
        // =============================================
        const Button = ({ children, onClick, variant = 'primary', size = 'md', className = '', disabled = false, icon: Icon, type = 'button' }) => {
            const baseClasses = 'inline-flex items-center justify-center gap-2 font-medium rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed';
            const variants = { primary: 'bg-bgfi-primary text-white hover:bg-bgfi-secondary shadow-md hover:shadow-lg', secondary: 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 shadow-sm', accent: 'bg-bgfi-accent text-white hover:bg-emerald-600 shadow-md hover:shadow-lg', danger: 'bg-red-500 text-white hover:bg-red-600 shadow-md', ghost: 'text-gray-600 hover:bg-gray-100 hover:text-gray-900' };
            const sizes = { sm: 'px-3 py-1.5 text-sm', md: 'px-4 py-2 text-sm', lg: 'px-6 py-3 text-base' };
            return <button type={type} onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${sizes[size]} ${className}`}>{Icon && <Icon />}{children}</button>;
        };

        const Card = ({ children, className = '', title, action }) => (
            <div className={`bg-white rounded-xl card-shadow hover-lift ${className}`}>
                {(title || action) && <div className="flex items-center justify-between px-6 py-4 border-b border-gray-100">{title && <h3 className="text-lg font-semibold text-gray-900">{title}</h3>}{action && <div>{action}</div>}</div>}
                <div className="p-6">{children}</div>
            </div>
        );

        const Badge = ({ children, variant = 'default' }) => {
            const variants = { default: 'bg-gray-100 text-gray-700', success: 'bg-emerald-100 text-emerald-700', warning: 'bg-amber-100 text-amber-700', danger: 'bg-red-100 text-red-700', info: 'bg-blue-100 text-blue-700', primary: 'bg-bgfi-primary text-white' };
            return <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${variants[variant]}`}>{children}</span>;
        };

        const Input = ({ label, type = 'text', placeholder, value, onChange, className = '', icon: Icon }) => (
            <div className={`space-y-1 ${className}`}>
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <div className="relative">{Icon && <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon /></div>}<input type={type} value={value} onChange={(e) => onChange && onChange(e.target.value)} placeholder={placeholder} className={`block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm ${Icon ? 'pl-10' : 'px-4'} py-2.5 border`} /></div>
            </div>
        );

        const Select = ({ label, value, onChange, options, className = '' }) => (
            <div className={`space-y-1 ${className}`}>
                {label && <label className="block text-sm font-medium text-gray-700">{label}</label>}
                <select value={value} onChange={(e) => onChange && onChange(e.target.value)} className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-2.5 border">{options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select>
            </div>
        );

        const ProgressBar = ({ value, max = 100, color = 'bg-bgfi-primary', size = 'md' }) => {
            const percentage = Math.min((value / max) * 100, 100);
            const sizes = { sm: 'h-1.5', md: 'h-2', lg: 'h-3' };
            return <div className={`w-full bg-gray-200 rounded-full ${sizes[size]}`}><div className={`${color} rounded-full transition-all duration-500 ${sizes[size]}`} style={{ width: `${percentage}%` }} /></div>;
        };

        const StatCard = ({ title, value, change, changeType = 'positive', icon: Icon, color = 'blue' }) => {
            const colors = { blue: 'bg-blue-50 text-blue-600', green: 'bg-emerald-50 text-emerald-600', amber: 'bg-amber-50 text-amber-600', purple: 'bg-purple-50 text-purple-600', red: 'bg-red-50 text-red-600' };
            return <Card className="h-full"><div className="flex items-start justify-between"><div><p className="text-sm font-medium text-gray-600">{title}</p><p className="text-2xl font-bold text-gray-900 mt-1">{value}</p>{change !== undefined && <div className="flex items-center mt-2"><span className={`text-sm font-medium ${changeType === 'positive' ? 'text-emerald-600' : 'text-red-600'}`}>{changeType === 'positive' ? '+' : ''}{change}%</span><span className="text-sm text-gray-500 ml-1">vs mois dernier</span></div>}</div>{Icon && <div className={`p-3 rounded-xl ${colors[color]}`}><Icon /></div>}</div></Card>;
        };

        const Spinner = () => <div className="flex items-center justify-center p-12"><div className="w-10 h-10 border-4 border-bgfi-primary border-t-transparent rounded-full animate-spin" /></div>;

        const ErrorBox = ({ message, onRetry }) => (
            <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
                <p className="text-red-700 mb-3">{message}</p>
                {onRetry && <Button variant="danger" size="sm" onClick={onRetry}>Reessayer</Button>}
            </div>
        );

        // =============================================
        // Login Page
        // =============================================
        const LoginPage = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault(); setError(''); setLoading(true);
                try {
                    const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email, password }) });
                    authStore.setToken(data.token); authStore.setUser(data.user);
                    onLogin(data.user);
                } catch (err) { setError(err.message || 'Identifiants invalides'); }
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
                    <div className="max-w-md w-full">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 rounded-2xl overflow-hidden mx-auto mb-4"><img src="/favicon.png" alt="BGFI" className="w-full h-full object-cover" /></div>
                            <h1 className="text-2xl font-bold text-gray-900">BGFI Marketing</h1>
                            <p className="text-gray-500 mt-1">WhatsApp SaaS Platform</p>
                        </div>
                        <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-lg p-8 space-y-6">
                            {error && <div className="bg-red-50 text-red-700 px-4 py-3 rounded-xl text-sm">{error}</div>}
                            <Input label="Email" type="email" placeholder="admin@bgfi.ga" value={email} onChange={setEmail} icon={Icons.Mail} />
                            <Input label="Mot de passe" type="password" placeholder="********" value={password} onChange={setPassword} />
                            <Button type="submit" className="w-full" size="lg" disabled={loading}>{loading ? 'Connexion...' : 'Se connecter'}</Button>
                        </form>
                        <p className="text-center text-xs text-gray-400 mt-6">BGFI WhatsApp Marketing SaaS v1.0</p>
                    </div>
                </div>
            );
        };

        // =============================================
        // Main App
        // =============================================
        const BGFIWhatsAppSaaS = () => {
            const [user, setUser] = useState(authStore.getUser());
            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);

            if (!user) return <LoginPage onLogin={setUser} />;

            const handleLogout = () => { authStore.clear(); setUser(null); };

            const menuItems = [
                { id: 'dashboard', label: 'Tableau de bord', icon: Icons.LayoutDashboard },
                { id: 'campaigns', label: 'Campagnes', icon: Icons.Send },
                { id: 'segments', label: 'Segments', icon: Icons.Layers },
                { id: 'chatbot', label: 'Chatbot RAG', icon: Icons.Bot },
                { id: 'conversations', label: 'Conversations', icon: Icons.MessageSquare },
                { id: 'contacts', label: 'Contacts', icon: Icons.Users },
                { id: 'templates', label: 'Templates', icon: Icons.FileText },
                { id: 'analytics', label: 'Analytics', icon: Icons.BarChart3 },
                { id: 'settings', label: 'Parametres', icon: Icons.Settings },
            ];

            const renderContent = () => {
                switch (activeTab) {
                    case 'dashboard': return <DashboardView onNavigate={setActiveTab} />;
                    case 'campaigns': return <CampaignsView />;
                    case 'segments': return <SegmentsView />;
                    case 'chatbot': return <ChatbotView />;
                    case 'conversations': return <ConversationsView />;
                    case 'contacts': return <ContactsView />;
                    case 'templates': return <TemplatesView />;
                    case 'analytics': return <AnalyticsView />;
                    case 'settings': return <SettingsView />;
                    default: return <DashboardView onNavigate={setActiveTab} />;
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 flex">
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 lg:translate-x-0 lg:static lg:inset-0 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="flex items-center justify-between h-16 px-6 border-b border-gray-200">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl overflow-hidden"><img src="/favicon.png" alt="BGFI" className="w-full h-full object-cover" /></div>
                                <div><h1 className="font-bold text-gray-900 text-sm">BGFI Marketing</h1><p className="text-xs text-gray-500">WhatsApp SaaS</p></div>
                            </div>
                            <button onClick={() => setSidebarOpen(false)} className="lg:hidden text-gray-500 hover:text-gray-700"><Icons.X /></button>
                        </div>
                        <nav className="p-4 space-y-1">
                            {menuItems.map(item => (
                                <button key={item.id} onClick={() => { setActiveTab(item.id); setSidebarOpen(false); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${activeTab === item.id ? 'bg-bgfi-primary text-white shadow-md' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}`}>
                                    <item.icon />{item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
                            <div className="flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-xl">
                                <div className="w-10 h-10 bg-bgfi-accent rounded-full flex items-center justify-center text-white font-semibold">{(user.name || 'U').substring(0, 2).toUpperCase()}</div>
                                <div className="flex-1 min-w-0"><p className="text-sm font-medium text-gray-900 truncate">{user.name}</p><p className="text-xs text-gray-500 truncate">{user.email}</p></div>
                                <button onClick={handleLogout} className="p-1.5 text-gray-400 hover:text-red-500 rounded-lg hover:bg-red-50" title="Deconnexion"><Icons.LogOut /></button>
                            </div>
                        </div>
                    </aside>

                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-4 lg:px-8">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setSidebarOpen(true)} className="lg:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"><Icons.Menu /></button>
                                <h2 className="text-xl font-semibold text-gray-900">{menuItems.find(item => item.id === activeTab)?.label}</h2>
                            </div>
                            <div className="flex items-center gap-3">
                                <button className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg relative"><Icons.MessageSquare /><span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full" /></button>
                                <button onClick={() => setActiveTab('settings')} className="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg"><Icons.Settings /></button>
                            </div>
                        </header>
                        <main className="flex-1 overflow-auto p-4 lg:p-8"><div className="max-w-7xl mx-auto animate-fade-in">{renderContent()}</div></main>
                    </div>
                </div>
            );
        };

        // =============================================
        // Dashboard View
        // =============================================
        // Demo data for the interactive area chart (90 days)
        const generateChartData = () => {
            const data = [];
            const now = new Date();
            for (let i = 89; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const base = Math.floor(Math.random() * 80) + 20;
                const sent = Math.floor(base + Math.random() * 150);
                const delivered = Math.floor(sent * (0.82 + Math.random() * 0.15));
                const read = Math.floor(delivered * (0.45 + Math.random() * 0.35));
                data.push({ date: dateStr, envoyes: sent, delivres: delivered, lus: read });
            }
            return data;
        };
        const DEMO_CHART_DATA = generateChartData();

        const DashboardView = ({ onNavigate }) => {
            const { data: dash, loading, error, refetch } = useApi('/analytics/dashboard');
            const { data: contactStats } = useApi('/contacts/stats/overview');
            const [timeRange, setTimeRange] = useState('7j');
            const [activePieIndex, setActivePieIndex] = useState(0);

            const filteredChartData = useMemo(() => {
                const days = timeRange === '7j' ? 7 : timeRange === '30j' ? 30 : 90;
                return DEMO_CHART_DATA.slice(-days);
            }, [timeRange]);

            const radialData = useMemo(() => {
                if (!contactStats?.byCategory) return [];
                const colors = { ACTIVE: '#00a86b', VIP: '#1e3a5f', PREMIUM: '#3b82f6', NEW: '#f59e0b', INACTIVE: '#ef4444' };
                const labels = { ACTIVE: 'Actifs', VIP: 'VIP', PREMIUM: 'Premium', NEW: 'Nouveaux', INACTIVE: 'Inactifs' };
                return Object.entries(contactStats.byCategory)
                    .filter(([k]) => k !== 'ALL')
                    .map(([key, count]) => ({ name: labels[key] || key, value: count, fill: colors[key] || '#9ca3af' }))
                    .sort((a, b) => b.value - a.value);
            }, [contactStats]);

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;
            if (!dash) return null;

            const o = dash.overview || {};
            const c = dash.campaigns || {};
            const recent = dash.recentCampaigns || [];

            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <StatCard title="Campagnes Actives" value={c.active || 0} icon={Icons.Send} color="blue" />
                        <StatCard title="Messages Envoyes" value={formatNum(o.totalMessages || 0)} icon={Icons.MessageSquare} color="green" />
                        <StatCard title="Taux d'Ouverture" value={(o.openRate || 0).toFixed(1) + '%'} icon={Icons.Eye} color="purple" />
                        <StatCard title="Taux de Clic" value={(o.clickRate || 0).toFixed(1) + '%'} icon={Icons.MousePointer} color="amber" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="flex items-center justify-between p-6 pb-0">
                                <div>
                                    <h3 className="text-lg font-semibold text-gray-900">Activite des Messages</h3>
                                    <p className="text-sm text-gray-500 mt-0.5">Messages envoyes, delivres et lus</p>
                                </div>
                                <select value={timeRange} onChange={e => setTimeRange(e.target.value)} className="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-bgfi-primary/20">
                                    <option value="7j">7 derniers jours</option>
                                    <option value="30j">30 derniers jours</option>
                                    <option value="90j">3 derniers mois</option>
                                </select>
                            </div>
                            <div className="p-6 pt-4" style={{ height: 300 }}>
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={filteredChartData} margin={{ top: 5, right: 10, left: 0, bottom: 0 }}>
                                        <defs>
                                            <linearGradient id="gradEnvoyes" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#1e3a5f" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#1e3a5f" stopOpacity={0} />
                                            </linearGradient>
                                            <linearGradient id="gradDelivres" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#00a86b" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#00a86b" stopOpacity={0} />
                                            </linearGradient>
                                            <linearGradient id="gradLus" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" vertical={false} />
                                        <XAxis dataKey="date" tickLine={false} axisLine={false} tickMargin={8} minTickGap={32} tick={{ fontSize: 12, fill: '#9ca3af' }} tickFormatter={v => { const d = new Date(v); return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }); }} />
                                        <YAxis tickLine={false} axisLine={false} tick={{ fontSize: 12, fill: '#9ca3af' }} width={40} />
                                        <Tooltip contentStyle={{ borderRadius: 12, border: '1px solid #e5e7eb', boxShadow: '0 4px 12px rgba(0,0,0,0.08)', fontSize: 13 }} labelFormatter={v => new Date(v).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })} />
                                        <Area type="monotone" dataKey="envoyes" name="Envoyes" stroke="#1e3a5f" fill="url(#gradEnvoyes)" strokeWidth={2} dot={false} />
                                        <Area type="monotone" dataKey="delivres" name="Delivres" stroke="#00a86b" fill="url(#gradDelivres)" strokeWidth={2} dot={false} />
                                        <Area type="monotone" dataKey="lus" name="Lus" stroke="#3b82f6" fill="url(#gradLus)" strokeWidth={2} dot={false} />
                                        <Legend iconType="circle" wrapperStyle={{ fontSize: 13, paddingTop: 8 }} />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col">
                            <div className="p-6 pb-2 text-center">
                                <h3 className="text-lg font-semibold text-gray-900">Contacts par Categorie</h3>
                                <p className="text-sm text-gray-500 mt-0.5">{contactStats?.total || 0} contacts au total</p>
                            </div>
                            <div className="flex-1 px-2 pb-0" style={{ minHeight: 220 }}>
                                {radialData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height={220}>
                                        <PieChart>
                                            <Pie
                                                data={radialData}
                                                cx="50%"
                                                cy="50%"
                                                innerRadius={55}
                                                outerRadius={80}
                                                dataKey="value"
                                                activeIndex={activePieIndex}
                                                activeShape={(props) => {
                                                    const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill, payload, value } = props;
                                                    return (
                                                        <g>
                                                            <text x={cx} y={cy - 4} textAnchor="middle" dominantBaseline="central" style={{ fontSize: 24, fontWeight: 700, fill: fill }}>{value}</text>
                                                            <text x={cx} y={cy + 18} textAnchor="middle" dominantBaseline="central" style={{ fontSize: 12, fill: '#6b7280' }}>{payload.name}</text>
                                                            <Sector cx={cx} cy={cy} innerRadius={innerRadius - 4} outerRadius={outerRadius + 6} startAngle={startAngle} endAngle={endAngle} fill={fill} />
                                                            <Sector cx={cx} cy={cy} innerRadius={outerRadius + 10} outerRadius={outerRadius + 14} startAngle={startAngle} endAngle={endAngle} fill={fill} />
                                                        </g>
                                                    );
                                                }}
                                                onMouseEnter={(_, index) => setActivePieIndex(index)}
                                            >
                                                {radialData.map((entry, index) => (
                                                    <Cell key={index} fill={entry.fill} stroke="none" />
                                                ))}
                                            </Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                ) : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Chargement...</div>}
                            </div>
                            <div className="px-6 pb-5 pt-1 space-y-1.5">
                                {radialData.map((d, i) => (
                                    <div key={d.name} className={`flex items-center justify-between text-sm px-2 py-1 rounded-lg cursor-pointer transition-colors ${i === activePieIndex ? 'bg-gray-50' : ''}`} onMouseEnter={() => setActivePieIndex(i)}>
                                        <div className="flex items-center gap-2">
                                            <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: d.fill }} />
                                            <span className="text-gray-600">{d.name}</span>
                                        </div>
                                        <span className="font-medium text-gray-900">{d.value}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card title="Campagnes Recentes" action={<Button variant="ghost" size="sm" onClick={() => onNavigate('campaigns')}>Voir tout</Button>}>
                            <div className="space-y-4">
                                {recent.length === 0 && <p className="text-sm text-gray-500 text-center py-4">Aucune campagne recente</p>}
                                {recent.slice(0, 3).map(campaign => (
                                    <div key={campaign.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                                        <div className="flex items-center gap-4">
                                            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${campaign.status === 'COMPLETED' ? 'bg-emerald-100 text-emerald-600' : campaign.status === 'RUNNING' ? 'bg-blue-100 text-blue-600' : campaign.status === 'SCHEDULED' ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-600'}`}>
                                                {campaign.status === 'COMPLETED' ? <Icons.CheckCircle /> : campaign.status === 'RUNNING' ? <Icons.Play /> : campaign.status === 'SCHEDULED' ? <Icons.Clock /> : <Icons.FileText />}
                                            </div>
                                            <div><p className="font-medium text-gray-900">{campaign.name}</p><p className="text-sm text-gray-500">{new Date(campaign.createdAt).toLocaleDateString('fr-FR')}</p></div>
                                        </div>
                                        <Badge variant={statusVariant[campaign.status] || 'default'}>{statusMap[campaign.status] || campaign.status}</Badge>
                                    </div>
                                ))}
                            </div>
                        </Card>
                        <Card title="Actions Rapides">
                            <div className="grid grid-cols-2 gap-4">
                                <button onClick={() => onNavigate('campaigns')} className="p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-bgfi-primary rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Plus /></div>
                                    <p className="font-semibold text-gray-900">Nouvelle Campagne</p><p className="text-sm text-gray-600 mt-1">Creer une campagne WhatsApp</p>
                                </button>
                                <button onClick={() => onNavigate('contacts')} className="p-6 bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-bgfi-accent rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Upload /></div>
                                    <p className="font-semibold text-gray-900">Importer Contacts</p><p className="text-sm text-gray-600 mt-1">CSV ou Excel</p>
                                </button>
                                <button onClick={() => onNavigate('chatbot')} className="p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.Bot /></div>
                                    <p className="font-semibold text-gray-900">Configurer Chatbot</p><p className="text-sm text-gray-600 mt-1">RAG & Base de connaissances</p>
                                </button>
                                <button onClick={() => onNavigate('templates')} className="p-6 bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl text-left hover:shadow-md transition-all group">
                                    <div className="w-12 h-12 bg-amber-600 rounded-xl flex items-center justify-center text-white mb-4 group-hover:scale-110 transition-transform"><Icons.FileText /></div>
                                    <p className="font-semibold text-gray-900">Nouveau Template</p><p className="text-sm text-gray-600 mt-1">Message WhatsApp</p>
                                </button>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // =============================================
        // Campaigns View
        // =============================================
        const msgStatusMap = { PENDING: 'En attente', QUEUED: 'En file', SENT: 'Envoye', DELIVERED: 'Delivre', READ: 'Lu', FAILED: 'Echoue' };
        const msgStatusVariant = { PENDING: 'default', QUEUED: 'default', SENT: 'info', DELIVERED: 'success', READ: 'primary', FAILED: 'danger' };

        const CampaignDetailView = ({ campaign, onBack, onSend, templates }) => {
            const { data: msgData, loading: msgLoading } = useApi('/campaigns/' + campaign.id + '/messages?limit=500');
            const messages = msgData?.data || [];

            const c = campaign;
            const totalSent = c.sent || 0;
            const deliveryRate = totalSent > 0 ? ((c.delivered / totalSent) * 100).toFixed(1) : 0;
            const openRate = c.delivered > 0 ? ((c.read / c.delivered) * 100).toFixed(1) : 0;
            const clickRate = c.read > 0 ? ((c.clicked / c.read) * 100).toFixed(1) : 0;

            const [statusFilter, setStatusFilter] = useState('');
            const filtered = statusFilter ? messages.filter(m => m.status === statusFilter) : messages;

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-4">
                        <Button variant="ghost" icon={Icons.ArrowLeft} onClick={onBack}>Retour aux campagnes</Button>
                    </div>

                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-bgfi-primary/10 rounded-xl flex items-center justify-center text-bgfi-primary"><Icons.Send /></div>
                            <div>
                                <h2 className="text-2xl font-bold text-gray-900">{c.name}</h2>
                                <p className="text-sm text-gray-500">{catMap[c.type] || c.type} - {c.segmentRef?.name || categoryMap[c.legacySegment] || 'Tous'} - Template: {c.template?.displayName || c.template?.name || '-'}</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-3">
                            <Badge variant={statusVariant[c.status] || 'default'}>{statusMap[c.status] || c.status}</Badge>
                            {c.status === 'DRAFT' && <Button variant="accent" size="sm" icon={Icons.Play} onClick={() => onSend(c.id)}>Lancer</Button>}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-5 gap-4">
                        <Card className="text-center"><p className="text-2xl font-bold text-blue-700">{formatNum(totalSent)}</p><p className="text-xs text-blue-600 mt-1">Envoyes</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-green-700">{formatNum(c.delivered || 0)}</p><p className="text-xs text-green-600 mt-1">Delivres ({deliveryRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-purple-700">{formatNum(c.read || 0)}</p><p className="text-xs text-purple-600 mt-1">Lus ({openRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-amber-700">{formatNum(c.clicked || 0)}</p><p className="text-xs text-amber-600 mt-1">Cliques ({clickRate}%)</p></Card>
                        <Card className="text-center"><p className="text-2xl font-bold text-red-700">{formatNum(c.failed || 0)}</p><p className="text-xs text-red-600 mt-1">Echoues</p></Card>
                    </div>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div className="text-sm"><span className="text-gray-500">Creee le</span><p className="font-medium text-gray-900">{c.createdAt ? new Date(c.createdAt).toLocaleString('fr-FR') : '-'}</p></div>
                        <div className="text-sm"><span className="text-gray-500">Lancee le</span><p className="font-medium text-gray-900">{c.startedAt ? new Date(c.startedAt).toLocaleString('fr-FR') : '-'}</p></div>
                        <div className="text-sm"><span className="text-gray-500">Terminee le</span><p className="font-medium text-gray-900">{c.completedAt ? new Date(c.completedAt).toLocaleString('fr-FR') : '-'}</p></div>
                        {c.scheduledAt && <div className="text-sm"><span className="text-gray-500">Planifiee le</span><p className="font-medium text-gray-900">{new Date(c.scheduledAt).toLocaleString('fr-FR')}</p></div>}
                    </div>

                    <Card>
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-900">Detail des envois ({filtered.length})</h3>
                            <div className="flex gap-2">
                                <select className="text-sm border border-gray-300 rounded-lg px-3 py-2" value={statusFilter} onChange={e => setStatusFilter(e.target.value)}>
                                    <option value="">Tous les statuts</option>
                                    <option value="SENT">Envoyes</option>
                                    <option value="DELIVERED">Delivres</option>
                                    <option value="READ">Lus</option>
                                    <option value="FAILED">Echoues</option>
                                    <option value="PENDING">En attente</option>
                                </select>
                            </div>
                        </div>
                        {msgLoading ? <Spinner /> : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead>
                                    <tr className="border-b border-gray-200">
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Contact</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Telephone</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Statut</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date d'envoi</th>
                                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Erreur</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {filtered.length === 0 && <tr><td colSpan="5" className="py-8 text-center text-gray-500">Aucun message</td></tr>}
                                    {filtered.map(m => (
                                        <tr key={m.id} className="hover:bg-gray-50">
                                            <td className="py-3 px-4">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-500 text-xs font-medium">{(m.contact?.name || '?')[0].toUpperCase()}</div>
                                                    <span className="text-sm font-medium text-gray-900">{m.contact?.name || '-'}</span>
                                                </div>
                                            </td>
                                            <td className="py-3 px-4 text-sm text-gray-600 font-mono">{m.contact?.phone || '-'}</td>
                                            <td className="py-3 px-4"><Badge variant={msgStatusVariant[m.status] || 'default'}>{msgStatusMap[m.status] || m.status}</Badge></td>
                                            <td className="py-3 px-4 text-sm text-gray-500">{m.sentAt ? new Date(m.sentAt).toLocaleString('fr-FR') : m.createdAt ? new Date(m.createdAt).toLocaleString('fr-FR') : '-'}</td>
                                            <td className="py-3 px-4 text-sm text-red-600">{m.error || ''}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        )}
                    </Card>
                </div>
            );
        };

        // =============================================
        // Segment Builder Component
        // =============================================
        const SEGMENT_FIELDS = [
            { name: 'category', label: 'Categorie', type: 'select', group: 'PROFIL', options: ['ALL', 'ACTIVE', 'INACTIVE', 'NEW', 'PREMIUM', 'VIP'] },
            { name: 'city', label: 'Ville', type: 'text', group: 'PROFIL' },
            { name: 'country', label: 'Pays', type: 'text', group: 'PROFIL' },
            { name: 'ageRange', label: "Tranche d'age", type: 'select', group: 'PROFIL', options: ['18-25', '26-35', '36-45', '46-55', '56+'] },
            { name: 'gender', label: 'Genre', type: 'select', group: 'PROFIL', options: ['M', 'F', 'AUTRE'] },
            { name: 'language', label: 'Langue', type: 'select', group: 'PROFIL', options: ['fr', 'en', 'es'] },
            { name: 'accountType', label: 'Type de compte', type: 'select', group: 'BANQUE', options: ['EPARGNE', 'COURANT', 'PROFESSIONNEL', 'JEUNE'] },
            { name: 'engagementScore', label: "Score engagement", type: 'number', group: 'COMPORTEMENT' },
            { name: 'status', label: 'Statut contact', type: 'select', group: 'PROFIL', options: ['ACTIVE', 'UNSUBSCRIBED', 'BLOCKED'] },
        ];
        const OPS_BY_TYPE = {
            select: [{ v: 'eq', l: '=' }, { v: 'neq', l: '!=' }, { v: 'in', l: 'dans' }],
            text: [{ v: 'eq', l: '=' }, { v: 'contains', l: 'contient' }],
            number: [{ v: 'eq', l: '=' }, { v: 'gt', l: '>' }, { v: 'gte', l: '>=' }, { v: 'lt', l: '<' }, { v: 'lte', l: '<=' }],
            date: [{ v: 'gt', l: 'apres' }, { v: 'lt', l: 'avant' }],
            boolean: [{ v: 'eq', l: '=' }]
        };

        const RuleRow = ({ rule, onChange, onRemove }) => {
            const fieldDef = SEGMENT_FIELDS.find(f => f.name === rule.field) || SEGMENT_FIELDS[0];
            const ops = OPS_BY_TYPE[fieldDef.type] || OPS_BY_TYPE.text;
            return (
                <div className="flex items-center gap-2 flex-wrap">
                    <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.field} onChange={e => { const fd = SEGMENT_FIELDS.find(f => f.name === e.target.value); onChange({ ...rule, field: e.target.value, op: (OPS_BY_TYPE[fd?.type] || OPS_BY_TYPE.text)[0].v, value: '' }); }}>
                        {SEGMENT_FIELDS.map(f => <option key={f.name} value={f.name}>{f.label}</option>)}
                    </select>
                    <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.op} onChange={e => onChange({ ...rule, op: e.target.value })}>
                        {ops.map(o => <option key={o.v} value={o.v}>{o.l}</option>)}
                    </select>
                    {fieldDef.options ? (
                        <select className="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white" value={rule.value} onChange={e => onChange({ ...rule, value: e.target.value })}>
                            <option value="">Choisir...</option>
                            {fieldDef.options.map(o => <option key={o} value={o}>{o}</option>)}
                        </select>
                    ) : (
                        <input type={fieldDef.type === 'number' ? 'number' : 'text'} className="border border-gray-300 rounded-lg px-3 py-2 text-sm w-40" placeholder="Valeur" value={rule.value} onChange={e => onChange({ ...rule, value: fieldDef.type === 'number' ? Number(e.target.value) : e.target.value })} />
                    )}
                    <button className="text-red-500 hover:text-red-700 p-1" onClick={onRemove}><Icons.Trash2 /></button>
                </div>
            );
        };

        const SegmentBuilder = ({ criteria, onChange, previewCount }) => {
            const addRule = () => {
                const newRules = [...(criteria.rules || []), { field: 'city', op: 'eq', value: '' }];
                onChange({ ...criteria, rules: newRules });
            };
            const updateRule = (idx, rule) => {
                const newRules = [...criteria.rules]; newRules[idx] = rule;
                onChange({ ...criteria, rules: newRules });
            };
            const removeRule = (idx) => {
                const newRules = criteria.rules.filter((_, i) => i !== idx);
                onChange({ ...criteria, rules: newRules });
            };
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-2 mb-2">
                        <span className="text-sm font-medium text-gray-700">Operateur logique :</span>
                        <button className={'px-3 py-1 rounded-lg text-sm font-medium ' + (criteria.operator === 'AND' ? 'bg-bgfi-primary text-white' : 'bg-gray-100 text-gray-600')} onClick={() => onChange({ ...criteria, operator: 'AND' })}>ET (AND)</button>
                        <button className={'px-3 py-1 rounded-lg text-sm font-medium ' + (criteria.operator === 'OR' ? 'bg-bgfi-primary text-white' : 'bg-gray-100 text-gray-600')} onClick={() => onChange({ ...criteria, operator: 'OR' })}>OU (OR)</button>
                    </div>
                    <div className="space-y-2 pl-4 border-l-2 border-bgfi-primary/30">
                        {(criteria.rules || []).map((rule, idx) => (
                            <RuleRow key={idx} rule={rule} onChange={r => updateRule(idx, r)} onRemove={() => removeRule(idx)} />
                        ))}
                    </div>
                    <Button variant="secondary" size="sm" icon={Icons.Plus} onClick={addRule}>Ajouter un critere</Button>
                    {previewCount !== null && previewCount !== undefined && (
                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 flex items-center gap-2">
                            <Icons.Users />
                            <span className="text-sm font-medium text-blue-900">{previewCount} contact(s) correspondent</span>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Stepper Component
        // =============================================
        const Stepper = ({ steps, current }) => (
            <div className="flex items-center justify-between mb-8">
                {steps.map((step, i) => (
                    <React.Fragment key={i}>
                        <div className="flex items-center gap-2">
                            <div className={'w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ' + (i < current ? 'bg-green-500 text-white' : i === current ? 'bg-bgfi-primary text-white' : 'bg-gray-200 text-gray-500')}>
                                {i < current ? '\u2713' : i + 1}
                            </div>
                            <span className={'text-sm font-medium hidden sm:inline ' + (i <= current ? 'text-gray-900' : 'text-gray-400')}>{step}</span>
                        </div>
                        {i < steps.length - 1 && <div className={'flex-1 h-0.5 mx-2 ' + (i < current ? 'bg-green-500' : 'bg-gray-200')} />}
                    </React.Fragment>
                ))}
            </div>
        );

        // =============================================
        // Campaign Wizard (5 steps)
        // =============================================
        const CampaignWizard = ({ onClose, onCreated, templates }) => {
            const [step, setStep] = useState(0);
            const [creating, setCreating] = useState(false);
            const [previewCount, setPreviewCount] = useState(null);
            const { data: segData } = useApi('/segments?limit=100');
            const segments = segData?.data || [];

            const [form, setForm] = useState({
                name: '', type: '', description: '',
                targetMode: 'segment', segmentId: '', inlineCriteria: { operator: 'AND', rules: [] }, saveSegment: false, newSegmentName: '',
                templateId: '',
                scheduledAt: ''
            });

            const stepNames = ['Configuration', 'Ciblage', 'Contenu', 'Planification', 'Recapitulatif'];

            // Debounced preview
            const previewTimer = React.useRef(null);
            React.useEffect(() => {
                if (form.targetMode !== 'builder' || form.inlineCriteria.rules.length === 0) { setPreviewCount(null); return; }
                clearTimeout(previewTimer.current);
                previewTimer.current = setTimeout(async () => {
                    try {
                        const res = await api('/segments/preview', { method: 'POST', body: JSON.stringify({ criteria: form.inlineCriteria }) });
                        setPreviewCount(res.contactCount);
                    } catch { setPreviewCount(null); }
                }, 500);
                return () => clearTimeout(previewTimer.current);
            }, [form.inlineCriteria, form.targetMode]);

            const handleCreate = async () => {
                setCreating(true);
                try {
                    const body = { name: form.name, type: form.type, templateId: form.templateId, scheduledAt: form.scheduledAt || undefined };
                    if (form.targetMode === 'segment' && form.segmentId) {
                        body.segmentId = form.segmentId;
                    } else if (form.targetMode === 'builder') {
                        if (form.saveSegment && form.newSegmentName) {
                            const seg = await api('/segments', { method: 'POST', body: JSON.stringify({ name: form.newSegmentName, criteria: form.inlineCriteria }) });
                            body.segmentId = seg.id;
                        } else {
                            body.inlineCriteria = form.inlineCriteria;
                        }
                    } else {
                        body.segment = 'ALL';
                    }
                    await api('/campaigns', { method: 'POST', body: JSON.stringify(body) });
                    onCreated();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const canNext = () => {
                if (step === 0) return form.name && form.type;
                if (step === 1) return form.targetMode === 'all' || (form.targetMode === 'segment' && form.segmentId) || (form.targetMode === 'builder' && form.inlineCriteria.rules.length > 0);
                if (step === 2) return form.templateId;
                return true;
            };

            const selTemplate = templates.find(t => t.id === form.templateId);
            const selSegment = segments.find(s => s.id === form.segmentId);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-auto">
                        <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                            <h2 className="text-xl font-semibold text-gray-900">Nouvelle Campagne WhatsApp</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                        </div>
                        <div className="p-6">
                            <Stepper steps={stepNames} current={step} />

                            {step === 0 && (
                                <div className="space-y-4">
                                    <Input label="Nom de la campagne" placeholder="Ex: Relance App Mobile - Fevrier" value={form.name} onChange={v => setForm({...form, name: v})} />
                                    <Select label="Type" value={form.type} onChange={v => setForm({...form, type: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'REACTIVATION', label: 'Reactivation' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'NOTIFICATION', label: 'Notification' }, { value: 'ALERT', label: 'Alerte' }]} />
                                </div>
                            )}

                            {step === 1 && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-3 gap-3">
                                        {[
                                            { id: 'all', label: 'Tous les contacts', desc: 'Cibler tous les contacts actifs', icon: Icons.Users },
                                            { id: 'segment', label: 'Segment sauvegarde', desc: 'Utiliser un segment existant', icon: Icons.Layers },
                                            { id: 'builder', label: 'Criteres avances', desc: 'Construire un ciblage sur mesure', icon: Icons.Target }
                                        ].map(m => (
                                            <div key={m.id} className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (form.targetMode === m.id ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200 hover:border-gray-300')} onClick={() => setForm({...form, targetMode: m.id})}>
                                                <div className="text-bgfi-primary mb-2"><m.icon /></div>
                                                <p className="font-medium text-sm text-gray-900">{m.label}</p>
                                                <p className="text-xs text-gray-500 mt-1">{m.desc}</p>
                                            </div>
                                        ))}
                                    </div>
                                    {form.targetMode === 'segment' && (
                                        <div className="space-y-3">
                                            <Select label="Segment" value={form.segmentId} onChange={v => setForm({...form, segmentId: v})} options={[{ value: '', label: 'Selectionner un segment...' }, ...segments.map(s => ({ value: s.id, label: s.name + ' (' + s.contactCount + ' contacts)' }))]} />
                                            {selSegment?.description && <p className="text-sm text-gray-500">{selSegment.description}</p>}
                                        </div>
                                    )}
                                    {form.targetMode === 'builder' && (
                                        <div className="space-y-4">
                                            <SegmentBuilder criteria={form.inlineCriteria} onChange={c => setForm({...form, inlineCriteria: c})} previewCount={previewCount} />
                                            <div className="flex items-center gap-3 mt-4 p-3 bg-gray-50 rounded-xl">
                                                <input type="checkbox" id="saveSeg" checked={form.saveSegment} onChange={e => setForm({...form, saveSegment: e.target.checked})} className="rounded" />
                                                <label htmlFor="saveSeg" className="text-sm text-gray-700">Sauvegarder comme segment reutilisable</label>
                                                {form.saveSegment && <Input placeholder="Nom du segment" value={form.newSegmentName} onChange={v => setForm({...form, newSegmentName: v})} className="flex-1" />}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 2 && (
                                <div className="space-y-4">
                                    <Select label="Template approuve" value={form.templateId} onChange={v => setForm({...form, templateId: v})} options={[{ value: '', label: 'Selectionner un template...' }, ...templates.map(t => ({ value: t.id, label: (t.displayName || t.name) + ' (' + (t.category || '') + ')' }))]} />
                                    {selTemplate && (
                                        <div className="bg-gray-50 rounded-xl p-4">
                                            <p className="text-sm font-medium text-gray-700 mb-2">Apercu :</p>
                                            <p className="text-sm text-gray-600 whitespace-pre-wrap">{selTemplate.content}</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {step === 3 && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (!form.scheduledAt ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200')} onClick={() => setForm({...form, scheduledAt: ''})}>
                                            <Icons.Send />
                                            <p className="font-medium text-sm mt-2">Envoi immediat</p>
                                            <p className="text-xs text-gray-500">La campagne sera en brouillon, prete a etre lancee</p>
                                        </div>
                                        <div className={'border-2 rounded-xl p-4 cursor-pointer transition-all ' + (form.scheduledAt ? 'border-bgfi-primary bg-bgfi-primary/5' : 'border-gray-200')} onClick={() => setForm({...form, scheduledAt: form.scheduledAt || new Date().toISOString().slice(0, 16)})}>
                                            <Icons.Calendar />
                                            <p className="font-medium text-sm mt-2">Planifier</p>
                                            <p className="text-xs text-gray-500">Choisir une date et heure d'envoi</p>
                                        </div>
                                    </div>
                                    {form.scheduledAt && <Input label="Date et heure d'envoi" type="datetime-local" value={form.scheduledAt} onChange={v => setForm({...form, scheduledAt: v})} />}
                                </div>
                            )}

                            {step === 4 && (
                                <div className="space-y-4">
                                    <div className="bg-gray-50 rounded-xl p-6 space-y-3">
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Campagne</span><span className="text-sm font-medium">{form.name}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Type</span><span className="text-sm font-medium">{catMap[form.type] || form.type}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Ciblage</span><span className="text-sm font-medium">{form.targetMode === 'all' ? 'Tous les contacts' : form.targetMode === 'segment' ? (selSegment?.name || '-') : 'Criteres personnalises' + (previewCount !== null ? ' (' + previewCount + ' contacts)' : '')}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Template</span><span className="text-sm font-medium">{selTemplate?.displayName || selTemplate?.name || '-'}</span></div>
                                        <div className="flex justify-between"><span className="text-sm text-gray-500">Planification</span><span className="text-sm font-medium">{form.scheduledAt ? new Date(form.scheduledAt).toLocaleString('fr-FR') : 'Brouillon (envoi manuel)'}</span></div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="p-6 border-t border-gray-200 flex justify-between">
                            <div>{step > 0 && <Button variant="secondary" icon={Icons.ChevronLeft} onClick={() => setStep(step - 1)}>Retour</Button>}</div>
                            <div className="flex gap-3">
                                <Button variant="secondary" onClick={onClose}>Annuler</Button>
                                {step < 4 ? (
                                    <Button onClick={() => setStep(step + 1)} disabled={!canNext()} icon={Icons.ChevronRight}>Suivant</Button>
                                ) : (
                                    <Button onClick={handleCreate} disabled={creating} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Creer la campagne'}</Button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =============================================
        // Campaigns View
        // =============================================
        const CampaignsView = () => {
            const [showWizard, setShowWizard] = useState(false);
            const [selectedCampaign, setSelectedCampaign] = useState(null);
            const { data, loading, error, refetch } = useApi('/campaigns?limit=50');
            const { data: tplData } = useApi('/templates?status=APPROVED&limit=100');

            const campaigns = data?.data || [];
            const templates = tplData?.data || [];

            const handleSend = async (id) => {
                if (!confirm('Lancer cette campagne ?')) return;
                try { await api('/campaigns/' + id + '/send', { method: 'POST' }); setSelectedCampaign(null); refetch(); }
                catch (err) { alert(err.message); }
            };

            const [editModal, setEditModal] = useState(null);
            const [editForm, setEditForm] = useState({ name: '', type: '', templateId: '', segment: '', scheduledAt: '' });
            const [saving, setSaving] = useState(false);

            const openEdit = (c) => {
                setEditForm({
                    name: c.name, type: c.type,
                    templateId: c.templateId || c.template?.id || '',
                    segment: c.legacySegment || 'ALL',
                    scheduledAt: c.scheduledAt ? new Date(c.scheduledAt).toISOString().slice(0, 16) : ''
                });
                setEditModal(c);
            };

            const handleEdit = async () => {
                setSaving(true);
                try {
                    await api('/campaigns/' + editModal.id, { method: 'PUT', body: JSON.stringify(editForm) });
                    setEditModal(null); refetch();
                } catch (err) { alert(err.message); }
                finally { setSaving(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer cette campagne ? Cette action est irreversible.')) return;
                try { await api('/campaigns/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            if (selectedCampaign) {
                return <CampaignDetailView campaign={selectedCampaign} onBack={() => { setSelectedCampaign(null); refetch(); }} onSend={handleSend} templates={templates} />;
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-4"><Input placeholder="Rechercher une campagne..." icon={Icons.Search} className="w-64" /></div>
                        <Button onClick={() => setShowWizard(true)} icon={Icons.Plus}>Nouvelle Campagne</Button>
                    </div>
                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Campagne</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Statut</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Type</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Ciblage</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Envoyes</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {campaigns.length === 0 && <tr><td colSpan="7" className="py-8 text-center text-gray-500">Aucune campagne</td></tr>}
                                    {campaigns.map(c => (
                                        <tr key={c.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedCampaign(c)}>
                                            <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-bgfi-primary/10 rounded-xl flex items-center justify-center text-bgfi-primary"><Icons.Send /></div><div><p className="font-medium text-gray-900">{c.name}</p><p className="text-sm text-gray-500">{c.template?.name || '-'}</p></div></div></td>
                                            <td className="py-4 px-4"><Badge variant={statusVariant[c.status] || 'default'}>{statusMap[c.status] || c.status}</Badge></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{catMap[c.type] || c.type}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{c.segmentRef?.name || categoryMap[c.legacySegment] || 'Tous'}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{c.sent || 0}/{c.delivered || 0}/{c.failed || 0}</td>
                                            <td className="py-4 px-4 text-sm text-gray-500">{c.createdAt ? new Date(c.createdAt).toLocaleDateString('fr-FR') : '-'}</td>
                                            <td className="py-4 px-4 text-right" onClick={e => e.stopPropagation()}><div className="flex items-center justify-end gap-2">{c.status === 'DRAFT' && <Button variant="accent" size="sm" icon={Icons.Play} onClick={() => handleSend(c.id)}>Lancer</Button>}{['DRAFT','SCHEDULED','PAUSED'].includes(c.status) && <Button variant="ghost" size="sm" icon={Icons.Edit} onClick={() => openEdit(c)} title="Modifier" />}<Button variant="ghost" size="sm" icon={Icons.BarChart3} onClick={() => setSelectedCampaign(c)} title="Statistiques" />{c.status !== 'RUNNING' && <Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(c.id)} title="Supprimer" />}</div></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </Card>

                    {showWizard && <CampaignWizard onClose={() => setShowWizard(false)} onCreated={() => { setShowWizard(false); refetch(); }} templates={templates} />}

                    {editModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Modifier la Campagne</h2>
                                    <button onClick={() => setEditModal(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <Input label="Nom de la campagne" value={editForm.name} onChange={v => setEditForm({...editForm, name: v})} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Type" value={editForm.type} onChange={v => setEditForm({...editForm, type: v})} options={[{ value: 'REACTIVATION', label: 'Reactivation' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'NOTIFICATION', label: 'Notification' }, { value: 'ALERT', label: 'Alerte' }]} />
                                        <Select label="Template" value={editForm.templateId} onChange={v => setEditForm({...editForm, templateId: v})} options={[{ value: '', label: 'Selectionner...' }, ...templates.map(t => ({ value: t.id, label: t.displayName || t.name }))]} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Categorie" value={editForm.segment} onChange={v => setEditForm({...editForm, segment: v})} options={[{ value: 'ALL', label: 'Tous les contacts' }, { value: 'ACTIVE', label: 'Actifs' }, { value: 'INACTIVE', label: 'Inactifs' }, { value: 'NEW', label: 'Nouveaux' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                                        <Input label="Date d'envoi" type="datetime-local" value={editForm.scheduledAt} onChange={v => setEditForm({...editForm, scheduledAt: v})} />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setEditModal(null)}>Annuler</Button>
                                    <Button onClick={handleEdit} disabled={saving || !editForm.name} icon={Icons.CheckCircle}>{saving ? 'Enregistrement...' : 'Enregistrer'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Chatbot RAG View
        // =============================================
        const ChatbotView = () => {
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [isTyping, setIsTyping] = useState(false);
            const [activeTab, setActiveTab] = useState('chat');
            const { data: knowledgeData, refetch: refetchKB } = useApi('/chatbot/knowledge');
            const [sessionId, setSessionId] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState('');
            const messagesEndRef = useRef(null);

            const uploadedFiles = knowledgeData?.documents || [];

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const handleSendMessage = async () => {
                if (!inputMessage.trim()) return;
                const userMsg = { id: Date.now(), role: 'user', content: inputMessage, timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) };
                setMessages(prev => [...prev, userMsg]);
                const msgText = inputMessage;
                setInputMessage(''); setIsTyping(true);
                try {
                    const res = await api('/chatbot/message', { method: 'POST', body: JSON.stringify({ message: msgText, sessionId }) });
                    if (res.sessionId) setSessionId(res.sessionId);
                    setMessages(prev => [...prev, { id: Date.now()+1, role: 'bot', content: res.response || res.message || 'Pas de reponse', timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) }]);
                } catch (err) {
                    setMessages(prev => [...prev, { id: Date.now()+1, role: 'bot', content: 'Erreur: ' + err.message, timestamp: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) }]);
                } finally { setIsTyping(false); }
            };

            const handleFileUpload = async (e) => {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                setIsUploading(true);
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    setUploadProgress(`Traitement de "${file.name}"${files.length > 1 ? ` (${i+1}/${files.length})` : ''}...`);
                    const fd = new FormData(); fd.append('file', file);
                    try { await api('/chatbot/knowledge/upload', { method: 'POST', body: fd }); refetchKB(); }
                    catch (err) { alert('Erreur upload: ' + err.message); }
                }
                setIsUploading(false); setUploadProgress('');
                e.target.value = '';
            };

            const handleDeleteDoc = async (id) => {
                if (!confirm('Supprimer ce document ?')) return;
                try { await api('/chatbot/knowledge/' + id, { method: 'DELETE' }); refetchKB(); }
                catch (err) { alert(err.message); }
            };

            return (
                <div className="space-y-6">
                    <div className="flex items-center gap-2 border-b border-gray-200">
                        <button onClick={() => setActiveTab('chat')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'chat' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Test du Chatbot</button>
                        <button onClick={() => setActiveTab('knowledge')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'knowledge' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Base de Connaissances</button>
                        <button onClick={() => setActiveTab('config')} className={`px-4 py-3 text-sm font-medium border-b-2 transition-colors ${activeTab === 'config' ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>Configuration RAG</button>
                    </div>

                    {activeTab === 'chat' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <Card className="lg:col-span-2" title="Conversation de Test">
                                <div className="h-96 overflow-y-auto space-y-4 mb-4 pr-2">
                                    {messages.length === 0 && <p className="text-center text-gray-400 py-16">Envoyez un message pour tester le chatbot</p>}
                                    {messages.map(msg => (
                                        <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] rounded-2xl px-4 py-3 ${msg.role === 'user' ? 'bg-bgfi-primary text-white rounded-br-md' : 'bg-gray-100 text-gray-900 rounded-bl-md'}`}>
                                                <p className="text-sm whitespace-pre-line">{msg.content}</p>
                                                <p className={`text-xs mt-1 ${msg.role === 'user' ? 'text-blue-200' : 'text-gray-500'}`}>{msg.timestamp}</p>
                                            </div>
                                        </div>
                                    ))}
                                    {isTyping && <div className="flex justify-start"><div className="bg-gray-100 rounded-2xl rounded-bl-md px-4 py-3"><div className="typing-indicator"><span /><span /><span /></div></div></div>}
                                    <div ref={messagesEndRef} />
                                </div>
                                <div className="flex gap-2">
                                    <input type="text" value={inputMessage} onChange={(e) => setInputMessage(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()} placeholder="Ecrivez votre message..." className="flex-1 rounded-xl border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary px-4 py-3 border" />
                                    <Button onClick={handleSendMessage} disabled={isTyping} icon={Icons.Send}>Envoyer</Button>
                                </div>
                            </Card>
                            <div className="space-y-6">
                                <Card title="Suggestions Rapides">
                                    <div className="space-y-2">
                                        {['Comment recuperer mes identifiants ?', 'Quels sont les frais de virement ?', 'Comment activer la biometrie ?', 'Comment faire un retrait ?'].map((suggestion, i) => (
                                            <button key={i} onClick={() => setInputMessage(suggestion)} className="w-full text-left px-4 py-3 text-sm text-gray-700 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">{suggestion}</button>
                                        ))}
                                    </div>
                                </Card>
                            </div>
                        </div>
                    )}

                    {activeTab === 'knowledge' && (
                        <div className="space-y-6">
                            <div className="flex items-center justify-between">
                                <Input placeholder="Rechercher un document..." icon={Icons.Search} className="w-80" />
                                <div>
                                    <input type="file" multiple onChange={handleFileUpload} className="hidden" id="file-upload" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.csv" disabled={isUploading} />
                                    <label htmlFor="file-upload"><Button variant="primary" icon={Icons.Upload} onClick={() => !isUploading && document.getElementById('file-upload').click()} disabled={isUploading}>{isUploading ? 'Traitement...' : 'Uploader un document'}</Button></label>
                                </div>
                            </div>
                            {isUploading && (
                                <div className="bg-bgfi-primary/5 border border-bgfi-primary/20 rounded-xl p-4 flex items-center gap-4">
                                    <div className="animate-spin rounded-full h-8 w-8 border-4 border-bgfi-primary/20 border-t-bgfi-primary"></div>
                                    <div>
                                        <p className="font-medium text-bgfi-primary">Upload en cours</p>
                                        <p className="text-sm text-gray-600">{uploadProgress || 'Extraction du texte et indexation des chunks...'}</p>
                                    </div>
                                </div>
                            )}
                            <Card>
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Document</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Type</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Date</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {uploadedFiles.length === 0 && <tr><td colSpan="4" className="py-8 text-center text-gray-500">Aucun document dans la base</td></tr>}
                                            {uploadedFiles.map(file => (
                                                <tr key={file.id} className="hover:bg-gray-50">
                                                    <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-red-100 text-red-600 rounded-xl flex items-center justify-center"><Icons.FileText /></div><span className="font-medium text-gray-900">{file.name}</span></div></td>
                                                    <td className="py-4 px-4 text-sm text-gray-600 uppercase">{file.type || '-'}</td>
                                                    <td className="py-4 px-4 text-sm text-gray-600">{file.uploadedAt ? new Date(file.uploadedAt).toLocaleDateString('fr-FR') : '-'}</td>
                                                    <td className="py-4 px-4 text-right"><Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDeleteDoc(file.id)} /></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    )}

                    {activeTab === 'config' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <Card title="Parametres RAG">
                                <div className="space-y-6">
                                    <Select label="Modele LLM" value="gpt-4" options={[{ value: 'gpt-4', label: 'GPT-4 (Recommande)' }, { value: 'gpt-3.5', label: 'GPT-3.5 Turbo' }]} />
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Nombre de chunks (contexte)</label><input type="range" min="1" max="10" defaultValue="5" className="w-full" /><div className="flex justify-between text-xs text-gray-500 mt-1"><span>1</span><span>5</span><span>10</span></div></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Seuil de similarite</label><input type="range" min="0" max="100" defaultValue="75" className="w-full" /><div className="flex justify-between text-xs text-gray-500 mt-1"><span>0%</span><span>75%</span><span>100%</span></div></div>
                                    <div className="flex items-center gap-3"><input type="checkbox" id="citations" defaultChecked className="w-4 h-4 text-bgfi-primary rounded" /><label htmlFor="citations" className="text-sm text-gray-700">Inclure les citations des sources</label></div>
                                    <div className="flex items-center gap-3"><input type="checkbox" id="fallback" defaultChecked className="w-4 h-4 text-bgfi-primary rounded" /><label htmlFor="fallback" className="text-sm text-gray-700">Reponse de secours si aucune source trouvee</label></div>
                                </div>
                            </Card>
                            <Card title="Personnalisation du Bot">
                                <div className="space-y-6">
                                    <Input label="Nom du Bot" value="Cassiopee" />
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Message d'accueil</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="3" defaultValue="Bonjour ! Je suis Cassiopee, votre assistant BGFI disponible 24/7. Comment puis-je vous aider aujourd'hui ?" /></div>
                                    <div><label className="block text-sm font-medium text-gray-700 mb-2">Instructions systeme (prompt)</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border font-mono text-xs" rows="6" defaultValue={`Tu es Cassiopee, l'assistant virtuel de BGFI Bank.\n\nREGLES:\n- Reponds uniquement en francais\n- Base-toi UNIQUEMENT sur la documentation fournie\n- Si tu ne trouves pas la reponse, oriente vers le service client\n- Sois professionnel, chaleureux et concis\n- Ne partage JAMAIS d'informations sensibles`} /></div>
                                </div>
                            </Card>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Conversations View (Historique + Rapports + Stats)
        // =============================================
        const ConversationsView = () => {
            const [convTab, setConvTab] = useState('historique');
            const [sessions, setSessions] = useState([]);
            const [sessionsLoading, setSessionsLoading] = useState(false);
            const [sessionsPagination, setSessionsPagination] = useState({ page: 1, total: 0, totalPages: 0 });
            const [selectedSession, setSelectedSession] = useState(null);
            const [filters, setFilters] = useState({ sentiment: '', intentCategory: '', urgencyLevel: '', resolutionStatus: '', source: '', search: '' });
            const [reports, setReports] = useState([]);
            const [reportsLoading, setReportsLoading] = useState(false);
            const [selectedReport, setSelectedReport] = useState(null);
            const [enrichStats, setEnrichStats] = useState(null);
            const [enrichStatsLoading, setEnrichStatsLoading] = useState(false);
            const [generating, setGenerating] = useState(false);
            const [enrichingBatch, setEnrichingBatch] = useState(false);

            const sentimentLabels = { POSITIVE: 'Positif', NEUTRAL: 'Neutre', NEGATIVE: 'Negatif', FRUSTRATED: 'Frustre' };
            const sentimentColors = { POSITIVE: 'bg-green-100 text-green-700', NEUTRAL: 'bg-gray-100 text-gray-700', NEGATIVE: 'bg-orange-100 text-orange-700', FRUSTRATED: 'bg-red-100 text-red-700' };
            const sentimentChartColors = { POSITIVE: '#22c55e', NEUTRAL: '#9ca3af', NEGATIVE: '#f97316', FRUSTRATED: '#ef4444' };
            const intentLabels = { ACCOUNT_INQUIRY: 'Compte', LOAN_REQUEST: 'Pret', CARD_ISSUE: 'Carte', TRANSFER_HELP: 'Virement', COMPLAINT: 'Reclamation', PRODUCT_INFO: 'Info produit', ACCOUNT_OPENING: 'Ouverture', FEES_CHARGES: 'Frais', MOBILE_BANKING: 'Mobile', GENERAL: 'General' };
            const urgencyColors = { LOW: 'bg-blue-100 text-blue-700', MEDIUM: 'bg-yellow-100 text-yellow-700', HIGH: 'bg-orange-100 text-orange-700', CRITICAL: 'bg-red-100 text-red-700' };
            const resolutionLabels = { RESOLVED: 'Resolu', UNRESOLVED: 'Non resolu', ESCALATION_NEEDED: 'Escalade', FOLLOW_UP_REQUIRED: 'Suivi requis' };
            const resolutionColors = { RESOLVED: 'bg-green-100 text-green-700', UNRESOLVED: 'bg-red-100 text-red-700', ESCALATION_NEEDED: 'bg-purple-100 text-purple-700', FOLLOW_UP_REQUIRED: 'bg-yellow-100 text-yellow-700' };
            const productLabels = { SAVINGS_ACCOUNT: 'Epargne', CURRENT_ACCOUNT: 'Courant', CREDIT_CARD: 'Carte credit', PERSONAL_LOAN: 'Pret perso', MORTGAGE: 'Hypotheque', INSURANCE: 'Assurance', MOBILE_BANKING: 'Mobile banking', VISA_CARD: 'Carte Visa', NONE: '' };

            const fetchSessions = useCallback(async (page = 1) => {
                setSessionsLoading(true);
                try {
                    const params = new URLSearchParams({ page, limit: 20 });
                    Object.entries(filters).forEach(([k, v]) => { if (v) params.set(k, v); });
                    const data = await api('/chatbot/sessions?' + params.toString());
                    setSessions(data.data || []);
                    setSessionsPagination(data.pagination || { page: 1, total: 0, totalPages: 0 });
                } catch (err) { console.error('Error fetching sessions', err); }
                setSessionsLoading(false);
            }, [filters]);

            const fetchReports = useCallback(async () => {
                setReportsLoading(true);
                try {
                    const data = await api('/chatbot/reports');
                    setReports(data.data || []);
                } catch (err) { console.error('Error fetching reports', err); }
                setReportsLoading(false);
            }, []);

            const fetchEnrichStats = useCallback(async () => {
                setEnrichStatsLoading(true);
                try {
                    const data = await api('/chatbot/sessions/enrichment-stats');
                    setEnrichStats(data);
                } catch (err) { console.error('Error fetching enrichment stats', err); }
                setEnrichStatsLoading(false);
            }, []);

            useEffect(() => {
                if (convTab === 'historique') fetchSessions();
                if (convTab === 'rapports') fetchReports();
                if (convTab === 'statistiques') fetchEnrichStats();
            }, [convTab, fetchSessions, fetchReports, fetchEnrichStats]);

            const handleGenerateReport = async () => {
                setGenerating(true);
                try {
                    const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                    await api('/chatbot/reports/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date: yesterday }) });
                    fetchReports();
                } catch (err) { alert('Erreur: ' + err.message); }
                setGenerating(false);
            };

            const handleEnrichBatch = async () => {
                setEnrichingBatch(true);
                try {
                    const result = await api('/chatbot/sessions/enrich-batch', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ limit: 50 }) });
                    alert(`Enrichissement termine: ${result.enriched} enrichies, ${result.failed} echouees sur ${result.total}`);
                    fetchSessions();
                    if (convTab === 'statistiques') fetchEnrichStats();
                } catch (err) { alert('Erreur: ' + err.message); }
                setEnrichingBatch(false);
            };

            const handleFeedToRag = async (reportId) => {
                try {
                    await api('/chatbot/reports/feed-to-rag', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ reportId }) });
                    alert('Rapport ajoute a la base de connaissances RAG');
                } catch (err) { alert('Erreur: ' + err.message); }
            };

            const handleReEnrich = async (sessionId) => {
                try {
                    await api(`/chatbot/sessions/${sessionId}/enrich`, { method: 'POST' });
                    // Refresh session detail
                    const updated = await api(`/chatbot/sessions/${sessionId}`);
                    setSelectedSession(updated);
                    fetchSessions(sessionsPagination.page);
                } catch (err) { alert('Erreur: ' + err.message); }
            };

            const convTabs = [
                { id: 'historique', label: 'Historique' },
                { id: 'rapports', label: 'Rapports' },
                { id: 'statistiques', label: 'Statistiques' },
            ];

            // Helper to build chart data from breakdown object
            const breakdownToChartData = (breakdown, labels) => {
                return Object.entries(breakdown || {}).map(([key, value]) => ({
                    name: (labels && labels[key]) || key,
                    value,
                    key
                })).sort((a, b) => b.value - a.value);
            };

            const PIE_COLORS = ['#22c55e', '#9ca3af', '#f97316', '#ef4444', '#8b5cf6', '#3b82f6', '#eab308', '#06b6d4'];

            return (
                <div className="space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900">Conversations</h1>
                            <p className="text-sm text-gray-500 mt-1">Historique, enrichissement IA et rapports bancaires</p>
                        </div>
                        <div className="flex gap-2">
                            <Button variant="secondary" size="sm" icon={Icons.RefreshCw} onClick={handleEnrichBatch} disabled={enrichingBatch}>
                                {enrichingBatch ? 'Enrichissement...' : 'Enrichir non-analysees'}
                            </Button>
                        </div>
                    </div>

                    {/* Tabs */}
                    <div className="flex gap-1 bg-gray-100 p-1 rounded-lg w-fit">
                        {convTabs.map(t => (
                            <button key={t.id} onClick={() => setConvTab(t.id)} className={`px-4 py-2 text-sm font-medium rounded-md transition-all ${convTab === t.id ? 'bg-white text-bgfi-primary shadow-sm' : 'text-gray-600 hover:text-gray-900'}`}>{t.label}</button>
                        ))}
                    </div>

                    {/* ===== HISTORIQUE TAB ===== */}
                    {convTab === 'historique' && (
                        <div className="space-y-4">
                            {/* Filters */}
                            <Card className="p-4">
                                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                    <select className="rounded-lg border-gray-300 text-sm" value={filters.sentiment} onChange={e => setFilters(f => ({ ...f, sentiment: e.target.value }))}>
                                        <option value="">Sentiment</option>
                                        {Object.entries(sentimentLabels).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                                    </select>
                                    <select className="rounded-lg border-gray-300 text-sm" value={filters.intentCategory} onChange={e => setFilters(f => ({ ...f, intentCategory: e.target.value }))}>
                                        <option value="">Intention</option>
                                        {Object.entries(intentLabels).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                                    </select>
                                    <select className="rounded-lg border-gray-300 text-sm" value={filters.urgencyLevel} onChange={e => setFilters(f => ({ ...f, urgencyLevel: e.target.value }))}>
                                        <option value="">Urgence</option>
                                        <option value="LOW">Basse</option>
                                        <option value="MEDIUM">Moyenne</option>
                                        <option value="HIGH">Haute</option>
                                        <option value="CRITICAL">Critique</option>
                                    </select>
                                    <select className="rounded-lg border-gray-300 text-sm" value={filters.resolutionStatus} onChange={e => setFilters(f => ({ ...f, resolutionStatus: e.target.value }))}>
                                        <option value="">Resolution</option>
                                        {Object.entries(resolutionLabels).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
                                    </select>
                                    <select className="rounded-lg border-gray-300 text-sm" value={filters.source} onChange={e => setFilters(f => ({ ...f, source: e.target.value }))}>
                                        <option value="">Source</option>
                                        <option value="whatsapp">WhatsApp</option>
                                        <option value="web">Web</option>
                                    </select>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Rechercher..." className="rounded-lg border-gray-300 text-sm flex-1" value={filters.search} onChange={e => setFilters(f => ({ ...f, search: e.target.value }))} onKeyDown={e => e.key === 'Enter' && fetchSessions()} />
                                        <Button variant="primary" size="sm" onClick={() => fetchSessions()}>Filtrer</Button>
                                    </div>
                                </div>
                            </Card>

                            {/* Sessions list */}
                            {sessionsLoading ? (
                                <div className="text-center py-12 text-gray-500">Chargement...</div>
                            ) : sessions.length === 0 ? (
                                <Card className="p-12 text-center text-gray-500">Aucune conversation trouvee</Card>
                            ) : (
                                <div className="space-y-3">
                                    {sessions.map(s => (
                                        <Card key={s.id} className="p-4 cursor-pointer hover:shadow-md transition-shadow" onClick={() => setSelectedSession(s)}>
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="font-medium text-gray-900">{s.contact?.name || s.contact?.phone || 'Visiteur web'}</span>
                                                        <span className="text-xs text-gray-400">{s.source === 'whatsapp' ? 'WhatsApp' : 'Web'}</span>
                                                        {s.actionRequired && <span className="w-2 h-2 bg-red-500 rounded-full" title="Action requise" />}
                                                    </div>
                                                    <p className="text-sm text-gray-600 truncate">{(Array.isArray(s.messages) && s.messages[0]?.content) || '...'}</p>
                                                    {s.customerNeedSummary && <p className="text-xs text-gray-500 mt-1 truncate">{s.customerNeedSummary}</p>}
                                                </div>
                                                <div className="flex flex-col items-end gap-1 ml-4">
                                                    <span className="text-xs text-gray-400">{new Date(s.createdAt).toLocaleDateString('fr-FR')} {new Date(s.createdAt).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</span>
                                                    <div className="flex gap-1 flex-wrap justify-end">
                                                        {s.sentiment && <span className={`text-xs px-2 py-0.5 rounded-full ${sentimentColors[s.sentiment] || 'bg-gray-100 text-gray-600'}`}>{sentimentLabels[s.sentiment] || s.sentiment}</span>}
                                                        {s.intentCategory && <span className="text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700">{intentLabels[s.intentCategory] || s.intentCategory}</span>}
                                                        {s.urgencyLevel && s.urgencyLevel !== 'LOW' && <span className={`text-xs px-2 py-0.5 rounded-full ${urgencyColors[s.urgencyLevel]}`}>{s.urgencyLevel}</span>}
                                                        {s.resolutionStatus && <span className={`text-xs px-2 py-0.5 rounded-full ${resolutionColors[s.resolutionStatus] || 'bg-gray-100'}`}>{resolutionLabels[s.resolutionStatus] || s.resolutionStatus}</span>}
                                                    </div>
                                                    {!s.enriched && <span className="text-xs text-gray-400 italic">Non enrichie</span>}
                                                </div>
                                            </div>
                                        </Card>
                                    ))}

                                    {/* Pagination */}
                                    {sessionsPagination.totalPages > 1 && (
                                        <div className="flex justify-center gap-2 pt-4">
                                            <Button variant="secondary" size="sm" disabled={sessionsPagination.page <= 1} onClick={() => fetchSessions(sessionsPagination.page - 1)}>Precedent</Button>
                                            <span className="px-4 py-2 text-sm text-gray-600">Page {sessionsPagination.page} / {sessionsPagination.totalPages} ({sessionsPagination.total} conversations)</span>
                                            <Button variant="secondary" size="sm" disabled={sessionsPagination.page >= sessionsPagination.totalPages} onClick={() => fetchSessions(sessionsPagination.page + 1)}>Suivant</Button>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Session Detail Modal */}
                            {selectedSession && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setSelectedSession(null)}>
                                    <div className="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                        <div className="flex items-center justify-between p-4 border-b">
                                            <div>
                                                <h3 className="font-semibold text-gray-900">{selectedSession.contact?.name || selectedSession.contact?.phone || 'Visiteur web'}</h3>
                                                <p className="text-sm text-gray-500">{new Date(selectedSession.createdAt).toLocaleDateString('fr-FR')} - {selectedSession.source}</p>
                                            </div>
                                            <button onClick={() => setSelectedSession(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                        </div>
                                        <div className="flex h-[70vh]">
                                            {/* Messages */}
                                            <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                                                {(Array.isArray(selectedSession.messages) ? selectedSession.messages : []).map((m, i) => (
                                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                        <div className={`max-w-[80%] rounded-2xl px-4 py-2.5 text-sm ${m.role === 'user' ? 'bg-bgfi-primary text-white rounded-br-sm' : 'bg-white border rounded-bl-sm text-gray-800'}`}>
                                                            {m.content}
                                                            <div className={`text-xs mt-1 ${m.role === 'user' ? 'text-white/70' : 'text-gray-400'}`}>
                                                                {m.timestamp ? new Date(m.timestamp).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }) : ''}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            {/* Enrichment panel */}
                                            <div className="w-80 border-l overflow-y-auto p-4 space-y-4 bg-white">
                                                <div className="flex items-center justify-between">
                                                    <h4 className="font-semibold text-gray-900 text-sm">Enrichissement IA</h4>
                                                    <Button variant="ghost" size="sm" onClick={() => handleReEnrich(selectedSession.id)}>Re-analyser</Button>
                                                </div>
                                                {!selectedSession.enriched ? (
                                                    <p className="text-sm text-gray-500 italic">Cette conversation n'a pas encore ete analysee.</p>
                                                ) : (
                                                    <>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Sentiment</label>
                                                            <div className="mt-1"><span className={`text-sm px-3 py-1 rounded-full ${sentimentColors[selectedSession.sentiment] || 'bg-gray-100'}`}>{sentimentLabels[selectedSession.sentiment] || '-'}</span></div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Intention</label>
                                                            <div className="mt-1 text-sm text-gray-800">{intentLabels[selectedSession.intentCategory] || selectedSession.intentCategory || '-'}</div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Produit mentionne</label>
                                                            <div className="mt-1 text-sm text-gray-800">{productLabels[selectedSession.productMentioned] || selectedSession.productMentioned || '-'}</div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Urgence</label>
                                                            <div className="mt-1"><span className={`text-sm px-3 py-1 rounded-full ${urgencyColors[selectedSession.urgencyLevel] || 'bg-gray-100'}`}>{selectedSession.urgencyLevel || '-'}</span></div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Resolution</label>
                                                            <div className="mt-1"><span className={`text-sm px-3 py-1 rounded-full ${resolutionColors[selectedSession.resolutionStatus] || 'bg-gray-100'}`}>{resolutionLabels[selectedSession.resolutionStatus] || '-'}</span></div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Satisfaction</label>
                                                            <div className="mt-1 flex items-center gap-1">
                                                                {[1,2,3,4,5].map(n => (
                                                                    <span key={n} className={`text-lg ${n <= Math.round(selectedSession.satisfactionScore || 0) ? 'text-yellow-400' : 'text-gray-300'}`}>&#9733;</span>
                                                                ))}
                                                                <span className="text-sm text-gray-600 ml-1">{selectedSession.satisfactionScore?.toFixed(1) || '-'}/5</span>
                                                            </div>
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-medium text-gray-500">Besoin client</label>
                                                            <p className="mt-1 text-sm text-gray-800">{selectedSession.customerNeedSummary || '-'}</p>
                                                        </div>
                                                        {selectedSession.actionRequired && (
                                                            <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                                                <div className="flex items-center gap-2 text-red-700 font-medium text-sm mb-1">
                                                                    <span className="w-2 h-2 bg-red-500 rounded-full" /> Action requise
                                                                </div>
                                                                <p className="text-sm text-red-600">{selectedSession.actionDescription || 'Suivi humain necessaire'}</p>
                                                            </div>
                                                        )}
                                                        {selectedSession.topicTags?.length > 0 && (
                                                            <div>
                                                                <label className="text-xs font-medium text-gray-500">Tags</label>
                                                                <div className="mt-1 flex flex-wrap gap-1">
                                                                    {selectedSession.topicTags.map((tag, i) => (
                                                                        <span key={i} className="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">{tag}</span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* ===== RAPPORTS TAB ===== */}
                    {convTab === 'rapports' && (
                        <div className="space-y-4">
                            <div className="flex justify-between items-center">
                                <p className="text-sm text-gray-600">Rapports quotidiens generes par l'IA a partir des conversations enrichies</p>
                                <Button variant="primary" size="sm" icon={Icons.Sparkles} onClick={handleGenerateReport} disabled={generating}>
                                    {generating ? 'Generation...' : 'Generer le rapport (hier)'}
                                </Button>
                            </div>

                            {reportsLoading ? (
                                <div className="text-center py-12 text-gray-500">Chargement...</div>
                            ) : reports.length === 0 ? (
                                <Card className="p-12 text-center text-gray-500">Aucun rapport genere. Cliquez sur "Generer le rapport" pour creer le premier.</Card>
                            ) : selectedReport ? (
                                <div className="space-y-4">
                                    <Button variant="ghost" size="sm" icon={Icons.ArrowLeft} onClick={() => setSelectedReport(null)}>Retour aux rapports</Button>

                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-bgfi-primary">{selectedReport.totalConversations}</div><div className="text-xs text-gray-500">Conversations</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-yellow-500">{selectedReport.avgSatisfactionScore?.toFixed(1) || 'N/A'}<span className="text-sm">/5</span></div><div className="text-xs text-gray-500">Satisfaction moyenne</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-green-600">{selectedReport.resolvedCount}</div><div className="text-xs text-gray-500">Resolues</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-red-500">{selectedReport.escalationCount}</div><div className="text-xs text-gray-500">Escaladees</div></Card>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        {/* Sentiment pie chart */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Repartition des sentiments</h4>
                                            <ResponsiveContainer width="100%" height={200}>
                                                <PieChart>
                                                    <Pie data={[
                                                        { name: 'Positif', value: selectedReport.sentimentPositive },
                                                        { name: 'Neutre', value: selectedReport.sentimentNeutral },
                                                        { name: 'Negatif', value: selectedReport.sentimentNegative },
                                                        { name: 'Frustre', value: selectedReport.sentimentFrustrated }
                                                    ].filter(d => d.value > 0)} dataKey="value" cx="50%" cy="50%" outerRadius={70} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                                        <Cell fill="#22c55e" /><Cell fill="#9ca3af" /><Cell fill="#f97316" /><Cell fill="#ef4444" />
                                                    </Pie>
                                                    <Tooltip />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </Card>

                                        {/* Intent bar chart */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Intentions detectees</h4>
                                            <ResponsiveContainer width="100%" height={200}>
                                                <BarChart data={breakdownToChartData(selectedReport.intentBreakdown, intentLabels).slice(0, 6)} layout="vertical" margin={{ left: 80 }}>
                                                    <XAxis type="number" />
                                                    <YAxis type="category" dataKey="name" width={75} tick={{ fontSize: 11 }} />
                                                    <Tooltip />
                                                    <Bar dataKey="value" fill="#003366" radius={[0, 4, 4, 0]} />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </Card>
                                    </div>

                                    {/* AI Insights */}
                                    {selectedReport.keyInsights && (
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-2">Analyse IA</h4>
                                            <p className="text-sm text-gray-700 whitespace-pre-line">{selectedReport.keyInsights}</p>
                                        </Card>
                                    )}

                                    {selectedReport.topCustomerNeeds?.length > 0 && (
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-2">Besoins clients principaux</h4>
                                            <ul className="space-y-1">
                                                {selectedReport.topCustomerNeeds.map((need, i) => (
                                                    <li key={i} className="text-sm text-gray-700 flex items-start gap-2"><span className="text-bgfi-primary font-bold">{i + 1}.</span> {need}</li>
                                                ))}
                                            </ul>
                                        </Card>
                                    )}

                                    {selectedReport.recommendations && (
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-2">Recommandations</h4>
                                            <p className="text-sm text-gray-700 whitespace-pre-line">{selectedReport.recommendations}</p>
                                        </Card>
                                    )}

                                    <div className="flex justify-end">
                                        <Button variant="accent" size="sm" icon={Icons.Database} onClick={() => handleFeedToRag(selectedReport.id)}>
                                            Alimenter la base RAG avec ce rapport
                                        </Button>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {reports.map(r => (
                                        <Card key={r.id} className="p-4 cursor-pointer hover:shadow-md transition-shadow" onClick={() => setSelectedReport(r)}>
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <h4 className="font-medium text-gray-900">Rapport du {new Date(r.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</h4>
                                                    <p className="text-sm text-gray-500 mt-1">{r.totalConversations} conversations - Satisfaction {r.avgSatisfactionScore?.toFixed(1) || 'N/A'}/5</p>
                                                </div>
                                                <div className="flex items-center gap-3 text-sm">
                                                    <span className="text-green-600">{r.sentimentPositive} positif</span>
                                                    <span className="text-orange-600">{r.sentimentNegative} negatif</span>
                                                    <span className="text-red-600">{r.sentimentFrustrated} frustre</span>
                                                    <Icons.ChevronRight />
                                                </div>
                                            </div>
                                        </Card>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}

                    {/* ===== STATISTIQUES TAB ===== */}
                    {convTab === 'statistiques' && (
                        <div className="space-y-4">
                            {enrichStatsLoading ? (
                                <div className="text-center py-12 text-gray-500">Chargement des statistiques...</div>
                            ) : !enrichStats ? (
                                <Card className="p-12 text-center text-gray-500">Aucune donnee disponible</Card>
                            ) : (
                                <>
                                    {/* KPI row */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-bgfi-primary">{enrichStats.totalEnriched}</div><div className="text-xs text-gray-500">Sessions analysees</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-yellow-500">{enrichStats.avgSatisfaction?.toFixed(1) || 'N/A'}<span className="text-sm">/5</span></div><div className="text-xs text-gray-500">Satisfaction moyenne</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-red-500">{enrichStats.actionRequiredPercent}%</div><div className="text-xs text-gray-500">Actions requises</div></Card>
                                        <Card className="p-4 text-center"><div className="text-2xl font-bold text-green-600">{enrichStats.resolvedPercent}%</div><div className="text-xs text-gray-500">Taux de resolution</div></Card>
                                    </div>

                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        {/* Sentiment pie */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Sentiments</h4>
                                            <ResponsiveContainer width="100%" height={250}>
                                                <PieChart>
                                                    <Pie data={breakdownToChartData(enrichStats.sentimentBreakdown, sentimentLabels)} dataKey="value" cx="50%" cy="50%" outerRadius={80} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                                        {breakdownToChartData(enrichStats.sentimentBreakdown, sentimentLabels).map((entry, i) => (
                                                            <Cell key={i} fill={sentimentChartColors[entry.key] || PIE_COLORS[i % PIE_COLORS.length]} />
                                                        ))}
                                                    </Pie>
                                                    <Tooltip />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </Card>

                                        {/* Intent bar */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Top Intentions</h4>
                                            <ResponsiveContainer width="100%" height={250}>
                                                <BarChart data={breakdownToChartData(enrichStats.intentBreakdown, intentLabels).slice(0, 8)} layout="vertical" margin={{ left: 80 }}>
                                                    <XAxis type="number" />
                                                    <YAxis type="category" dataKey="name" width={75} tick={{ fontSize: 11 }} />
                                                    <Tooltip />
                                                    <Bar dataKey="value" fill="#003366" radius={[0, 4, 4, 0]} />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </Card>

                                        {/* Product bar */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Produits mentionnes</h4>
                                            <ResponsiveContainer width="100%" height={250}>
                                                <BarChart data={breakdownToChartData(enrichStats.productBreakdown, productLabels).slice(0, 8)} layout="vertical" margin={{ left: 90 }}>
                                                    <XAxis type="number" />
                                                    <YAxis type="category" dataKey="name" width={85} tick={{ fontSize: 11 }} />
                                                    <Tooltip />
                                                    <Bar dataKey="value" fill="#00a86b" radius={[0, 4, 4, 0]} />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </Card>

                                        {/* Urgency pie */}
                                        <Card className="p-4">
                                            <h4 className="font-medium text-gray-900 mb-3">Niveaux d'urgence</h4>
                                            <ResponsiveContainer width="100%" height={250}>
                                                <PieChart>
                                                    <Pie data={breakdownToChartData(enrichStats.urgencyBreakdown, { LOW: 'Basse', MEDIUM: 'Moyenne', HIGH: 'Haute', CRITICAL: 'Critique' })} dataKey="value" cx="50%" cy="50%" outerRadius={80} label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                                                        {breakdownToChartData(enrichStats.urgencyBreakdown).map((entry, i) => (
                                                            <Cell key={i} fill={['#3b82f6', '#eab308', '#f97316', '#ef4444'][i] || PIE_COLORS[i]} />
                                                        ))}
                                                    </Pie>
                                                    <Tooltip />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </Card>
                                    </div>
                                </>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Contacts View
        // =============================================
        const ContactsView = () => {
            const [showImportModal, setShowImportModal] = useState(false);
            const [showAddModal, setShowAddModal] = useState(false);
            const [search, setSearch] = useState('');
            const [categoryFilter, setCategoryFilter] = useState('');
            const [cityFilter, setCityFilter] = useState('');
            const [accountTypeFilter, setAccountTypeFilter] = useState('');
            const { data, loading, error, refetch } = useApi('/contacts?limit=50' + (search ? '&search=' + encodeURIComponent(search) : '') + (categoryFilter ? '&category=' + categoryFilter : '') + (cityFilter ? '&city=' + encodeURIComponent(cityFilter) : '') + (accountTypeFilter ? '&accountType=' + accountTypeFilter : ''));
            const [form, setForm] = useState({ name: '', phone: '', email: '', category: 'ACTIVE', city: '', accountType: '', ageRange: '', gender: '' });
            const [creating, setCreating] = useState(false);
            const [editContact, setEditContact] = useState(null);
            const [editForm, setEditForm] = useState({});
            const [saving, setSaving] = useState(false);

            const contacts = data?.data || [];

            const handleCreate = async () => {
                setCreating(true);
                try {
                    const body = { ...form };
                    if (!body.city) delete body.city;
                    if (!body.accountType) delete body.accountType;
                    if (!body.ageRange) delete body.ageRange;
                    if (!body.gender) delete body.gender;
                    await api('/contacts', { method: 'POST', body: JSON.stringify(body) });
                    setShowAddModal(false); setForm({ name: '', phone: '', email: '', category: 'ACTIVE', city: '', accountType: '', ageRange: '', gender: '' }); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce contact ?')) return;
                try { await api('/contacts/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const handleImport = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData(); fd.append('file', file);
                try {
                    const res = await api('/contacts/import', { method: 'POST', body: fd });
                    alert('Importes: ' + (res.imported || 0) + ' | Echoues: ' + (res.failed || 0));
                    setShowImportModal(false); refetch();
                } catch (err) { alert('Erreur import: ' + err.message); }
            };

            const openEditContact = (contact) => {
                setEditForm({
                    name: contact.name || '',
                    email: contact.email || '',
                    category: contact.category || 'ACTIVE',
                    city: contact.city || '',
                    accountType: contact.accountType || '',
                    ageRange: contact.ageRange || '',
                    gender: contact.gender || '',
                    engagementScore: contact.engagementScore || 0
                });
                setEditContact(contact);
            };

            const handleEditContact = async () => {
                setSaving(true);
                try {
                    const body = { ...editForm };
                    if (!body.city) delete body.city;
                    if (!body.accountType) delete body.accountType;
                    if (!body.ageRange) delete body.ageRange;
                    if (!body.gender) delete body.gender;
                    body.engagementScore = parseInt(body.engagementScore) || 0;
                    await api('/contacts/' + editContact.id, { method: 'PUT', body: JSON.stringify(body) });
                    setEditContact(null);
                    refetch();
                } catch (err) { alert(err.message); }
                finally { setSaving(false); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-2 flex-wrap">
                            <Input placeholder="Rechercher un contact..." icon={Icons.Search} className="w-56" value={search} onChange={setSearch} />
                            <Select value={categoryFilter} onChange={setCategoryFilter} options={[{ value: '', label: 'Categorie' }, { value: 'ACTIVE', label: 'Actifs' }, { value: 'INACTIVE', label: 'Inactifs' }, { value: 'NEW', label: 'Nouveaux' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                            <Select value={accountTypeFilter} onChange={setAccountTypeFilter} options={[{ value: '', label: 'Type compte' }, { value: 'EPARGNE', label: 'Epargne' }, { value: 'COURANT', label: 'Courant' }, { value: 'PROFESSIONNEL', label: 'Pro' }, { value: 'JEUNE', label: 'Jeune' }]} />
                            <Input placeholder="Ville..." className="w-32" value={cityFilter} onChange={setCityFilter} />
                        </div>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={() => setShowImportModal(true)} icon={Icons.Upload}>Importer</Button>
                            <Button icon={Icons.Plus} onClick={() => setShowAddModal(true)}>Ajouter</Button>
                        </div>
                    </div>

                    <Card>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead><tr className="border-b border-gray-200"><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Contact</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Telephone</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Ville</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Age</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Categorie</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Compte</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Engagement</th><th className="text-left py-3 px-4 text-sm font-medium text-gray-500">Opt-in</th><th className="text-right py-3 px-4 text-sm font-medium text-gray-500">Actions</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {contacts.length === 0 && <tr><td colSpan="9" className="py-8 text-center text-gray-500">Aucun contact</td></tr>}
                                    {contacts.map(contact => (
                                        <tr key={contact.id} className="hover:bg-gray-50">
                                            <td className="py-4 px-4"><div className="flex items-center gap-3"><div className="w-10 h-10 bg-bgfi-primary/10 rounded-full flex items-center justify-center text-bgfi-primary font-semibold">{(contact.name || '?').split(' ').map(n => n[0]).join('').substring(0,2)}</div><div><span className="font-medium text-gray-900 block">{contact.name || '-'}</span><span className="text-xs text-gray-500">{contact.email || ''}</span></div></div></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{contact.phone}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{contact.city || '-'}</td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{contact.ageRange || '-'}</td>
                                            <td className="py-4 px-4"><Badge variant={categoryVariant[contact.category] || 'default'}>{categoryMap[contact.category] || contact.category}</Badge></td>
                                            <td className="py-4 px-4 text-sm text-gray-600">{accountTypeMap[contact.accountType] || contact.accountType || '-'}</td>
                                            <td className="py-4 px-4"><div className="flex items-center gap-2"><div className="w-16 bg-gray-200 rounded-full h-2"><div className="h-2 rounded-full" style={{width: (contact.engagementScore || 0) + '%', backgroundColor: (contact.engagementScore || 0) >= 70 ? '#16a34a' : (contact.engagementScore || 0) >= 40 ? '#f59e0b' : '#ef4444'}} /></div><span className="text-xs text-gray-500">{contact.engagementScore || 0}</span></div></td>
                                            <td className="py-4 px-4"><Badge variant={contact.optedIn ? 'success' : 'danger'}>{contact.optedIn ? 'Oui' : 'Non'}</Badge></td>
                                            <td className="py-4 px-4 text-right"><div className="flex items-center justify-end gap-2"><Button variant="ghost" size="sm" icon={Icons.Edit} onClick={() => openEditContact(contact)} /><Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(contact.id)} /></div></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {data?.pagination && <div className="mt-4 text-sm text-gray-500 text-center">{data.pagination.total} contacts au total</div>}
                    </Card>

                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Ajouter un Contact</h2>
                                    <button onClick={() => setShowAddModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom" placeholder="Jean Dupont" value={form.name} onChange={v => setForm({...form, name: v})} />
                                        <Input label="Telephone" placeholder="+24174000001" value={form.phone} onChange={v => setForm({...form, phone: v})} icon={Icons.Phone} />
                                    </div>
                                    <Input label="Email" placeholder="jean@email.com" value={form.email} onChange={v => setForm({...form, email: v})} icon={Icons.Mail} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Categorie" value={form.category} onChange={v => setForm({...form, category: v})} options={[{ value: 'ACTIVE', label: 'Actif' }, { value: 'INACTIVE', label: 'Inactif' }, { value: 'NEW', label: 'Nouveau' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                                        <Input label="Ville" placeholder="Libreville" value={form.city} onChange={v => setForm({...form, city: v})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Type de compte" value={form.accountType} onChange={v => setForm({...form, accountType: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'EPARGNE', label: 'Epargne' }, { value: 'COURANT', label: 'Courant' }, { value: 'PROFESSIONNEL', label: 'Professionnel' }, { value: 'JEUNE', label: 'Jeune' }]} />
                                        <Select label="Tranche d'age" value={form.ageRange} onChange={v => setForm({...form, ageRange: v})} options={[{ value: '', label: 'Selectionner...' }, { value: '18-25', label: '18-25 ans' }, { value: '26-35', label: '26-35 ans' }, { value: '36-45', label: '36-45 ans' }, { value: '46-55', label: '46-55 ans' }, { value: '56+', label: '56+ ans' }]} />
                                    </div>
                                    <Select label="Genre" value={form.gender} onChange={v => setForm({...form, gender: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'M', label: 'Masculin' }, { value: 'F', label: 'Feminin' }, { value: 'AUTRE', label: 'Autre' }]} />
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowAddModal(false)}>Annuler</Button>
                                    <Button onClick={handleCreate} disabled={creating || !form.phone} icon={Icons.CheckCircle}>{creating ? 'Ajout...' : 'Ajouter'}</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showImportModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-lg w-full">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Importer des Contacts</h2>
                                    <button onClick={() => setShowImportModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-bgfi-primary hover:bg-blue-50 transition-colors cursor-pointer" onClick={() => document.getElementById('csv-upload').click()}>
                                        <input type="file" id="csv-upload" className="hidden" accept=".csv,.xlsx" onChange={handleImport} />
                                        <div className="w-16 h-16 bg-bgfi-primary/10 rounded-full flex items-center justify-center text-bgfi-primary mx-auto mb-4"><Icons.Upload /></div>
                                        <p className="font-medium text-gray-900">Deposez votre fichier ici</p>
                                        <p className="text-sm text-gray-500 mt-1">CSV ou Excel (max 10MB)</p>
                                    </div>
                                    <div className="bg-gray-50 p-4 rounded-xl"><p className="text-sm font-medium text-gray-700 mb-2">Format attendu :</p><code className="text-xs text-gray-600 block">phone, name, email, category, city, accountType, ageRange, gender</code></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowImportModal(false)}>Fermer</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {editContact && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Modifier le Contact</h2>
                                    <button onClick={() => setEditContact(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="bg-gray-50 rounded-xl p-3 flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-bgfi-primary/10 rounded-full flex items-center justify-center text-bgfi-primary font-semibold">{(editContact.name || '?').split(' ').map(n => n[0]).join('').substring(0,2)}</div>
                                        <div><span className="font-medium text-gray-900 block">{editContact.phone}</span><span className="text-xs text-gray-500">ID: {editContact.id.substring(0,8)}...</span></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom" value={editForm.name} onChange={v => setEditForm({...editForm, name: v})} />
                                        <Input label="Email" value={editForm.email} onChange={v => setEditForm({...editForm, email: v})} icon={Icons.Mail} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Categorie" value={editForm.category} onChange={v => setEditForm({...editForm, category: v})} options={[{ value: 'ACTIVE', label: 'Actif' }, { value: 'INACTIVE', label: 'Inactif' }, { value: 'NEW', label: 'Nouveau' }, { value: 'VIP', label: 'VIP' }, { value: 'PREMIUM', label: 'Premium' }]} />
                                        <Input label="Ville" value={editForm.city} onChange={v => setEditForm({...editForm, city: v})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Type de compte" value={editForm.accountType} onChange={v => setEditForm({...editForm, accountType: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'EPARGNE', label: 'Epargne' }, { value: 'COURANT', label: 'Courant' }, { value: 'PROFESSIONNEL', label: 'Professionnel' }, { value: 'JEUNE', label: 'Jeune' }]} />
                                        <Select label="Tranche d'age" value={editForm.ageRange} onChange={v => setEditForm({...editForm, ageRange: v})} options={[{ value: '', label: 'Selectionner...' }, { value: '18-25', label: '18-25 ans' }, { value: '26-35', label: '26-35 ans' }, { value: '36-45', label: '36-45 ans' }, { value: '46-55', label: '46-55 ans' }, { value: '56+', label: '56+ ans' }]} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Select label="Genre" value={editForm.gender} onChange={v => setEditForm({...editForm, gender: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'M', label: 'Masculin' }, { value: 'F', label: 'Feminin' }, { value: 'AUTRE', label: 'Autre' }]} />
                                        <Input label="Score engagement" type="number" value={editForm.engagementScore} onChange={v => setEditForm({...editForm, engagementScore: v})} />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setEditContact(null)}>Annuler</Button>
                                    <Button onClick={handleEditContact} disabled={saving} icon={Icons.CheckCircle}>{saving ? 'Sauvegarde...' : 'Sauvegarder'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Human-readable criteria helper
        // =============================================
        const criteriaToText = (criteria) => {
            if (!criteria?.rules?.length) return 'Aucun critere';
            const fieldLabels = { category: 'Categorie', city: 'Ville', country: 'Pays', ageRange: "Tranche d'age", gender: 'Genre', language: 'Langue', accountType: 'Type de compte', engagementScore: 'Score engagement', status: 'Statut', tags: 'Tags', optedIn: 'Opt-in', registrationDate: "Date inscription", lastActivity: 'Derniere activite' };
            const opLabels = { eq: '=', neq: '!=', gt: '>', gte: '>=', lt: '<', lte: '<=', in: 'dans', nin: 'pas dans', contains: 'contient', isNull: 'est vide', isNotNull: 'existe' };
            const parts = criteria.rules.map(r => {
                const fl = fieldLabels[r.field] || r.field;
                const ol = opLabels[r.op] || r.op;
                const val = Array.isArray(r.value) ? r.value.join(', ') : r.value;
                return `${fl} ${ol} ${val}`;
            });
            const join = criteria.operator === 'OR' ? ' OU ' : ' ET ';
            return parts.join(join);
        };

        // =============================================
        // Segment Detail Panel (contacts + insights + edit)
        // =============================================
        const SegmentDetailPanel = ({ segment, onClose, onRefresh }) => {
            const [tab, setTab] = useState('contacts');
            const [contactsPage, setContactsPage] = useState(1);
            const [contactSearch, setContactSearch] = useState('');
            const [contacts, setContacts] = useState(null);
            const [insights, setInsights] = useState(null);
            const [loadingContacts, setLoadingContacts] = useState(false);
            const [loadingInsights, setLoadingInsights] = useState(false);
            const [showEdit, setShowEdit] = useState(false);
            const [editForm, setEditForm] = useState({ name: segment.name, description: segment.description || '', criteria: segment.criteria });
            const [editPreview, setEditPreview] = useState(null);
            const [saving, setSaving] = useState(false);
            const [evaluating, setEvaluating] = useState(false);

            // Fetch contacts
            const fetchContacts = useCallback(async () => {
                setLoadingContacts(true);
                try {
                    const q = new URLSearchParams({ page: contactsPage, limit: 10 });
                    if (contactSearch) q.set('search', contactSearch);
                    const res = await api(`/segments/${segment.id}/contacts?${q}`);
                    setContacts(res);
                } catch { setContacts(null); }
                finally { setLoadingContacts(false); }
            }, [segment.id, contactsPage, contactSearch]);

            // Fetch insights
            const fetchInsights = useCallback(async () => {
                setLoadingInsights(true);
                try {
                    const res = await api(`/segments/${segment.id}/insights`);
                    setInsights(res);
                } catch { setInsights(null); }
                finally { setLoadingInsights(false); }
            }, [segment.id]);

            useEffect(() => { fetchContacts(); }, [fetchContacts]);
            useEffect(() => { if (tab === 'insights') fetchInsights(); }, [tab, fetchInsights]);

            // Debounced edit preview
            const editTimer = useRef(null);
            useEffect(() => {
                if (!showEdit || editForm.criteria.rules.length === 0) { setEditPreview(null); return; }
                clearTimeout(editTimer.current);
                editTimer.current = setTimeout(async () => {
                    try {
                        const res = await api('/segments/preview', { method: 'POST', body: JSON.stringify({ criteria: editForm.criteria }) });
                        setEditPreview(res.contactCount);
                    } catch { setEditPreview(null); }
                }, 500);
                return () => clearTimeout(editTimer.current);
            }, [showEdit, editForm.criteria]);

            const handleSave = async () => {
                setSaving(true);
                try {
                    await api(`/segments/${segment.id}`, { method: 'PUT', body: JSON.stringify(editForm) });
                    setShowEdit(false);
                    onRefresh();
                } catch (err) { alert(err.message); }
                finally { setSaving(false); }
            };

            const handleEvaluate = async () => {
                setEvaluating(true);
                try { await api(`/segments/${segment.id}/evaluate`, { method: 'POST' }); onRefresh(); fetchContacts(); if (tab === 'insights') fetchInsights(); }
                catch (err) { alert(err.message); }
                finally { setEvaluating(false); }
            };

            const INSIGHT_COLORS = ['#1e3a5f', '#2d5a87', '#3b82f6', '#00a86b', '#8b5cf6', '#f59e0b', '#ec4899', '#14b8a6'];

            return (
                <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl sm:rounded-2xl w-full max-w-4xl max-h-[92vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        {/* Header */}
                        <div className="p-5 border-b border-gray-200 flex items-start justify-between shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center text-white" style={{ background: 'linear-gradient(135deg, #1e3a5f, #3b82f6)' }}><Icons.Layers /></div>
                                <div>
                                    <h2 className="text-lg font-bold text-gray-900">{segment.name}</h2>
                                    <div className="flex items-center gap-2 mt-0.5">
                                        <Badge variant={segment.type === 'DYNAMIC' ? 'info' : segment.type === 'BANK_CRITERIA' ? 'primary' : 'default'}>{segment.type}</Badge>
                                        <span className="text-sm text-gray-500">{segment.contactCount} contacts</span>
                                        {segment.lastEvaluatedAt && <span className="text-xs text-gray-400">Evalue {new Date(segment.lastEvaluatedAt).toLocaleDateString('fr-FR')}</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <Button variant="secondary" size="sm" icon={Icons.RefreshCw} onClick={handleEvaluate} disabled={evaluating}>{evaluating ? '...' : 'Re-evaluer'}</Button>
                                <Button variant="secondary" size="sm" icon={Icons.Edit} onClick={() => setShowEdit(true)}>Editer</Button>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 ml-2"><Icons.X /></button>
                            </div>
                        </div>

                        {/* Criteria summary */}
                        <div className="px-5 py-3 bg-gray-50 border-b border-gray-200 shrink-0">
                            <p className="text-xs font-medium text-gray-500 mb-1">Criteres de ciblage</p>
                            <div className="flex flex-wrap gap-1.5">
                                {(segment.criteria?.rules || []).map((r, i) => {
                                    const fl = { category: 'Categorie', city: 'Ville', ageRange: 'Age', gender: 'Genre', accountType: 'Compte', engagementScore: 'Score', status: 'Statut', language: 'Langue', country: 'Pays', tags: 'Tags', optedIn: 'Opt-in' };
                                    const ol = { eq: '=', neq: '!=', gt: '>', gte: '>=', lt: '<', lte: '<=', in: 'dans', contains: '~' };
                                    const val = Array.isArray(r.value) ? r.value.join(', ') : r.value;
                                    return (
                                        <React.Fragment key={i}>
                                            {i > 0 && <span className="text-xs font-bold px-1.5 py-1 rounded bg-bgfi-primary/10 text-bgfi-primary">{segment.criteria.operator}</span>}
                                            <span className="inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-white border border-gray-200 shadow-sm">
                                                <span className="font-medium text-gray-700">{fl[r.field] || r.field}</span>
                                                <span className="text-gray-400">{ol[r.op] || r.op}</span>
                                                <span className="font-semibold text-bgfi-primary">{String(val)}</span>
                                            </span>
                                        </React.Fragment>
                                    );
                                })}
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="flex border-b border-gray-200 shrink-0">
                            {[{ id: 'contacts', label: 'Contacts', icon: Icons.Users }, { id: 'insights', label: 'Insights', icon: Icons.BarChart3 }].map(t => (
                                <button key={t.id} onClick={() => setTab(t.id)} className={`flex items-center gap-2 px-5 py-3 text-sm font-medium border-b-2 transition-colors ${tab === t.id ? 'border-bgfi-primary text-bgfi-primary' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                    <t.icon className="w-4 h-4" />{t.label}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-auto p-5">
                            {tab === 'contacts' && (
                                <div className="space-y-4">
                                    <div className="flex items-center gap-3">
                                        <Input placeholder="Rechercher dans ce segment..." icon={Icons.Search} className="flex-1" value={contactSearch} onChange={v => { setContactSearch(v); setContactsPage(1); }} />
                                        <span className="text-sm text-gray-500 whitespace-nowrap">{contacts?.pagination?.total || 0} resultats</span>
                                    </div>
                                    {loadingContacts ? <Spinner /> : contacts?.data?.length > 0 ? (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead><tr className="border-b border-gray-200">
                                                    <th className="text-left py-3 px-3 font-medium text-gray-500">Contact</th>
                                                    <th className="text-left py-3 px-3 font-medium text-gray-500">Ville</th>
                                                    <th className="text-left py-3 px-3 font-medium text-gray-500">Compte</th>
                                                    <th className="text-left py-3 px-3 font-medium text-gray-500">Engagement</th>
                                                    <th className="text-left py-3 px-3 font-medium text-gray-500">Tags</th>
                                                </tr></thead>
                                                <tbody>
                                                    {contacts.data.map(c => (
                                                        <tr key={c.id} className="border-b border-gray-100 hover:bg-gray-50">
                                                            <td className="py-3 px-3">
                                                                <p className="font-medium text-gray-900">{c.name || 'Sans nom'}</p>
                                                                <p className="text-xs text-gray-400">{c.phone}</p>
                                                            </td>
                                                            <td className="py-3 px-3 text-gray-600">{c.city || '-'}</td>
                                                            <td className="py-3 px-3"><Badge variant="default">{c.accountType || '-'}</Badge></td>
                                                            <td className="py-3 px-3">
                                                                <div className="flex items-center gap-2">
                                                                    <div className="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                                        <div className="h-full rounded-full" style={{ width: (c.engagementScore || 0) + '%', background: (c.engagementScore || 0) >= 70 ? '#00a86b' : (c.engagementScore || 0) >= 40 ? '#f59e0b' : '#ef4444' }} />
                                                                    </div>
                                                                    <span className="text-xs font-medium">{c.engagementScore || 0}</span>
                                                                </div>
                                                            </td>
                                                            <td className="py-3 px-3">
                                                                <div className="flex flex-wrap gap-1">{(c.tags || []).slice(0, 2).map((t, i) => <span key={i} className="text-xs px-2 py-0.5 bg-gray-100 rounded-full text-gray-600">{t}</span>)}</div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                            {contacts.pagination.totalPages > 1 && (
                                                <div className="flex items-center justify-center gap-2 mt-4">
                                                    <Button variant="secondary" size="sm" disabled={contactsPage <= 1} onClick={() => setContactsPage(p => p - 1)}>Precedent</Button>
                                                    <span className="text-sm text-gray-500">Page {contactsPage} / {contacts.pagination.totalPages}</span>
                                                    <Button variant="secondary" size="sm" disabled={contactsPage >= contacts.pagination.totalPages} onClick={() => setContactsPage(p => p + 1)}>Suivant</Button>
                                                </div>
                                            )}
                                        </div>
                                    ) : <p className="text-center text-gray-400 py-8">Aucun contact dans ce segment</p>}
                                </div>
                            )}

                            {tab === 'insights' && (
                                <div className="space-y-6">
                                    {loadingInsights ? <Spinner /> : insights ? (
                                        <>
                                            {/* KPI row */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div className="bg-gradient-to-br from-blue-50 to-blue-100/50 rounded-xl p-4 text-center">
                                                    <p className="text-2xl font-bold text-bgfi-primary">{insights.total}</p>
                                                    <p className="text-xs text-gray-500 mt-1">Contacts totaux</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-green-50 to-green-100/50 rounded-xl p-4 text-center">
                                                    <p className="text-2xl font-bold text-emerald-600">{insights.averageEngagement}%</p>
                                                    <p className="text-xs text-gray-500 mt-1">Engagement moyen</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-xl p-4 text-center">
                                                    <p className="text-2xl font-bold text-purple-600">{insights.byCity?.length || 0}</p>
                                                    <p className="text-xs text-gray-500 mt-1">Villes couvertes</p>
                                                </div>
                                                <div className="bg-gradient-to-br from-amber-50 to-amber-100/50 rounded-xl p-4 text-center">
                                                    <p className="text-2xl font-bold text-amber-600">{insights.byAccountType?.length || 0}</p>
                                                    <p className="text-xs text-gray-500 mt-1">Types de compte</p>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {/* City distribution */}
                                                {insights.byCity?.length > 0 && (
                                                    <Card title="Repartition geographique">
                                                        <div className="space-y-2">
                                                            {insights.byCity.map((c, i) => (
                                                                <div key={c.name} className="flex items-center gap-3">
                                                                    <span className="text-sm text-gray-600 w-28 truncate">{c.name}</span>
                                                                    <div className="flex-1 h-6 bg-gray-100 rounded-full overflow-hidden">
                                                                        <div className="h-full rounded-full flex items-center justify-end px-2" style={{ width: Math.max(15, (c.count / insights.total * 100)) + '%', backgroundColor: INSIGHT_COLORS[i % INSIGHT_COLORS.length] }}>
                                                                            <span className="text-xs font-bold text-white">{c.count}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </Card>
                                                )}

                                                {/* Account type PieChart */}
                                                {insights.byAccountType?.length > 0 && (
                                                    <Card title="Types de compte">
                                                        <div style={{ height: 200 }}>
                                                            <ResponsiveContainer>
                                                                <PieChart>
                                                                    <Pie data={insights.byAccountType.map((a, i) => ({ ...a, fill: INSIGHT_COLORS[i % INSIGHT_COLORS.length] }))} dataKey="count" nameKey="name" cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={3}>
                                                                        {insights.byAccountType.map((_, i) => <Cell key={i} fill={INSIGHT_COLORS[i % INSIGHT_COLORS.length]} />)}
                                                                    </Pie>
                                                                    <Tooltip formatter={(v, n) => [v + ' contacts', n]} />
                                                                    <Legend iconType="circle" wrapperStyle={{ fontSize: 12 }} />
                                                                </PieChart>
                                                            </ResponsiveContainer>
                                                        </div>
                                                    </Card>
                                                )}

                                                {/* Age distribution */}
                                                {insights.byAgeRange?.length > 0 && (
                                                    <Card title="Tranches d'age">
                                                        <div style={{ height: 200 }}>
                                                            <ResponsiveContainer>
                                                                <BarChart data={insights.byAgeRange} layout="vertical" margin={{ left: 10, right: 20 }}>
                                                                    <XAxis type="number" hide />
                                                                    <YAxis type="category" dataKey="name" width={50} tick={{ fontSize: 12 }} />
                                                                    <Tooltip formatter={(v) => [v + ' contacts']} />
                                                                    <Bar dataKey="count" radius={6}>
                                                                        {insights.byAgeRange.map((_, i) => <Cell key={i} fill={INSIGHT_COLORS[i % INSIGHT_COLORS.length]} />)}
                                                                    </Bar>
                                                                </BarChart>
                                                            </ResponsiveContainer>
                                                        </div>
                                                    </Card>
                                                )}

                                                {/* Gender split */}
                                                {insights.byGender?.length > 0 && (
                                                    <Card title="Repartition par genre">
                                                        <div className="flex items-center justify-center gap-6 py-4">
                                                            {insights.byGender.map((g, i) => {
                                                                const pct = insights.total > 0 ? Math.round(g.count / insights.total * 100) : 0;
                                                                const labels = { M: 'Homme', F: 'Femme', AUTRE: 'Autre' };
                                                                return (
                                                                    <div key={g.name} className="text-center">
                                                                        <div className="w-20 h-20 rounded-full flex items-center justify-center text-white text-lg font-bold mx-auto" style={{ background: INSIGHT_COLORS[i % INSIGHT_COLORS.length] }}>{pct}%</div>
                                                                        <p className="text-sm font-medium text-gray-700 mt-2">{labels[g.name] || g.name}</p>
                                                                        <p className="text-xs text-gray-400">{g.count} contacts</p>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </Card>
                                                )}
                                            </div>
                                        </>
                                    ) : <p className="text-center text-gray-400 py-8">Impossible de charger les insights</p>}
                                </div>
                            )}
                        </div>

                        {/* Edit modal */}
                        {showEdit && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={() => setShowEdit(false)}>
                                <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto" onClick={e => e.stopPropagation()}>
                                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                        <h2 className="text-xl font-semibold text-gray-900">Editer le segment</h2>
                                        <button onClick={() => setShowEdit(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                    </div>
                                    <div className="p-6 space-y-4">
                                        <Input label="Nom" value={editForm.name} onChange={v => setEditForm({...editForm, name: v})} />
                                        <Input label="Description" value={editForm.description} onChange={v => setEditForm({...editForm, description: v})} />
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">Criteres</label>
                                            <SegmentBuilder criteria={editForm.criteria} onChange={c => setEditForm({...editForm, criteria: c})} previewCount={editPreview} />
                                        </div>
                                    </div>
                                    <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                        <Button variant="secondary" onClick={() => setShowEdit(false)}>Annuler</Button>
                                        <Button onClick={handleSave} disabled={saving || !editForm.name} icon={Icons.CheckCircle}>{saving ? 'Sauvegarde...' : 'Sauvegarder'}</Button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =============================================
        // Segments View (complete redesign)
        // =============================================
        const SegmentsView = () => {
            const { data, loading, error, refetch } = useApi('/segments?limit=50');
            const [showCreate, setShowCreate] = useState(false);
            const [selectedSegment, setSelectedSegment] = useState(null);
            const [form, setForm] = useState({ name: '', description: '', criteria: { operator: 'AND', rules: [] } });
            const [creating, setCreating] = useState(false);
            const [previewCount, setPreviewCount] = useState(null);
            // AI assistant
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [aiError, setAiError] = useState('');

            const segments = data?.data || [];

            // Debounced preview
            const timer = useRef(null);
            useEffect(() => {
                if (form.criteria.rules.length === 0) { setPreviewCount(null); return; }
                clearTimeout(timer.current);
                timer.current = setTimeout(async () => {
                    try {
                        const res = await api('/segments/preview', { method: 'POST', body: JSON.stringify({ criteria: form.criteria }) });
                        setPreviewCount(res.contactCount);
                    } catch { setPreviewCount(null); }
                }, 500);
                return () => clearTimeout(timer.current);
            }, [form.criteria]);

            const handleCreate = async () => {
                setCreating(true);
                try {
                    await api('/segments', { method: 'POST', body: JSON.stringify(form) });
                    setShowCreate(false); setForm({ name: '', description: '', criteria: { operator: 'AND', rules: [] } }); setAiPrompt(''); setAiError(''); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce segment ?')) return;
                try { await api('/segments/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const handleAiSuggest = async () => {
                if (!aiPrompt.trim()) return;
                setAiLoading(true); setAiError('');
                try {
                    const res = await api('/segments/ai-suggest', { method: 'POST', body: JSON.stringify({ prompt: aiPrompt }) });
                    setForm({ name: res.name || '', description: res.description || '', criteria: res.criteria || { operator: 'AND', rules: [] } });
                    setPreviewCount(res.contactCount);
                } catch (err) { setAiError(err.message || 'Erreur IA'); }
                finally { setAiLoading(false); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            // Refresh a segment after edit (re-fetch list and update selected)
            const handleSegmentRefresh = async () => {
                await refetch();
                if (selectedSegment) {
                    try {
                        const updated = await api(`/segments/${selectedSegment.id}`);
                        setSelectedSegment(updated);
                    } catch {}
                }
            };

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-900">Segments de ciblage</h2>
                            <p className="text-sm text-gray-500 mt-0.5">{segments.length} segment(s) - Cliquez pour explorer</p>
                        </div>
                        <Button icon={Icons.Plus} onClick={() => setShowCreate(true)}>Nouveau Segment</Button>
                    </div>

                    {/* Segment cards grid */}
                    {segments.length === 0 ? (
                        <div className="text-center py-16">
                            <div className="w-16 h-16 bg-gray-100 rounded-2xl flex items-center justify-center mx-auto mb-4"><Icons.Layers className="text-gray-400" /></div>
                            <h3 className="text-lg font-semibold text-gray-700">Aucun segment</h3>
                            <p className="text-gray-500 mt-1 mb-4">Creez votre premier segment pour cibler vos campagnes intelligemment</p>
                            <Button icon={Icons.Plus} onClick={() => setShowCreate(true)}>Creer un segment</Button>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {segments.map(seg => (
                                <div key={seg.id} className="group bg-white rounded-2xl border border-gray-200 hover:border-bgfi-primary/40 hover:shadow-lg transition-all cursor-pointer p-5" onClick={() => setSelectedSegment(seg)}>
                                    <div className="flex items-start justify-between mb-3">
                                        <div className="flex items-center gap-3">
                                            <div className="w-11 h-11 rounded-xl flex items-center justify-center text-white" style={{ background: seg.type === 'BANK_CRITERIA' ? 'linear-gradient(135deg, #00a86b, #2d5a87)' : seg.type === 'STATIC' ? 'linear-gradient(135deg, #8b5cf6, #6d28d9)' : 'linear-gradient(135deg, #1e3a5f, #3b82f6)' }}><Icons.Layers /></div>
                                            <div>
                                                <p className="font-semibold text-gray-900 group-hover:text-bgfi-primary transition-colors">{seg.name}</p>
                                                <Badge variant={seg.type === 'DYNAMIC' ? 'info' : seg.type === 'BANK_CRITERIA' ? 'primary' : 'default'}>{seg.type === 'BANK_CRITERIA' ? 'Bancaire' : seg.type === 'DYNAMIC' ? 'Dynamique' : 'Statique'}</Badge>
                                            </div>
                                        </div>
                                        <button className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-all p-1" onClick={e => { e.stopPropagation(); handleDelete(seg.id); }} title="Supprimer"><Icons.Trash2 /></button>
                                    </div>
                                    {seg.description && <p className="text-sm text-gray-500 mb-3 line-clamp-2">{seg.description}</p>}
                                    {/* Criteria pills */}
                                    <div className="flex flex-wrap gap-1 mb-3">
                                        {(seg.criteria?.rules || []).slice(0, 3).map((r, i) => {
                                            const fl = { category: 'Cat.', city: 'Ville', ageRange: 'Age', accountType: 'Compte', engagementScore: 'Score', gender: 'Genre', status: 'Statut' };
                                            const val = Array.isArray(r.value) ? r.value.join(',') : r.value;
                                            return <span key={i} className="text-[11px] px-2 py-0.5 bg-gray-100 rounded-full text-gray-600">{fl[r.field] || r.field}: {String(val).substring(0, 15)}</span>;
                                        })}
                                        {(seg.criteria?.rules?.length || 0) > 3 && <span className="text-[11px] px-2 py-0.5 bg-gray-100 rounded-full text-gray-400">+{seg.criteria.rules.length - 3}</span>}
                                    </div>
                                    {/* Footer */}
                                    <div className="flex items-center justify-between pt-3 border-t border-gray-100">
                                        <div className="flex items-center gap-1.5">
                                            <Icons.Users className="w-4 h-4 text-bgfi-primary" />
                                            <span className="text-sm font-bold text-bgfi-primary">{seg.contactCount}</span>
                                            <span className="text-xs text-gray-400">contacts</span>
                                        </div>
                                        <span className="text-xs text-gray-400">{seg.lastEvaluatedAt ? new Date(seg.lastEvaluatedAt).toLocaleDateString('fr-FR') : 'Non evalue'}</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Detail panel */}
                    {selectedSegment && (
                        <SegmentDetailPanel segment={selectedSegment} onClose={() => setSelectedSegment(null)} onRefresh={handleSegmentRefresh} />
                    )}

                    {/* Create modal with AI assistant */}
                    {showCreate && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={() => setShowCreate(false)}>
                            <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[92vh] overflow-auto" onClick={e => e.stopPropagation()}>
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <div>
                                        <h2 className="text-xl font-semibold text-gray-900">Nouveau Segment</h2>
                                        <p className="text-sm text-gray-500 mt-0.5">Utilisez l'assistant IA ou construisez manuellement</p>
                                    </div>
                                    <button onClick={() => setShowCreate(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>

                                {/* AI Assistant section */}
                                <div className="px-6 pt-5 pb-4">
                                    <div className="bg-gradient-to-r from-bgfi-primary/5 to-blue-50 rounded-xl p-4 border border-bgfi-primary/10">
                                        <div className="flex items-center gap-2 mb-3">
                                            <div className="w-8 h-8 rounded-lg bg-bgfi-primary flex items-center justify-center"><Icons.Bot className="text-white w-4 h-4" /></div>
                                            <div>
                                                <p className="text-sm font-semibold text-gray-900">Assistant IA</p>
                                                <p className="text-xs text-gray-500">Decrivez votre cible en langage naturel</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <input type="text" className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-bgfi-primary/30 focus:border-bgfi-primary" placeholder='Ex: "Clients VIP a Libreville avec un score > 80"' value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAiSuggest()} disabled={aiLoading} />
                                            <Button onClick={handleAiSuggest} disabled={aiLoading || !aiPrompt.trim()} size="sm">{aiLoading ? 'Analyse...' : 'Generer'}</Button>
                                        </div>
                                        {aiError && <p className="text-xs text-red-500 mt-2">{aiError}</p>}
                                        {/* Quick suggestions */}
                                        <div className="flex flex-wrap gap-1.5 mt-3">
                                            {['Clients actifs a Libreville', 'Jeunes 18-25 ans avec compte epargne', 'VIP et Premium fort engagement', 'Clients inactifs a reactiver'].map(s => (
                                                <button key={s} className="text-xs px-2.5 py-1 bg-white rounded-full border border-gray-200 text-gray-600 hover:border-bgfi-primary hover:text-bgfi-primary transition-colors" onClick={() => { setAiPrompt(s); }}>{s}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Divider */}
                                <div className="px-6"><div className="flex items-center gap-3"><div className="flex-1 h-px bg-gray-200" /><span className="text-xs text-gray-400 font-medium">ou construisez manuellement</span><div className="flex-1 h-px bg-gray-200" /></div></div>

                                <div className="p-6 space-y-4">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <Input label="Nom du segment" placeholder="Ex: Clients actifs Libreville" value={form.name} onChange={v => setForm({...form, name: v})} />
                                        <Input label="Description" placeholder="Description optionnelle" value={form.description} onChange={v => setForm({...form, description: v})} />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Criteres de ciblage</label>
                                        <SegmentBuilder criteria={form.criteria} onChange={c => setForm({...form, criteria: c})} previewCount={previewCount} />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex items-center justify-between">
                                    <div>{previewCount !== null && <span className="text-sm text-gray-500"><span className="font-bold text-bgfi-primary">{previewCount}</span> contact(s) cibles</span>}</div>
                                    <div className="flex gap-3">
                                        <Button variant="secondary" onClick={() => setShowCreate(false)}>Annuler</Button>
                                        <Button onClick={handleCreate} disabled={creating || !form.name || form.criteria.rules.length === 0} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Creer le segment'}</Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Templates View
        // =============================================
        const TemplatesView = () => {
            const [showCreateModal, setShowCreateModal] = useState(false);
            const { data, loading, error, refetch } = useApi('/templates?limit=50');
            const [form, setForm] = useState({ name: '', displayName: '', category: '', content: '', language: 'fr' });
            const [creating, setCreating] = useState(false);

            const templates = data?.data || [];

            const handleCreate = async () => {
                setCreating(true);
                try {
                    await api('/templates', { method: 'POST', body: JSON.stringify(form) });
                    setShowCreateModal(false); setForm({ name: '', displayName: '', category: '', content: '', language: 'fr' }); refetch();
                } catch (err) { alert(err.message); }
                finally { setCreating(false); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Supprimer ce template ?')) return;
                try { await api('/templates/' + id, { method: 'DELETE' }); refetch(); }
                catch (err) { alert(err.message); }
            };

            const [syncing, setSyncing] = useState(false);
            const handleSyncAll = async () => {
                setSyncing(true);
                try {
                    const result = await api('/templates/sync-all', { method: 'POST' });
                    alert(`Synchronisation terminee : ${result.synced} mis a jour, ${result.created} importes`);
                    refetch();
                } catch (err) { alert(err.message); }
                finally { setSyncing(false); }
            };

            const [dupModal, setDupModal] = useState(null);
            const [dupForm, setDupForm] = useState({ name: '', displayName: '', category: '', content: '' });
            const [duplicating, setDuplicating] = useState(false);

            const openDuplicate = (template) => {
                setDupForm({
                    name: template.name + '_v2',
                    displayName: (template.displayName || template.name) + ' (v2)',
                    category: template.category,
                    content: template.content
                });
                setDupModal(template);
            };

            const handleDuplicate = async () => {
                setDuplicating(true);
                try {
                    await api('/templates/' + dupModal.id + '/duplicate', { method: 'POST', body: JSON.stringify(dupForm) });
                    setDupModal(null); refetch();
                } catch (err) { alert(err.message); }
                finally { setDuplicating(false); }
            };

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;

            return (
                <div className="space-y-6">
                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div className="flex items-center gap-4"><Input placeholder="Rechercher un template..." icon={Icons.Search} className="w-64" /></div>
                        <div className="flex gap-2">
                            <Button variant="secondary" onClick={handleSyncAll} disabled={syncing} icon={Icons.RefreshCw}>{syncing ? 'Synchronisation...' : 'Sync Meta'}</Button>
                            <Button onClick={() => setShowCreateModal(true)} icon={Icons.Plus}>Nouveau Template</Button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {templates.length === 0 && <div className="col-span-2 text-center text-gray-500 py-8">Aucun template</div>}
                        {templates.map(template => (
                            <Card key={template.id}>
                                <div className="flex items-start justify-between mb-4">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${template.category === 'MARKETING' ? 'bg-purple-100 text-purple-600' : template.category === 'UTILITY' ? 'bg-blue-100 text-blue-600' : 'bg-emerald-100 text-emerald-600'}`}><Icons.FileText /></div>
                                        <div><p className="font-medium text-gray-900">{template.displayName || template.name}</p><p className="text-sm text-gray-500">{catMap[template.category] || template.category}</p></div>
                                    </div>
                                    <Badge variant={tplStatusVariant[template.status] || 'default'}>{tplStatusMap[template.status] || template.status}</Badge>
                                </div>
                                <div className="bg-gray-50 p-4 rounded-xl mb-4"><p className="text-sm text-gray-700 whitespace-pre-line">{template.content}</p></div>
                                {template.variables && template.variables.length > 0 && <div className="mb-4 flex gap-1 flex-wrap">{template.variables.map((v, i) => <span key={i} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded-full">{'{{'}{v}{'}}'}</span>)}</div>}
                                <div className="flex gap-2">
                                    <Button variant="ghost" size="sm" icon={Icons.Copy} onClick={() => openDuplicate(template)} title="Dupliquer" />
                                    <Button variant="ghost" size="sm" icon={Icons.Trash2} onClick={() => handleDelete(template.id)} title="Supprimer" />
                                </div>
                            </Card>
                        ))}
                    </div>

                    {showCreateModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Nouveau Template WhatsApp</h2>
                                    <button onClick={() => setShowCreateModal(false)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom technique" placeholder="relance_connexion" value={form.name} onChange={v => setForm({...form, name: v})} />
                                        <Input label="Nom d'affichage" placeholder="Relance Connexion" value={form.displayName} onChange={v => setForm({...form, displayName: v})} />
                                    </div>
                                    <Select label="Categorie" value={form.category} onChange={v => setForm({...form, category: v})} options={[{ value: '', label: 'Selectionner...' }, { value: 'MARKETING', label: 'Marketing' }, { value: 'UTILITY', label: 'Utilitaire' }, { value: 'AUTHENTICATION', label: 'Authentification' }]} />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Contenu du message</label>
                                        <textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="6" placeholder="Bonjour {{1}} ! ..." value={form.content} onChange={(e) => setForm({...form, content: e.target.value})} />
                                        <p className="text-xs text-gray-500 mt-2">Utilisez {'{{1}}'}, {'{{2}}'}, etc. pour les variables.</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Note :</strong> Les templates doivent etre approuves par Meta avant utilisation (24-48h).</p></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setShowCreateModal(false)}>Annuler</Button>
                                    <Button onClick={handleCreate} disabled={creating || !form.name || !form.content} icon={Icons.CheckCircle}>{creating ? 'Creation...' : 'Soumettre pour approbation'}</Button>
                                </div>
                            </div>
                        </div>
                    )}

                    {dupModal && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                                    <h2 className="text-xl font-semibold text-gray-900">Dupliquer & Modifier le Template</h2>
                                    <button onClick={() => setDupModal(null)} className="text-gray-400 hover:text-gray-600"><Icons.X /></button>
                                </div>
                                <div className="p-6 space-y-6">
                                    <div className="bg-amber-50 p-4 rounded-xl"><p className="text-sm text-amber-800"><strong>Source :</strong> {dupModal.displayName || dupModal.name} ({tplStatusMap[dupModal.status] || dupModal.status})</p></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <Input label="Nom technique" placeholder="relance_v2" value={dupForm.name} onChange={v => setDupForm({...dupForm, name: v})} />
                                        <Input label="Nom d'affichage" placeholder="Relance V2" value={dupForm.displayName} onChange={v => setDupForm({...dupForm, displayName: v})} />
                                    </div>
                                    <Select label="Categorie" value={dupForm.category} onChange={v => setDupForm({...dupForm, category: v})} options={[{ value: 'MARKETING', label: 'Marketing' }, { value: 'UTILITY', label: 'Utilitaire' }, { value: 'AUTHENTICATION', label: 'Authentification' }]} />
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Contenu du message</label>
                                        <textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="6" value={dupForm.content} onChange={(e) => setDupForm({...dupForm, content: e.target.value})} />
                                        <p className="text-xs text-gray-500 mt-2">Modifiez le contenu puis soumettez. Utilisez {'{{1}}'}, {'{{2}}'}, etc. pour les variables.</p>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-xl"><p className="text-sm text-blue-800"><strong>Note :</strong> Le nouveau template sera soumis a Meta pour approbation (24-48h).</p></div>
                                </div>
                                <div className="p-6 border-t border-gray-200 flex justify-end gap-3">
                                    <Button variant="secondary" onClick={() => setDupModal(null)}>Annuler</Button>
                                    <Button onClick={handleDuplicate} disabled={duplicating || !dupForm.name || !dupForm.content} icon={Icons.Copy}>{duplicating ? 'Duplication...' : 'Dupliquer & Soumettre'}</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =============================================
        // Analytics View
        // =============================================
        const AnalyticsView = () => {
            const { data: dash, loading, error, refetch } = useApi('/analytics/dashboard');
            const { data: campaignStats } = useApi('/analytics/campaigns?groupBy=month');
            const { data: contactAnalytics } = useApi('/analytics/contacts');
            const { data: contactStats } = useApi('/contacts/stats/overview');
            const { data: billing } = useApi('/billing/overview');
            const { data: engagement } = useApi('/analytics/engagement');
            const [activeCityIndex, setActiveCityIndex] = useState(null);
            const [activeAccountPie, setActiveAccountPie] = useState(0);

            // Performance BarChart data (active bar style - each month has its own color)
            const perfData = useMemo(() => {
                if (!campaignStats?.data) return [];
                const fills = ['#1e3a5f', '#2d5a87', '#3b82f6', '#00a86b', '#8b5cf6', '#f59e0b'];
                return campaignStats.data.slice(-6).map((d, i) => ({
                    month: d.date ? new Date(d.date + '-01').toLocaleDateString('fr-FR', { month: 'short' }) : d.date,
                    total: (d.sent || 0),
                    delivered: (d.delivered || 0),
                    read: (d.read || 0),
                    fill: fills[i % fills.length]
                }));
            }, [campaignStats]);

            // Contacts par ville (horizontal bar)
            const cityData = useMemo(() => {
                if (!contactStats?.byCity) return [];
                return Object.entries(contactStats.byCity)
                    .map(([city, count]) => ({ city, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 6);
            }, [contactStats]);

            // Contacts par type de compte (donut)
            const accountTypeData = useMemo(() => {
                if (!contactStats?.byAccountType) return [];
                const colors = { EPARGNE: '#00a86b', COURANT: '#1e3a5f', PROFESSIONNEL: '#8b5cf6', JEUNE: '#f59e0b' };
                const labels = { EPARGNE: 'Epargne', COURANT: 'Courant', PROFESSIONNEL: 'Professionnel', JEUNE: 'Jeune' };
                return Object.entries(contactStats.byAccountType)
                    .map(([key, count]) => ({ name: labels[key] || key, value: count, fill: colors[key] || '#9ca3af' }));
            }, [contactStats]);

            // Nouveaux contacts trend (30j)
            const newContactsData = useMemo(() => {
                if (!contactAnalytics?.newContactsDaily) return [];
                const days = [];
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(Date.now() - i * 86400000);
                    const key = d.toISOString().split('T')[0];
                    days.push({ date: key, count: contactAnalytics.newContactsDaily[key] || 0 });
                }
                return days;
            }, [contactAnalytics]);

            // Engagement horizontal bar data (recent campaigns by sent count)
            const engagementBarData = useMemo(() => {
                if (!dash?.recentCampaigns) return [];
                return dash.recentCampaigns
                    .filter(c => c.sent > 0)
                    .slice(0, 5)
                    .map(c => ({
                        name: c.name.length > 18 ? c.name.substring(0, 18) + '...' : c.name,
                        fullName: c.name,
                        sent: c.sent,
                        delivered: c.delivered,
                        read: c.read
                    }))
                    .reverse();
            }, [dash]);

            // Top campagnes
            const topCampaigns = useMemo(() => {
                if (!engagement?.campaigns) return [];
                return engagement.campaigns
                    .filter(c => c.sent > 0)
                    .sort((a, b) => parseFloat(b.openRate) - parseFloat(a.openRate))
                    .slice(0, 5);
            }, [engagement]);

            if (loading) return <Spinner />;
            if (error) return <ErrorBox message={error} onRetry={refetch} />;
            if (!dash) return null;

            const o = dash.overview || {};
            const camp = dash.campaigns || {};
            const cont = dash.contacts || {};
            const costTotal = billing?.totals?.costFCFA || 0;

            return (
                <div className="space-y-6">
                    {/* Header */}
                    <div className="flex items-center justify-between">
                        <div>
                            <h2 className="text-xl font-bold text-gray-900">Analytics & Performance</h2>
                            <p className="text-sm text-gray-500 mt-0.5">Vue complete de l'activite marketing et bancaire</p>
                        </div>
                        <Button variant="secondary" size="sm" icon={Icons.Download} onClick={async () => { try { const resp = await fetch(API_BASE + '/analytics/export?format=csv', { headers: { Authorization: 'Bearer ' + authStore.getToken() } }); const blob = await resp.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'analytics-bgfi.csv'; a.click(); URL.revokeObjectURL(url); } catch(e) { alert(e.message); } }}>Exporter CSV</Button>
                    </div>

                    {/* Row 1: 6 KPI Cards */}
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center text-blue-600"><Icons.MessageSquare /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{formatNum(o.totalMessages || 0)}</p>
                            <p className="text-xs text-gray-500 mt-0.5">Messages envoyes</p>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-600"><Icons.CheckCircle /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{(o.deliveryRate || 0).toFixed(1)}%</p>
                            <p className="text-xs text-gray-500 mt-0.5">Taux delivrance</p>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-purple-50 flex items-center justify-center text-purple-600"><Icons.Eye /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{(o.openRate || 0).toFixed(1)}%</p>
                            <p className="text-xs text-gray-500 mt-0.5">Taux ouverture</p>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center text-amber-600"><Icons.Users /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{formatNum(cont.active || cont.total || 0)}</p>
                            <p className="text-xs text-gray-500 mt-0.5">Contacts actifs</p>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-sky-50 flex items-center justify-center text-sky-600"><Icons.Send /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{camp.completed || 0}</p>
                            <p className="text-xs text-gray-500 mt-0.5">Campagnes terminees</p>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-4">
                            <div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 rounded-lg bg-rose-50 flex items-center justify-center text-rose-600"><Icons.TrendingUp /></div></div>
                            <p className="text-2xl font-bold text-gray-900">{costTotal > 0 ? formatNum(costTotal) : '0'}</p>
                            <p className="text-xs text-gray-500 mt-0.5">Cout total (FCFA)</p>
                        </div>
                    </div>

                    {/* Row 2: Active BarChart + Horizontal BarChart */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Performance - Active Bar Chart */}
                        <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-0">
                                <h3 className="text-lg font-semibold text-gray-900">Performance des Campagnes</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Volume de messages envoyes par mois</p>
                            </div>
                            <div className="p-6 pt-4" style={{ height: 300 }}>
                                {perfData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={perfData} margin={{ top: 5, right: 10, left: 0, bottom: 0 }}>
                                            <CartesianGrid vertical={false} stroke="#f0f0f0" strokeDasharray="3 3" />
                                            <XAxis dataKey="month" tickLine={false} tickMargin={10} axisLine={false} tick={{ fontSize: 12, fill: '#9ca3af' }} />
                                            <YAxis tickLine={false} axisLine={false} tick={{ fontSize: 12, fill: '#9ca3af' }} width={45} />
                                            <Tooltip cursor={false} contentStyle={{ borderRadius: 12, border: '1px solid #e5e7eb', boxShadow: '0 4px 12px rgba(0,0,0,0.08)', fontSize: 13 }} formatter={(value, name, props) => { const d = props.payload; return [value + ' messages', 'Envoyes']; }} labelFormatter={(v) => v} />
                                            <Bar
                                                dataKey="total"
                                                name="Messages"
                                                strokeWidth={2}
                                                radius={8}
                                                activeIndex={perfData.length - 1}
                                                activeBar={(props) => (
                                                    <Rectangle {...props} fillOpacity={0.85} stroke={props.payload.fill} strokeWidth={2} strokeDasharray="4 4" strokeDashoffset={4} />
                                                )}
                                            >
                                                {perfData.map((entry, i) => <Cell key={i} fill={entry.fill} />)}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Aucune donnee de campagne</div>}
                            </div>
                            <div className="px-6 pb-4 flex items-center justify-between text-sm border-t border-gray-50 pt-3">
                                <div className="flex items-center gap-1.5 text-gray-600">
                                    {perfData.length >= 2 && (() => {
                                        const curr = perfData[perfData.length - 1]?.total || 0;
                                        const prev = perfData[perfData.length - 2]?.total || 1;
                                        const pct = prev > 0 ? (((curr - prev) / prev) * 100).toFixed(1) : 0;
                                        const up = curr >= prev;
                                        return (<><span className={`font-medium ${up ? 'text-emerald-600' : 'text-red-500'}`}>{up ? '+' : ''}{pct}%</span><span>vs mois precedent</span>{up ? <Icons.TrendingUp /> : null}</>);
                                    })()}
                                </div>
                                <span className="text-gray-400">6 derniers mois</span>
                            </div>
                        </div>

                        {/* Engagement - Horizontal Bar Chart */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-2">
                                <h3 className="text-lg font-semibold text-gray-900">Campagnes Recentes</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Messages envoyes par campagne</p>
                            </div>
                            <div className="p-4 pt-2" style={{ height: 260 }}>
                                {engagementBarData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={engagementBarData} layout="vertical" margin={{ left: -20, right: 16, top: 0, bottom: 0 }}>
                                            <XAxis type="number" dataKey="sent" hide />
                                            <YAxis dataKey="name" type="category" tickLine={false} tickMargin={10} axisLine={false} tick={{ fontSize: 11, fill: '#6b7280' }} width={110} />
                                            <Tooltip cursor={false} contentStyle={{ borderRadius: 12, border: '1px solid #e5e7eb', boxShadow: '0 4px 12px rgba(0,0,0,0.08)', fontSize: 13 }} formatter={(value, name, props) => [value + ' messages', 'Envoyes']} labelFormatter={(v, payload) => payload?.[0]?.payload?.fullName || v} />
                                            <Bar dataKey="sent" fill="#1e3a5f" radius={5} barSize={18} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Aucune campagne recente</div>}
                            </div>
                            <div className="px-6 pb-4 border-t border-gray-50 pt-3">
                                <div className="grid grid-cols-3 gap-3 text-center">
                                    <div><p className="text-lg font-bold text-gray-900">{camp.total || 0}</p><p className="text-xs text-gray-500">Total</p></div>
                                    <div><p className="text-lg font-bold text-emerald-600">{camp.completed || 0}</p><p className="text-xs text-gray-500">Terminees</p></div>
                                    <div><p className="text-lg font-bold text-blue-600">{camp.active || 0}</p><p className="text-xs text-gray-500">En cours</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Row 3: Ville + Type Compte + Categorie */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Distribution par ville */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-2">
                                <h3 className="text-lg font-semibold text-gray-900">Repartition Geographique</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Contacts par ville</p>
                            </div>
                            <div className="p-6 pt-2" style={{ height: 260 }}>
                                {cityData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={cityData} layout="vertical" margin={{ top: 0, right: 20, left: 0, bottom: 0 }}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" horizontal={false} />
                                            <XAxis type="number" tickLine={false} axisLine={false} tick={{ fontSize: 11, fill: '#9ca3af' }} />
                                            <YAxis type="category" dataKey="city" tickLine={false} axisLine={false} width={90} tick={{ fontSize: 11, fill: '#6b7280' }} />
                                            <Tooltip contentStyle={{ borderRadius: 12, border: '1px solid #e5e7eb', fontSize: 13 }} formatter={(v) => [v + ' contacts']} />
                                            <Bar dataKey="count" name="Contacts" fill="#2d5a87" radius={[0, 6, 6, 0]} barSize={16} />
                                        </BarChart>
                                    </ResponsiveContainer>
                                ) : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Aucune donnee</div>}
                            </div>
                        </div>

                        {/* Type de compte bancaire */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-2 text-center">
                                <h3 className="text-lg font-semibold text-gray-900">Types de Compte</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Repartition bancaire</p>
                            </div>
                            <div className="px-2" style={{ height: 200 }}>
                                {accountTypeData.length > 0 ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <PieChart>
                                            <Pie
                                                data={accountTypeData}
                                                cx="50%" cy="50%"
                                                innerRadius={45} outerRadius={72}
                                                dataKey="value"
                                                activeIndex={activeAccountPie}
                                                activeShape={(props) => {
                                                    const { cx, cy, innerRadius, outerRadius, startAngle, endAngle, fill, payload, value } = props;
                                                    return (
                                                        <g>
                                                            <text x={cx} y={cy - 4} textAnchor="middle" dominantBaseline="central" style={{ fontSize: 20, fontWeight: 700, fill }}>{value}</text>
                                                            <text x={cx} y={cy + 16} textAnchor="middle" dominantBaseline="central" style={{ fontSize: 10, fill: '#6b7280' }}>{payload.name}</text>
                                                            <Sector cx={cx} cy={cy} innerRadius={innerRadius - 3} outerRadius={outerRadius + 5} startAngle={startAngle} endAngle={endAngle} fill={fill} />
                                                            <Sector cx={cx} cy={cy} innerRadius={outerRadius + 8} outerRadius={outerRadius + 11} startAngle={startAngle} endAngle={endAngle} fill={fill} />
                                                        </g>
                                                    );
                                                }}
                                                onMouseEnter={(_, i) => setActiveAccountPie(i)}
                                            >
                                                {accountTypeData.map((entry, i) => <Cell key={i} fill={entry.fill} stroke="none" />)}
                                            </Pie>
                                        </PieChart>
                                    </ResponsiveContainer>
                                ) : <div className="flex items-center justify-center h-full text-gray-400 text-sm">Aucune donnee</div>}
                            </div>
                            <div className="px-6 pb-5 pt-1 space-y-1">
                                {accountTypeData.map((d, i) => (
                                    <div key={d.name} className={`flex items-center justify-between text-sm px-2 py-1 rounded-lg cursor-pointer transition-colors ${i === activeAccountPie ? 'bg-gray-50' : ''}`} onMouseEnter={() => setActiveAccountPie(i)}>
                                        <div className="flex items-center gap-2">
                                            <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: d.fill }} />
                                            <span className="text-gray-600">{d.name}</span>
                                        </div>
                                        <span className="font-medium text-gray-900">{d.value}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Cout par categorie de message */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-2">
                                <h3 className="text-lg font-semibold text-gray-900">Couts par Type</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Depenses WhatsApp en FCFA</p>
                            </div>
                            <div className="p-6 pt-2 space-y-4">
                                {billing?.costByCategory ? Object.entries(billing.costByCategory).map(([cat, data]) => {
                                    const totalSent = billing.totals?.sent || 1;
                                    const pct = totalSent > 0 ? ((data.sent / totalSent) * 100) : 0;
                                    const colors = { MARKETING: '#8b5cf6', UTILITY: '#3b82f6', AUTHENTICATION: '#f59e0b' };
                                    const labels = { MARKETING: 'Marketing', UTILITY: 'Utilitaire', AUTHENTICATION: 'Authentification' };
                                    return (
                                        <div key={cat}>
                                            <div className="flex items-center justify-between mb-1.5">
                                                <div className="flex items-center gap-2">
                                                    <div className="w-2.5 h-2.5 rounded-full" style={{ backgroundColor: colors[cat] || '#9ca3af' }} />
                                                    <span className="text-sm text-gray-700">{labels[cat] || cat}</span>
                                                </div>
                                                <span className="text-sm font-bold text-gray-900">{(data.costFCFA || 0).toLocaleString()} FCFA</span>
                                            </div>
                                            <div className="w-full h-2.5 bg-gray-100 rounded-full overflow-hidden">
                                                <div className="h-full rounded-full" style={{ width: Math.min(pct, 100) + '%', backgroundColor: colors[cat] || '#9ca3af' }} />
                                            </div>
                                            <p className="text-xs text-gray-400 mt-1">{data.sent || 0} messages &middot; {data.delivered || 0} delivres</p>
                                        </div>
                                    );
                                }) : (
                                    <div className="text-center py-8 text-gray-400 text-sm">Aucune depense enregistree</div>
                                )}
                                {billing?.totals && (
                                    <div className="pt-3 border-t border-gray-100">
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm font-semibold text-gray-700">Total</span>
                                            <span className="text-lg font-bold text-gray-900">{(billing.totals.costFCFA || 0).toLocaleString()} FCFA</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Row 4: Nouveaux contacts trend + Top Campagnes */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Evolution des inscriptions */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-0">
                                <h3 className="text-lg font-semibold text-gray-900">Nouveaux Contacts</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Inscriptions sur les 30 derniers jours</p>
                            </div>
                            <div className="p-6 pt-4" style={{ height: 220 }}>
                                <ResponsiveContainer width="100%" height="100%">
                                    <AreaChart data={newContactsData} margin={{ top: 5, right: 10, left: 0, bottom: 0 }}>
                                        <defs>
                                            <linearGradient id="gradContacts" x1="0" y1="0" x2="0" y2="1">
                                                <stop offset="5%" stopColor="#00a86b" stopOpacity={0.3} />
                                                <stop offset="95%" stopColor="#00a86b" stopOpacity={0} />
                                            </linearGradient>
                                        </defs>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" vertical={false} />
                                        <XAxis dataKey="date" tickLine={false} axisLine={false} tick={{ fontSize: 11, fill: '#9ca3af' }} minTickGap={40} tickFormatter={v => new Date(v).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })} />
                                        <YAxis tickLine={false} axisLine={false} tick={{ fontSize: 11, fill: '#9ca3af' }} width={30} allowDecimals={false} />
                                        <Tooltip contentStyle={{ borderRadius: 12, border: '1px solid #e5e7eb', fontSize: 13 }} labelFormatter={v => new Date(v).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })} formatter={(v) => [v + ' nouveaux']} />
                                        <Area type="monotone" dataKey="count" name="Nouveaux" stroke="#00a86b" fill="url(#gradContacts)" strokeWidth={2} dot={false} />
                                    </AreaChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* Top campagnes */}
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100">
                            <div className="p-6 pb-3">
                                <h3 className="text-lg font-semibold text-gray-900">Top Campagnes</h3>
                                <p className="text-sm text-gray-500 mt-0.5">Meilleures performances par taux d'ouverture</p>
                            </div>
                            <div className="px-6 pb-6">
                                {topCampaigns.length > 0 ? (
                                    <div className="space-y-3">
                                        {topCampaigns.map((c, i) => (
                                            <div key={i} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl">
                                                <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-white font-bold text-sm ${i === 0 ? 'bg-amber-500' : i === 1 ? 'bg-gray-400' : i === 2 ? 'bg-amber-700' : 'bg-gray-300'}`}>{i + 1}</div>
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-gray-900 truncate">{c.name}</p>
                                                    <p className="text-xs text-gray-500">{c.sent} envoyes &middot; {c.type}</p>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-sm font-bold text-emerald-600">{parseFloat(c.openRate).toFixed(1)}%</p>
                                                    <p className="text-xs text-gray-400">ouverture</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-gray-400 text-sm">Aucune campagne terminee</div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Row 5: Ressources */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600"><Icons.FileText /></div>
                                <h4 className="font-semibold text-gray-900">Templates</h4>
                            </div>
                            <div className="flex items-center gap-6">
                                <div><p className="text-2xl font-bold text-gray-900">{dash.templates?.approved || 0}</p><p className="text-xs text-gray-500">Approuves</p></div>
                                <div><p className="text-2xl font-bold text-amber-500">{dash.templates?.pending || 0}</p><p className="text-xs text-gray-500">En attente</p></div>
                                <div><p className="text-2xl font-bold text-gray-400">{dash.templates?.total || 0}</p><p className="text-xs text-gray-500">Total</p></div>
                            </div>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-xl bg-emerald-50 flex items-center justify-center text-emerald-600"><Icons.Users /></div>
                                <h4 className="font-semibold text-gray-900">Base Contacts</h4>
                            </div>
                            <div className="flex items-center gap-6">
                                <div><p className="text-2xl font-bold text-gray-900">{cont.total || 0}</p><p className="text-xs text-gray-500">Total</p></div>
                                <div><p className="text-2xl font-bold text-emerald-600">{cont.active || 0}</p><p className="text-xs text-gray-500">Actifs</p></div>
                                <div><p className="text-2xl font-bold text-red-500">{(cont.blocked || 0) + (cont.unsubscribed || 0)}</p><p className="text-xs text-gray-500">Inactifs</p></div>
                            </div>
                        </div>
                        <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-xl bg-purple-50 flex items-center justify-center text-purple-600"><Icons.Target /></div>
                                <h4 className="font-semibold text-gray-900">Engagement Moyen</h4>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="relative w-16 h-16">
                                    <svg viewBox="0 0 36 36" className="w-16 h-16 -rotate-90">
                                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#f3f4f6" strokeWidth="3" />
                                        <circle cx="18" cy="18" r="15.9" fill="none" stroke="#8b5cf6" strokeWidth="3" strokeDasharray={`${(contactAnalytics?.averageEngagement || 0)} 100`} strokeLinecap="round" />
                                    </svg>
                                    <span className="absolute inset-0 flex items-center justify-center text-sm font-bold text-gray-900">{contactAnalytics?.averageEngagement || 0}</span>
                                </div>
                                <div>
                                    <p className="text-sm text-gray-600">Score moyen des contacts actifs sur 100</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =============================================
        // Chatbot Config Card (Settings)
        // =============================================
        const ChatbotConfigCard = () => {
            const { data: chatbotStatus, loading, refetch } = useApi('/chatbot/status');

            const statusIcon = (ok) => ok
                ? React.createElement('div', { className: 'w-2.5 h-2.5 rounded-full bg-emerald-500' })
                : React.createElement('div', { className: 'w-2.5 h-2.5 rounded-full bg-gray-300' });

            return React.createElement(Card, { title: 'Chatbot Automatique (Cassiopee)' },
                loading ? React.createElement('div', { className: 'py-8 text-center text-gray-500' }, 'Chargement...') :
                chatbotStatus ? React.createElement('div', { className: 'space-y-5' },
                    // Status toggle display
                    React.createElement('div', { className: 'flex items-center justify-between p-4 rounded-xl ' + (chatbotStatus.enabled ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200') },
                        React.createElement('div', { className: 'flex items-center gap-3' },
                            React.createElement('div', { className: 'w-10 h-10 rounded-xl flex items-center justify-center ' + (chatbotStatus.enabled ? 'bg-emerald-100' : 'bg-red-100') },
                                React.createElement('span', { className: 'text-xl' }, chatbotStatus.enabled ? Icons.CheckCircle : Icons.XCircle)
                            ),
                            React.createElement('div', null,
                                React.createElement('p', { className: 'text-sm font-semibold ' + (chatbotStatus.enabled ? 'text-emerald-900' : 'text-red-900') }, chatbotStatus.enabled ? 'Chatbot Active' : 'Chatbot Desactive'),
                                React.createElement('p', { className: 'text-xs ' + (chatbotStatus.enabled ? 'text-emerald-600' : 'text-red-600') }, chatbotStatus.enabled ? 'Repond automatiquement aux messages entrants' : 'Les messages ne recoivent pas de reponse automatique')
                            )
                        ),
                        React.createElement(Badge, { variant: chatbotStatus.enabled ? 'success' : 'danger' }, chatbotStatus.enabled ? 'ON' : 'OFF')
                    ),

                    // Services status
                    React.createElement('div', null,
                        React.createElement('h3', { className: 'text-sm font-semibold text-gray-700 mb-3' }, 'Services IA'),
                        React.createElement('div', { className: 'space-y-2' },
                            React.createElement('div', { className: 'flex items-center justify-between p-3 bg-gray-50 rounded-xl' },
                                React.createElement('div', { className: 'flex items-center gap-2' },
                                    statusIcon(chatbotStatus.openai?.configured),
                                    React.createElement('span', { className: 'text-sm text-gray-700' }, 'OpenAI')
                                ),
                                React.createElement('div', { className: 'flex items-center gap-2' },
                                    chatbotStatus.openai?.configured && React.createElement('span', { className: 'text-xs text-gray-500' }, 'Modele: ' + chatbotStatus.openai.model),
                                    React.createElement(Badge, { variant: chatbotStatus.openai?.configured ? 'success' : 'warning' }, chatbotStatus.openai?.configured ? 'Configure' : 'Non configure')
                                )
                            ),
                            React.createElement('div', { className: 'flex items-center justify-between p-3 bg-gray-50 rounded-xl' },
                                React.createElement('div', { className: 'flex items-center gap-2' },
                                    statusIcon(chatbotStatus.ragService?.configured && chatbotStatus.ragService?.status === 'connected'),
                                    React.createElement('span', { className: 'text-sm text-gray-700' }, 'Service RAG')
                                ),
                                React.createElement(Badge, {
                                    variant: chatbotStatus.ragService?.status === 'connected' ? 'success' : chatbotStatus.ragService?.configured ? 'warning' : 'default'
                                }, chatbotStatus.ragService?.status === 'connected' ? 'Connecte' : chatbotStatus.ragService?.configured ? 'Injoignable' : 'Non configure')
                            )
                        )
                    ),

                    // System prompt preview
                    React.createElement('div', null,
                        React.createElement('h3', { className: 'text-sm font-semibold text-gray-700 mb-2' }, 'Prompt systeme'),
                        React.createElement('div', { className: 'p-3 bg-gray-50 rounded-xl' },
                            React.createElement('p', { className: 'text-xs text-gray-600 italic leading-relaxed' }, '"' + (chatbotStatus.systemPromptPreview || '') + '"')
                        )
                    ),

                    // Fallback message
                    React.createElement('div', null,
                        React.createElement('h3', { className: 'text-sm font-semibold text-gray-700 mb-2' }, 'Message de secours (si IA indisponible)'),
                        React.createElement('div', { className: 'p-3 bg-amber-50 rounded-xl border border-amber-200' },
                            React.createElement('p', { className: 'text-xs text-amber-800 leading-relaxed' }, chatbotStatus.fallbackMessage || '')
                        )
                    ),

                    // Stats
                    React.createElement('div', { className: 'flex items-center justify-between p-3 bg-blue-50 rounded-xl' },
                        React.createElement('span', { className: 'text-xs text-blue-700' }, 'Sessions chatbot (24h)'),
                        React.createElement('span', { className: 'text-sm font-bold text-blue-900' }, chatbotStatus.recentSessions || 0)
                    ),

                    // Config note
                    React.createElement('div', { className: 'p-3 bg-gray-100 rounded-xl' },
                        React.createElement('p', { className: 'text-xs text-gray-500 leading-relaxed' },
                            'Configuration via variables d\'environnement Netlify : CHATBOT_AUTO_REPLY, OPENAI_API_KEY, OPENAI_MODEL, CHATBOT_SYSTEM_PROMPT, CHATBOT_FALLBACK_MESSAGE, RAG_SERVICE_URL'
                        )
                    )
                ) : React.createElement('div', { className: 'py-8 text-center text-gray-500' }, 'Impossible de charger la configuration')
            );
        };

        // =============================================
        // Settings View
        // =============================================
        const SettingsView = () => {
            const { data: health } = useApi('/health');
            const { data: billing, loading: billingLoading } = useApi('/billing/overview');

            const formatFCFA = (amount) => {
                if (!amount && amount !== 0) return '0 FCFA';
                return new Intl.NumberFormat('fr-FR').format(Math.round(amount)) + ' FCFA';
            };

            const categoryLabels = { MARKETING: 'Marketing', UTILITY: 'Utilitaire', AUTHENTICATION: 'Authentification' };
            const categoryColors = { MARKETING: '#3b82f6', UTILITY: '#10b981', AUTHENTICATION: '#f59e0b' };

            return (
                <div className="space-y-6">
                    {/* Cout des messages WhatsApp */}
                    <Card title="Cout des Messages WhatsApp">
                        {billingLoading ? <div className="py-8 text-center text-gray-500">Chargement...</div> : billing ? (
                            <div className="space-y-6">
                                {/* KPI Cards */}
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                                        <p className="text-xs font-medium text-blue-600 uppercase tracking-wide">Cout Total</p>
                                        <p className="text-2xl font-bold text-blue-900 mt-1">{formatFCFA(billing.totals?.costFCFA)}</p>
                                        <p className="text-xs text-blue-500 mt-1">{billing.totals?.sent || 0} messages envoyes</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-xl p-4">
                                        <p className="text-xs font-medium text-emerald-600 uppercase tracking-wide">Delivres</p>
                                        <p className="text-2xl font-bold text-emerald-900 mt-1">{billing.totals?.delivered || 0}</p>
                                        <p className="text-xs text-emerald-500 mt-1">{billing.totals?.sent ? Math.round(billing.totals.delivered / billing.totals.sent * 100) : 0}% taux de livraison</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4">
                                        <p className="text-xs font-medium text-amber-600 uppercase tracking-wide">Lus</p>
                                        <p className="text-2xl font-bold text-amber-900 mt-1">{billing.totals?.read || 0}</p>
                                        <p className="text-xs text-amber-500 mt-1">{billing.totals?.sent ? Math.round(billing.totals.read / billing.totals.sent * 100) : 0}% taux de lecture</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-4">
                                        <p className="text-xs font-medium text-red-600 uppercase tracking-wide">Echoues</p>
                                        <p className="text-2xl font-bold text-red-900 mt-1">{billing.totals?.failed || 0}</p>
                                        <p className="text-xs text-red-500 mt-1">{billing.totals?.sent ? Math.round(billing.totals.failed / billing.totals.sent * 100) : 0}% taux d'echec</p>
                                    </div>
                                </div>

                                {/* Cout par categorie */}
                                <div>
                                    <h3 className="text-sm font-semibold text-gray-700 mb-3">Repartition par type de message</h3>
                                    <div className="space-y-3">
                                        {Object.entries(billing.costByCategory || {}).map(([cat, data]) => {
                                            const totalCost = billing.totals?.costFCFA || 1;
                                            const pct = totalCost > 0 ? Math.round(data.costFCFA / totalCost * 100) : 0;
                                            return (
                                                <div key={cat} className="flex items-center gap-4 p-3 bg-gray-50 rounded-xl">
                                                    <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: categoryColors[cat] }} />
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center justify-between mb-1">
                                                            <span className="text-sm font-medium text-gray-800">{categoryLabels[cat] || cat}</span>
                                                            <span className="text-sm font-bold text-gray-900">{formatFCFA(data.costFCFA)}</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <div className="flex-1 bg-gray-200 rounded-full h-2">
                                                                <div className="h-2 rounded-full transition-all" style={{ width: pct + '%', backgroundColor: categoryColors[cat] }} />
                                                            </div>
                                                            <span className="text-xs text-gray-500 w-16 text-right">{data.sent} msg</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Grille tarifaire */}
                                <div>
                                    <h3 className="text-sm font-semibold text-gray-700 mb-3">Grille tarifaire (Region Gabon - Rest of Africa)</h3>
                                    <div className="bg-gray-50 rounded-xl overflow-hidden">
                                        <table className="w-full">
                                            <thead><tr className="border-b border-gray-200"><th className="text-left py-2 px-4 text-xs font-medium text-gray-500">Type</th><th className="text-right py-2 px-4 text-xs font-medium text-gray-500">Prix USD</th><th className="text-right py-2 px-4 text-xs font-medium text-gray-500">Prix FCFA</th><th className="text-right py-2 px-4 text-xs font-medium text-gray-500">Regle</th></tr></thead>
                                            <tbody className="divide-y divide-gray-100">
                                                <tr><td className="py-2 px-4 text-sm text-gray-700">Marketing</td><td className="py-2 px-4 text-sm text-gray-600 text-right">$0.0259</td><td className="py-2 px-4 text-sm font-medium text-gray-900 text-right">{billing.pricing?.MARKETING || 35} FCFA</td><td className="py-2 px-4 text-xs text-gray-400 text-right">x2 x600</td></tr>
                                                <tr><td className="py-2 px-4 text-sm text-gray-700">Utilitaire</td><td className="py-2 px-4 text-sm text-gray-600 text-right">$0.0046</td><td className="py-2 px-4 text-sm font-medium text-gray-900 text-right">{billing.pricing?.UTILITY || 11} FCFA</td><td className="py-2 px-4 text-xs text-gray-400 text-right">x2 x600</td></tr>
                                                <tr><td className="py-2 px-4 text-sm text-gray-700">Authentification</td><td className="py-2 px-4 text-sm text-gray-600 text-right">$0.0046</td><td className="py-2 px-4 text-sm font-medium text-gray-900 text-right">{billing.pricing?.AUTHENTICATION || 11} FCFA</td><td className="py-2 px-4 text-xs text-gray-400 text-right">x2 x600</td></tr>
                                                <tr><td className="py-2 px-4 text-sm text-gray-700">Service</td><td className="py-2 px-4 text-sm text-gray-600 text-right">$0.00</td><td className="py-2 px-4 text-sm font-medium text-emerald-600 text-right">Gratuit</td><td className="py-2 px-4 text-xs text-gray-400 text-right">-</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Detail par campagne */}
                                {billing.campaigns?.length > 0 && (
                                    <div>
                                        <h3 className="text-sm font-semibold text-gray-700 mb-3">Detail par campagne</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead><tr className="border-b border-gray-200"><th className="text-left py-2 px-3 text-xs font-medium text-gray-500">Campagne</th><th className="text-left py-2 px-3 text-xs font-medium text-gray-500">Type</th><th className="text-right py-2 px-3 text-xs font-medium text-gray-500">Envoyes</th><th className="text-right py-2 px-3 text-xs font-medium text-gray-500">Delivres</th><th className="text-right py-2 px-3 text-xs font-medium text-gray-500">Echoues</th><th className="text-right py-2 px-3 text-xs font-medium text-gray-500">Cout</th></tr></thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {billing.campaigns.map(c => (
                                                        <tr key={c.id} className="hover:bg-gray-50">
                                                            <td className="py-2 px-3 text-sm text-gray-900">{c.name}</td>
                                                            <td className="py-2 px-3"><Badge variant={c.templateCategory === 'MARKETING' ? 'primary' : 'default'}>{categoryLabels[c.templateCategory] || c.templateCategory}</Badge></td>
                                                            <td className="py-2 px-3 text-sm text-gray-600 text-right">{c.sent}</td>
                                                            <td className="py-2 px-3 text-sm text-emerald-600 text-right">{c.delivered}</td>
                                                            <td className="py-2 px-3 text-sm text-red-500 text-right">{c.failed}</td>
                                                            <td className="py-2 px-3 text-sm font-medium text-gray-900 text-right">{formatFCFA(c.costFCFA)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ) : <div className="py-8 text-center text-gray-500">Aucune donnee de facturation</div>}
                    </Card>

                    {/* Chatbot Automatique */}
                    <ChatbotConfigCard />

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card title="Informations Generales">
                            <div className="space-y-4">
                                <Input label="Nom de l'organisation" value="BGFI Bank" />
                                <Input label="Email de contact" value="marketing@bgfi.ga" />
                                <Input label="Telephone" value="+241 01 74 12 34" />
                                <div><label className="block text-sm font-medium text-gray-700 mb-2">Adresse</label><textarea className="block w-full rounded-lg border-gray-300 shadow-sm focus:border-bgfi-primary focus:ring-bgfi-primary sm:text-sm px-4 py-3 border" rows="3" defaultValue="Boulevard Triomphal, Libreville, Gabon" /></div>
                            </div>
                        </Card>
                        <Card title="Etat des Services">
                            <div className="space-y-3">
                                {health?.services && Object.entries(health.services).map(([name, ok]) => (
                                    <div key={name} className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                        <span className="text-sm font-medium text-gray-700 capitalize">{name}</span>
                                        <Badge variant={ok ? 'success' : 'danger'}>{ok ? 'Connecte' : 'Non configure'}</Badge>
                                    </div>
                                ))}
                                {health && <div className="mt-3 p-3 bg-blue-50 rounded-xl"><p className="text-xs text-blue-700">Version: {health.version} | Env: {health.environment} | {health.timestamp ? new Date(health.timestamp).toLocaleString('fr-FR') : ''}</p></div>}
                            </div>
                        </Card>
                    </div>
                    <div className="flex justify-end gap-3">
                        <Button icon={Icons.CheckCircle}>Sauvegarder les modifications</Button>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<BGFIWhatsAppSaaS />);
    </script>
</body>
</html>

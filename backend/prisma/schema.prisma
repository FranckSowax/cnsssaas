// ============================================
// BGFI WhatsApp Marketing SaaS - Database Schema
// Avec Supabase pgvector pour le RAG
// ============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// User & Authentication
// ============================================
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(OPERATOR)
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  
  // Relations
  campaigns Campaign[]
  apiKeys   ApiKey[]
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("users")
}

// ============================================
// Campaigns
// ============================================
model Campaign {
  id          String          @id @default(uuid())
  name        String
  type        CampaignType
  status      CampaignStatus  @default(DRAFT)
  description String?

  // Statistics
  sent        Int             @default(0)
  delivered   Int             @default(0)
  read        Int             @default(0)
  clicked     Int             @default(0)
  failed      Int             @default(0)

  // Configuration
  templateId  String
  template    Template        @relation(fields: [templateId], references: [id])
  variables   Json?           @default("{}")

  // Segmentation (new dynamic system)
  segmentId       String?
  segmentRef      Segment?        @relation("CampaignSegment", fields: [segmentId], references: [id])
  inlineCriteria  Json?           // Ad-hoc targeting criteria without saved segment
  legacySegment   ContactCategory? // Legacy: renamed from 'segment'

  // Scheduling
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?

  // Relations
  messages    Message[]

  // Timestamps
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  createdBy   String
  user        User            @relation(fields: [createdBy], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([createdBy])
  @@index([segmentId])
  @@map("campaigns")
}

// ============================================
// Templates (WhatsApp)
// ============================================
model Template {
  id          String           @id @default(uuid())
  name        String
  displayName String
  category    TemplateCategory
  content     String
  variables   String[]         @default([])
  language    String           @default("fr")
  
  // Meta approval status
  status      TemplateStatus   @default(PENDING)
  metaId      String?          // WhatsApp template ID from Meta
  approvedAt  DateTime?
  rejectedAt  DateTime?
  rejectionReason String?
  
  // Relations
  campaigns   Campaign[]
  
  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@index([status])
  @@index([category])
  @@map("templates")
}

// ============================================
// Contacts
// ============================================
model Contact {
  id            String          @id @default(uuid())
  phone         String          @unique
  email         String?
  name          String?

  // Category (renamed from 'segment')
  category      ContactCategory @default(ACTIVE)
  tags          String[]        @default([])

  // Banking-specific fields
  city          String?
  country       String?         @default("GA")
  ageRange      String?         // "18-25", "26-35", "36-45", "46-55", "56+"
  gender        String?         // "M", "F", "AUTRE"
  language      String?         @default("fr")
  accountType   String?         // "EPARGNE", "COURANT", "PROFESSIONNEL", "JEUNE"
  registrationDate DateTime?

  // Enrichment & scoring
  customAttributes  Json?       @default("{}")
  engagementScore   Int?        @default(0)
  lastCampaignInteraction DateTime?

  // Metadata
  lastActivity  DateTime?
  status        ContactStatus   @default(ACTIVE)

  // WhatsApp specific
  whatsappId    String?         // WhatsApp Business API contact ID
  optedIn       Boolean         @default(false)
  optedInAt     DateTime?

  // Relations
  messages      Message[]
  chatSessions  ChatSession[]

  // Timestamps
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([category])
  @@index([status])
  @@index([phone])
  @@index([city])
  @@index([accountType])
  @@map("contacts")
}

// ============================================
// Segments (Dynamic targeting)
// ============================================
model Segment {
  id              String      @id @default(uuid())
  name            String      @unique
  description     String?
  type            SegmentType @default(DYNAMIC)
  criteria        Json        // JSON rules engine criteria
  contactCount    Int         @default(0)
  lastEvaluatedAt DateTime?

  // Relations
  campaigns       Campaign[]  @relation("CampaignSegment")

  createdBy       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("segments")
}

// ============================================
// Enrichment Logs (audit trail)
// ============================================
model EnrichmentLog {
  id          String   @id @default(uuid())
  contactId   String
  source      String   // "MANUAL", "CSV_IMPORT", "BANK_CBS"
  fieldName   String
  oldValue    String?
  newValue    String?
  performedBy String?
  createdAt   DateTime @default(now())

  @@index([contactId])
  @@map("enrichment_logs")
}

// ============================================
// Messages
// ============================================
model Message {
  id          String        @id @default(uuid())
  
  // Relations
  campaignId  String?
  campaign    Campaign?     @relation(fields: [campaignId], references: [id])
  contactId   String
  contact     Contact       @relation(fields: [contactId], references: [id])
  
  // Content
  content     String
  type        MessageType   @default(TEXT)
  
  // Status tracking
  status      MessageStatus @default(PENDING)
  externalId  String?       // WhatsApp message ID (wamid)
  
  // Timestamps
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  failedAt    DateTime?
  error       String?
  
  createdAt   DateTime      @default(now())
  
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([createdAt])
  @@map("messages")
}

// ============================================
// Knowledge Documents (RAG avec Supabase)
// ============================================
model KnowledgeDocument {
  id          String         @id @default(uuid())
  name        String
  type        String         // pdf, docx, xlsx, etc.
  size        Int            // in bytes
  path        String?        // storage path (optionnel avec Supabase)
  
  // Indexing status
  status      DocumentStatus @default(PROCESSING)
  chunks      Int            @default(0)
  indexedAt   DateTime?
  
  // Relations
  chunks_data KnowledgeChunk[]
  
  // Timestamps
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@index([status])
  @@map("knowledge_documents")
}

// ============================================
// Knowledge Chunks (pour pgvector)
// ============================================
model KnowledgeChunk {
  id           String   @id @default(uuid())
  documentId   String
  document     KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  // Content
  content      String
  
  // Vector embedding (3072 dimensions pour text-embedding-3-large)
  // Note: Prisma ne supporte pas nativement le type vector
  // On utilise une migration SQL personnalisée pour créer ce champ
  embedding    Unsupported("vector(3072)")?
  
  // Metadata
  metadata     Json     @default("{}")
  
  // Timestamps
  createdAt    DateTime @default(now())
  
  @@index([documentId])
  // Index pour la recherche vectorielle (créé via migration SQL)
  @@map("knowledge_chunks")
}

// ============================================
// API Keys
// ============================================
model ApiKey {
  id          String    @id @default(uuid())
  name        String
  key         String    @unique
  
  // Permissions
  permissions String[]  @default([])
  
  // Usage tracking
  lastUsedAt  DateTime?
  usageCount  Int       @default(0)
  
  // Status
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  
  // Relations
  createdBy   String
  user        User      @relation(fields: [createdBy], references: [id])
  
  // Timestamps
  createdAt   DateTime  @default(now())
  
  @@index([key])
  @@map("api_keys")
}

// ============================================
// Chat Sessions (RAG)
// ============================================
model ChatSession {
  id          String    @id @default(uuid())
  contactId   String?
  contact     Contact?  @relation(fields: [contactId], references: [id])

  // Messages
  messages    Json[]    @default([])

  // Metadata
  source      String    @default("web") // web, whatsapp, api
  userAgent   String?
  ipAddress   String?

  // === Enrichissement IA bancaire ===
  enriched          Boolean   @default(false)
  intentCategory    String?   // ACCOUNT_INQUIRY, LOAN_REQUEST, CARD_ISSUE, TRANSFER_HELP, COMPLAINT, PRODUCT_INFO, ACCOUNT_OPENING, FEES_CHARGES, MOBILE_BANKING, GENERAL
  productMentioned  String?   // SAVINGS_ACCOUNT, CURRENT_ACCOUNT, CREDIT_CARD, PERSONAL_LOAN, MORTGAGE, INSURANCE, MOBILE_BANKING, VISA_CARD, NONE
  sentiment         String?   // POSITIVE, NEUTRAL, NEGATIVE, FRUSTRATED
  urgencyLevel      String?   // LOW, MEDIUM, HIGH, CRITICAL
  resolutionStatus  String?   // RESOLVED, UNRESOLVED, ESCALATION_NEEDED, FOLLOW_UP_REQUIRED
  satisfactionScore Float?    // 1.0 - 5.0 (AI-estimated)
  customerNeedSummary String? // Resume du besoin reel du client
  actionRequired    Boolean   @default(false)
  actionDescription String?   // Action humaine necessaire
  topicTags         String[]  @default([])
  language          String?   @default("fr")

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([contactId])
  @@index([createdAt])
  @@index([intentCategory])
  @@index([sentiment])
  @@index([urgencyLevel])
  @@index([resolutionStatus])
  @@index([enriched])
  @@map("chat_sessions")
}

// ============================================
// Daily Reports (Rapports quotidiens enrichissement)
// ============================================
model DailyReport {
  id                    String    @id @default(uuid())
  date                  DateTime  @unique

  // Conversation stats
  totalConversations    Int       @default(0)
  whatsappConversations Int       @default(0)
  webConversations      Int       @default(0)

  // Sentiment breakdown
  sentimentPositive     Int       @default(0)
  sentimentNeutral      Int       @default(0)
  sentimentNegative     Int       @default(0)
  sentimentFrustrated   Int       @default(0)

  // Intent & product breakdown (JSON for flexibility)
  intentBreakdown       Json      @default("{}")
  productBreakdown      Json      @default("{}")

  // Resolution stats
  resolvedCount         Int       @default(0)
  unresolvedCount       Int       @default(0)
  escalationCount       Int       @default(0)
  followUpCount         Int       @default(0)

  // Satisfaction
  avgSatisfactionScore  Float?

  // AI-generated insights
  topCustomerNeeds      String[]  @default([])
  keyInsights           String?
  recommendations       String?

  // Metadata
  generatedAt           DateTime  @default(now())

  @@index([date])
  @@map("daily_reports")
}

// ============================================
// Enums
// ============================================

enum Role {
  ADMIN
  MANAGER
  OPERATOR
}

enum CampaignType {
  REACTIVATION
  TUTORIAL
  NOTIFICATION
  FEATURE
  MARKETING
  ALERT
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum TemplateCategory {
  MARKETING
  UTILITY
  AUTHENTICATION
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContactCategory {
  ALL
  ACTIVE
  INACTIVE
  NEW
  PREMIUM
  VIP
}

enum SegmentType {
  STATIC
  DYNAMIC
  BANK_CRITERIA
}

enum ContactStatus {
  ACTIVE
  UNSUBSCRIBED
  BLOCKED
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  TEMPLATE
  LOCATION
  BUTTON
}

enum MessageStatus {
  PENDING
  QUEUED
  SENT
  DELIVERED
  READ
  FAILED
}

enum DocumentStatus {
  PROCESSING
  INDEXED
  FAILED
}
